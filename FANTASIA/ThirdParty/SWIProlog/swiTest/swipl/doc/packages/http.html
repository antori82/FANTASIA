<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01//EN" "http://www.w3.org/TR/html4/strict.dtd">

<html>
<head>
<title>SWI-Prolog HTTP support</title>
<style type="text/css">

/* Style sheet for SWI-Prolog latex2html
*/

dd.defbody
{ margin-bottom: 1em;
}

dt.pubdef, dt.multidef
{ color: #fff;
padding: 2px 10px 0px 10px;
margin-bottom: 5px;
font-size: 18px;
vertical-align: middle;
overflow: hidden;
}

dt.pubdef { background-color: #0c3d6e; }
dt.multidef { background-color: #ef9439; }

.bib dd
{ margin-bottom: 1em;
}

.bib dt
{ float: left;
margin-right: 1.3ex;
}

pre.code
{ margin-left: 1.5em;
margin-right: 1.5em;
border: 1px dotted;
padding-top: 5px;
padding-left: 5px;
padding-bottom: 5px;
background-color: #f8f8f8;
}

div.navigate
{ text-align: center;
background-color: #f0f0f0;
border: 1px dotted;
padding: 5px;
}

div.title
{ text-align: center;
padding-bottom: 1em;
font-size: 200%;
font-weight: bold;
}

div.author
{ text-align: center;
font-style: italic;
}

div.abstract
{ margin-top: 2em;
background-color: #f0f0f0;
border: 1px dotted;
padding: 5px;
margin-left: 10%; margin-right:10%;
}

div.abstract-title
{ text-align: center;
padding: 5px;
font-size: 120%;
font-weight: bold;
}

div.toc-h1
{ font-size: 200%;
font-weight: bold;
}

div.toc-h2
{ font-size: 120%;
font-weight: bold;
margin-left: 2em;
}

div.toc-h3
{ font-size: 100%;
font-weight: bold;
margin-left: 4em;
}

div.toc-h4
{ font-size: 100%;
margin-left: 6em;
}

span.sec-nr
{
}

span.sec-title
{
}

span.pred-ext
{ font-weight: bold;
}

span.pred-tag
{ float: right;
padding-top: 0.2em;
font-size: 80%;
font-style: italic;
color: #fff;
}

div.caption
{ width: 80%;
margin: auto;
text-align:center;
}

/* Footnotes */
.fn {
color: red;
font-size: 70%;
}

.fn-text, .fnp {
position: absolute;
top: auto;
left: 10%;
border: 1px solid #000;
box-shadow: 5px 5px 5px #888;
display: none;
background: #fff;
color: #000;
margin-top: 25px;
padding: 8px 12px;
font-size: larger;
}

sup:hover span.fn-text
{ display: block;
}

/* Lists */

dl.latex
{ margin-top: 1ex;
margin-bottom: 0.5ex;
}

dl.latex dl.latex dd.defbody
{ margin-bottom: 0.5ex;
}

/* PlDoc Tags */

dl.tags
{ font-size: 90%;
margin-left: 5ex;
margin-top: 1ex;
margin-bottom: 0.5ex;
}

dl.tags dt
{ margin-left: 0pt;
font-weight: bold;
}

dl.tags dd
{ margin-left: 3ex;
}

td.param
{ font-style: italic;
font-weight: bold;
}

/* Index */

dt.index-sep
{ font-weight: bold;
font-size: +1;
margin-top: 1ex;
}

/* Tables */

table.center
{ margin: auto;
}

table.latex
{ border-collapse:collapse;
}

table.latex tr
{ vertical-align: text-top;
}

table.latex td,th
{ padding: 2px 1em;
}

table.latex tr.hline td,th
{ border-top: 1px solid black;
}

table.frame-box
{ border: 2px solid black;
}

</style>
</head>
<body style="background:white"> 
<div class="title">SWI-Prolog HTTP support</div>
<div class="author">Jan Wielemaker <br>
VU University Amsterdam <br>
University of Amsterdam <br>
The Netherlands <br>
E-mail: <a class="url" href="mailto:J.Wielemaker@vu.nl">J.Wielemaker@vu.nl</a></div>
<div class="abstract">
<div class="abstract-title">Abstract</div> This article documents the 
package HTTP, a series of libraries for accessing data on HTTP servers 
as well as providing HTTP server capabilities from SWI-Prolog (up to 
HTTP 1.1). Both server and client are modular libraries. Further reading 
material is available from the locations below.
<ul class="compact">
<li><a class="url" href="http://www.swi-prolog.org/howto/http/">HOWTO 
collection</a>
<li><a class="url" href="https://github.com/Anniepoo/swiplwebtut/blob/master/web.adoc">Tutorial 
by Anne Ogborn</a>
<li><a class="url" href="https://en.wikipedia.org/wiki/Hypertext_Transfer_Protocol">Wikipedia 
entry on HTTP</a>
<li><a class="url" href="https://en.wikipedia.org/wiki/Representational_state_transfer">Wikipedia 
entry on REST</a>
</ul>
</div>

<h1><a id="document-contents">Table of Contents</a></h1>

<div class="toc">
<div class="toc-h2"><a class="sec" href="#sec:1"><span class="sec-nr">1</span> <span class="sec-title">Introduction</span></a></div>
<div class="toc-h2"><a class="sec" href="#sec:2"><span class="sec-nr">2</span> <span class="sec-title">The 
HTTP client libraries</span></a></div>
<div class="toc-h3"><a class="sec" href="#sec:2.1"><span class="sec-nr">2.1</span> <span class="sec-title">library(http/http_open): 
HTTP client library</span></a></div>
<div class="toc-h3"><a class="sec" href="#sec:2.2"><span class="sec-nr">2.2</span> <span class="sec-title">library(http/http_client): 
HTTP client library</span></a></div>
<div class="toc-h2"><a class="sec" href="#sec:3"><span class="sec-nr">3</span> <span class="sec-title">The 
HTTP server libraries</span></a></div>
<div class="toc-h3"><a class="sec" href="#sec:3.1"><span class="sec-nr">3.1</span> <span class="sec-title">Creating 
an HTTP reply</span></a></div>
<div class="toc-h4"><a class="sec" href="#sec:3.1.1"><span class="sec-nr">3.1.1</span> <span class="sec-title">Returning 
special status codes</span></a></div>
<div class="toc-h3"><a class="sec" href="#sec:3.2"><span class="sec-nr">3.2</span> <span class="sec-title">library(http/http_dispatch): 
Dispatch requests in the HTTP server</span></a></div>
<div class="toc-h3"><a class="sec" href="#sec:3.3"><span class="sec-nr">3.3</span> <span class="sec-title">library(http/http_dirindex): 
HTTP directory listings</span></a></div>
<div class="toc-h3"><a class="sec" href="#sec:3.4"><span class="sec-nr">3.4</span> <span class="sec-title">library(http/http_files): 
Serve plain files from a hierarchy</span></a></div>
<div class="toc-h3"><a class="sec" href="#sec:3.5"><span class="sec-nr">3.5</span> <span class="sec-title">library(http/http_session): 
HTTP Session management</span></a></div>
<div class="toc-h3"><a class="sec" href="#sec:3.6"><span class="sec-nr">3.6</span> <span class="sec-title">library(http/http_cors): 
Enable CORS: Cross-Origin Resource Sharing</span></a></div>
<div class="toc-h3"><a class="sec" href="#sec:3.7"><span class="sec-nr">3.7</span> <span class="sec-title">library(http/http_authenticate): 
Authenticate HTTP connections using 401 headers</span></a></div>
<div class="toc-h3"><a class="sec" href="#sec:3.8"><span class="sec-nr">3.8</span> <span class="sec-title">library(http/http_digest): 
HTTP Digest authentication</span></a></div>
<div class="toc-h3"><a class="sec" href="#sec:3.9"><span class="sec-nr">3.9</span> <span class="sec-title">library(http/http_dyn_workers): 
Dynamically schedule HTTP workers.</span></a></div>
<div class="toc-h4"><a class="sec" href="#sec:3.9.1"><span class="sec-nr">3.9.1</span> <span class="sec-title">Providing 
Server-Sent Events (sse)</span></a></div>
<div class="toc-h3"><a class="sec" href="#sec:3.10"><span class="sec-nr">3.10</span> <span class="sec-title">Custom 
Error Pages</span></a></div>
<div class="toc-h3"><a class="sec" href="#sec:3.11"><span class="sec-nr">3.11</span> <span class="sec-title">library(http/http_openid): 
OpenID consumer and server library</span></a></div>
<div class="toc-h3"><a class="sec" href="#sec:3.12"><span class="sec-nr">3.12</span> <span class="sec-title">Get 
parameters from HTML forms</span></a></div>
<div class="toc-h3"><a class="sec" href="#sec:3.13"><span class="sec-nr">3.13</span> <span class="sec-title">Request 
format</span></a></div>
<div class="toc-h4"><a class="sec" href="#sec:3.13.1"><span class="sec-nr">3.13.1</span> <span class="sec-title">Handling 
POST requests</span></a></div>
<div class="toc-h3"><a class="sec" href="#sec:3.14"><span class="sec-nr">3.14</span> <span class="sec-title">Running 
the server</span></a></div>
<div class="toc-h4"><a class="sec" href="#sec:3.14.1"><span class="sec-nr">3.14.1</span> <span class="sec-title">Common 
server interface options</span></a></div>
<div class="toc-h4"><a class="sec" href="#sec:3.14.2"><span class="sec-nr">3.14.2</span> <span class="sec-title">Multi-threaded 
Prolog</span></a></div>
<div class="toc-h4"><a class="sec" href="#sec:3.14.3"><span class="sec-nr">3.14.3</span> <span class="sec-title">From 
(Unix) inetd</span></a></div>
<div class="toc-h4"><a class="sec" href="#sec:3.14.4"><span class="sec-nr">3.14.4</span> <span class="sec-title">MS-Windows</span></a></div>
<div class="toc-h4"><a class="sec" href="#sec:3.14.5"><span class="sec-nr">3.14.5</span> <span class="sec-title">As 
CGI script</span></a></div>
<div class="toc-h4"><a class="sec" href="#sec:3.14.6"><span class="sec-nr">3.14.6</span> <span class="sec-title">Using 
a reverse proxy</span></a></div>
<div class="toc-h3"><a class="sec" href="#sec:3.15"><span class="sec-nr">3.15</span> <span class="sec-title">The 
wrapper library</span></a></div>
<div class="toc-h3"><a class="sec" href="#sec:3.16"><span class="sec-nr">3.16</span> <span class="sec-title">library(http/http_host): 
Obtain public server location</span></a></div>
<div class="toc-h3"><a class="sec" href="#sec:3.17"><span class="sec-nr">3.17</span> <span class="sec-title">library(http/http_log): 
HTTP Logging module</span></a></div>
<div class="toc-h3"><a class="sec" href="#sec:3.18"><span class="sec-nr">3.18</span> <span class="sec-title">library(http/http_server_health): 
HTTP Server health statistics</span></a></div>
<div class="toc-h3"><a class="sec" href="#sec:3.19"><span class="sec-nr">3.19</span> <span class="sec-title">Debugging 
HTTP servers</span></a></div>
<div class="toc-h3"><a class="sec" href="#sec:3.20"><span class="sec-nr">3.20</span> <span class="sec-title">library(http/http_header): 
Handling HTTP headers</span></a></div>
<div class="toc-h3"><a class="sec" href="#sec:3.21"><span class="sec-nr">3.21</span> <span class="sec-title">The <code>library(http/html_write)</code> 
library</span></a></div>
<div class="toc-h4"><a class="sec" href="#sec:3.21.1"><span class="sec-nr">3.21.1</span> <span class="sec-title">Emitting 
HTML documents</span></a></div>
<div class="toc-h4"><a class="sec" href="#sec:3.21.2"><span class="sec-nr">3.21.2</span> <span class="sec-title">Repositioning 
HTML for CSS and javascript links</span></a></div>
<div class="toc-h4"><a class="sec" href="#sec:3.21.3"><span class="sec-nr">3.21.3</span> <span class="sec-title">Adding 
rules for html//1</span></a></div>
<div class="toc-h4"><a class="sec" href="#sec:3.21.4"><span class="sec-nr">3.21.4</span> <span class="sec-title">Generating 
layout</span></a></div>
<div class="toc-h4"><a class="sec" href="#sec:3.21.5"><span class="sec-nr">3.21.5</span> <span class="sec-title">Examples 
for using the HTML write library</span></a></div>
<div class="toc-h4"><a class="sec" href="#sec:3.21.6"><span class="sec-nr">3.21.6</span> <span class="sec-title">Remarks 
on the <code>library(http/html_write)</code> library</span></a></div>
<div class="toc-h3"><a class="sec" href="#sec:3.22"><span class="sec-nr">3.22</span> <span class="sec-title">library(http/js_write): 
Utilities for including JavaScript</span></a></div>
<div class="toc-h3"><a class="sec" href="#sec:3.23"><span class="sec-nr">3.23</span> <span class="sec-title">library(http/http_path): 
Abstract specification of HTTP server locations</span></a></div>
<div class="toc-h3"><a class="sec" href="#sec:3.24"><span class="sec-nr">3.24</span> <span class="sec-title">library(http/html_head): 
Automatic inclusion of CSS and scripts links</span></a></div>
<div class="toc-h4"><a class="sec" href="#sec:3.24.1"><span class="sec-nr">3.24.1</span> <span class="sec-title">About 
resource ordering</span></a></div>
<div class="toc-h4"><a class="sec" href="#sec:3.24.2"><span class="sec-nr">3.24.2</span> <span class="sec-title">Debugging 
dependencies</span></a></div>
<div class="toc-h4"><a class="sec" href="#sec:3.24.3"><span class="sec-nr">3.24.3</span> <span class="sec-title">Predicates</span></a></div>
<div class="toc-h3"><a class="sec" href="#sec:3.25"><span class="sec-nr">3.25</span> <span class="sec-title">library(http/http_pwp): 
Serve PWP pages through the HTTP server</span></a></div>
<div class="toc-h3"><a class="sec" href="#sec:3.26"><span class="sec-nr">3.26</span> <span class="sec-title">library(http/htmx): 
Support htmx.org</span></a></div>
<div class="toc-h2"><a class="sec" href="#sec:4"><span class="sec-nr">4</span> <span class="sec-title">HTTP 
and IPv6</span></a></div>
<div class="toc-h2"><a class="sec" href="#sec:5"><span class="sec-nr">5</span> <span class="sec-title">Transfer 
encodings</span></a></div>
<div class="toc-h3"><a class="sec" href="#sec:5.1"><span class="sec-nr">5.1</span> <span class="sec-title">The <code>library(http/http_chunked)</code> 
library</span></a></div>
<div class="toc-h2"><a class="sec" href="#sec:6"><span class="sec-nr">6</span> <span class="sec-title">library(http/websocket): 
WebSocket support</span></a></div>
<div class="toc-h2"><a class="sec" href="#sec:7"><span class="sec-nr">7</span> <span class="sec-title">library(http/hub): 
Manage a hub for websockets</span></a></div>
<div class="toc-h2"><a class="sec" href="#sec:8"><span class="sec-nr">8</span> <span class="sec-title">Supporting 
JSON</span></a></div>
<div class="toc-h3"><a class="sec" href="#sec:8.1"><span class="sec-nr">8.1</span> <span class="sec-title">library(http/json): 
Reading and writing JSON serialization</span></a></div>
<div class="toc-h3"><a class="sec" href="#sec:8.2"><span class="sec-nr">8.2</span> <span class="sec-title">library(http/json_convert): 
Convert between JSON terms and Prolog application terms</span></a></div>
<div class="toc-h3"><a class="sec" href="#sec:8.3"><span class="sec-nr">8.3</span> <span class="sec-title">library(http/http_json): 
HTTP JSON Plugin module</span></a></div>
<div class="toc-h2"><a class="sec" href="#sec:9"><span class="sec-nr">9</span> <span class="sec-title">MIME 
support</span></a></div>
<div class="toc-h3"><a class="sec" href="#sec:9.1"><span class="sec-nr">9.1</span> <span class="sec-title">library(http/mimepack): 
Create a MIME message</span></a></div>
<div class="toc-h2"><a class="sec" href="#sec:10"><span class="sec-nr">10</span> <span class="sec-title">Security</span></a></div>
<div class="toc-h2"><a class="sec" href="#sec:11"><span class="sec-nr">11</span> <span class="sec-title">Tips 
and tricks</span></a></div>
<div class="toc-h2"><a class="sec" href="#sec:12"><span class="sec-nr">12</span> <span class="sec-title">Status</span></a></div>
</div>

<p><h2 id="sec:http-intro"><a id="sec:1"><span class="sec-nr">1</span> <span class="sec-title">Introduction</span></a></h2>

<a id="sec:http-intro"></a>

<p>HTTP (Hypertext Transfer Protocol) is the W3C standard protocol for 
transferring information between a web-client (e.g., a browser) and a 
web-server. The protocol is a simple <em>envelope</em> protocol where 
standard name/value pairs in the header are used to split the stream 
into messages and communicate about the connection-status. Many 
languages have client and server libraries to deal with the HTTP 
protocol, making this protocol an excellent candidate for building 
client-server applications. In particular, HTTP is a natural fit for 
networked systems built according to the principles of &ldquo;Representational 
State Transfer&rdquo; (<em>REST</em>).

<p>In this document we describe a modular infrastructure to access 
web-servers from SWI-Prolog and turn Prolog into a web-server.

<h3>Acknowledgements</h3>

<a id="sec:http-acknowledgements"></a>

<p>This work has been carried out under the following projects:
<a class="url" href="http://hcs.science.uva.nl/projects/GARP/">GARP</a>,
<a class="url" href="http://www.ins.cwi.nl/projects/MIA/">MIA</a> (dead 
link),
<a class="url" href="http://hcs.science.uva.nl/projects/ibrow/home.html">IBROW</a> 
(dead link),
<a class="url" href="http://kits.edte.utwente.nl/">KITS</a> (dead link) 
and
<a class="url" href="http://e-culture.multimedian.nl/">MultiMediaN</a> 
(dead link).

<p>The following people have pioneered parts of this library and 
contributed with bug reports and suggestions for improvements: Anjo 
Anjewierden, Bert Bredeweg, Wouter Jansweijer, Bob Wielinga, Jacco van 
Ossenbruggen, Michiel Hildebrandt, Matt Lilley and Keri Harris.

<p><em>Path wildcards</em> (see <a id="idx:httphandler3:1"></a><a class="pred" href="#http_handler/3">http_handler/3</a>) 
have been modelled after the &ldquo;arouter&rdquo; add-on pack by Raivo 
Laanemets. <em>Request rewriting</em> has been added after discussion 
with Raivo Laanemets and Anne Ogborn on the SWI-Prolog mailinglist.

<p><h2 id="sec:http-clients"><a id="sec:2"><span class="sec-nr">2</span> <span class="sec-title">The 
HTTP client libraries</span></a></h2>

<a id="sec:http-clients"></a>

<p>This package provides two client libraries for accessing HTTP 
servers.

<dl class="latex">
<dt><b><code>library(http/http_open)</code></b></dt>
<dd class="defbody">
This library provides <a id="idx:httpopen3:2"></a><a class="pred" href="#http_open/3">http_open/3</a> 
and friends. It is a library for opening an endpoint identified by an 
HTTP URL as a Prolog stream. The general skeleton for using this library 
is given below, where process/1 processes the data from the HTTP server.<sup class="fn">1<span class="fn-text">One 
may opt to use <a id="idx:cleanup2:3"></a><span class="pred-ext">cleanup/2</span> 
intead of <a id="idx:setupcallcleanup3:4"></a><span class="pred-ext">setup_call_cleanup/3</span> 
to allow for aborting while <a id="idx:httpopen3:5"></a><a class="pred" href="#http_open/3">http_open/3</a> 
is waiting for the connection.</span></sup>

<pre class="code">
    setup_call_cleanup(
        http_open(URL, In, []),
        process(In),
        close(In)).
</pre>

</dd>
<dt><b><code>library(http/http_client)</code></b></dt>
<dd class="defbody">
This library provides <a id="idx:httpget3:6"></a><a class="pred" href="#http_get/3">http_get/3</a> 
and <a id="idx:httppost4:7"></a><a class="pred" href="#http_post/4">http_post/4</a> 
and friends. These predicates process the reply using plugins to convert 
the data based on the <code>Content-Type</code> of the reply. This 
library supports a plugin infrastructure that can register hooks for 
converting additional document types.
</dd>
</dl>

<p><h3 id="sec:httpopen"><a id="sec:2.1"><span class="sec-nr">2.1</span> <span class="sec-title">library(http/http_open): 
HTTP client library</span></a></h3>

<p><a id="sec:httpopen"></a>

<dl class="tags">
<dt class="mtag">See also</dt>
<dd>
- <span class="pred-ext">load_html/3</span> and <span class="pred-ext">xpath/3</span> 
can be used to parse and navigate HTML documents. <br>
- <a class="pred" href="#http_get/3">http_get/3</a> and <a class="pred" href="#http_post/4">http_post/4</a> 
provide an alternative interface that convert the reply depending on the <code>Content-Type</code> 
header.
</dd>
</dl>

<p>This library defines <a class="pred" href="#http_open/3">http_open/3</a>, 
which opens an URL as a Prolog stream. The functionality of the library 
can be extended by loading two additional modules that act as plugins:

<dl class="latex">
<dt><strong>library</strong>(<var>http/http_ssl_plugin</var>)</dt>
<dd class="defbody">
Loading this library causes <a class="pred" href="#http_open/3">http_open/3</a> 
to handle HTTPS connections. Relevant options for SSL certificate 
handling are handed to
<span class="pred-ext">ssl_context/3</span>. This plugin is loaded 
automatically if the scheme
<code>https</code> is requested using a default SSL context. See the 
plugin for additional information regarding security.
</dd>
<dt><strong>library</strong>(<var>zlib</var>)</dt>
<dd class="defbody">
Loading this library supports the <code>gzip</code> transfer encoding. 
This plugin is lazily loaded if a connection is opened that claims this 
transfer encoding.
</dd>
<dt><strong>library</strong>(<var>http/http_cookie</var>)</dt>
<dd class="defbody">
Loading this library adds tracking cookies to <a class="pred" href="#http_open/3">http_open/3</a>. 
Returned cookies are collected in the Prolog database and supplied for 
subsequent requests.
</dd>
<dt><strong>library</strong>(<var>http/http_stream</var>)</dt>
<dd class="defbody">
This library adds support for <i>chunked</i> encoding. It is lazily 
loaded if the server sends a <code>Transfer-encoding: chunked</code> 
header.
</dd>
</dl>

<p>Here is a simple example to fetch a web-page:

<pre class="code">
?- http_open('http://www.google.com/search?q=prolog', In, []),
   copy_stream_data(In, user_output),
   close(In).
&lt;!doctype html&gt;&lt;head&gt;&lt;title&gt;prolog - Google Search&lt;/title&gt;&lt;script&gt;
...
</pre>

<p>The example below fetches the modification time of a web-page. Note 
that
<code>Modified</code> is <code>''</code> (the empty atom) if the 
web-server does not provide a time-stamp for the resource. See also <span class="pred-ext">parse_time/2</span>.

<pre class="code">
modified(URL, Stamp) :-
       http_open(URL, In,
                 [ method(head),
                   header(last_modified, Modified)
                 ]),
       close(In),
       Modified \== '',
       parse_time(Modified, Stamp).
</pre>

<p>Then next example uses Google search. It exploits <code>library(uri)</code> 
to manage URIs, <code>library(sgml)</code> to load an HTML document and <code>library(xpath)</code> 
to navigate the parsed HTML. Note that you may need to adjust the XPath 
queries if the data returned by Google changes (this example indeed no 
longer works and currently fails at the first <span class="pred-ext">xpath/3</span> 
call)

<pre class="code">
:- use_module(library(http/http_open)).
:- use_module(library(xpath)).
:- use_module(library(sgml)).
:- use_module(library(uri)).

google(For, Title, HREF) :-
        uri_encoded(query_value, For, Encoded),
        atom_concat('http://www.google.com/search?q=', Encoded, URL),
        http_open(URL, In, []),
        call_cleanup(
            load_html(In, DOM, []),
            close(In)),
        xpath(DOM, //h3(@class=r), Result),
        xpath(Result, //a(@href=HREF0, text), Title),
        uri_components(HREF0, Components),
        uri_data(search, Components, Query),
        uri_query_components(Query, Parts),
        memberchk(q=HREF, Parts).
</pre>

<p>An example query is below:

<pre class="code">
?- google(prolog, Title, HREF).
Title = 'SWI-Prolog',
HREF = 'http://www.swi-prolog.org/' ;
Title = 'Prolog - Wikipedia',
HREF = 'https://nl.wikipedia.org/wiki/Prolog' ;
Title = 'Prolog - Wikipedia, the free encyclopedia',
HREF = 'https://en.wikipedia.org/wiki/Prolog' ;
Title = 'Pro-Log is logistiek dienstverlener m.b.t. vervoer over water.',
HREF = 'http://www.pro-log.nl/' ;
Title = 'Learn Prolog Now!',
HREF = 'http://www.learnprolognow.org/' ;
Title = 'Free Online Version - Learn Prolog
...
</pre>

<dl class="latex">
<dt class="pubdef"><span class="pred-tag">[det]</span><a id="http_open/3"><strong>http_open</strong>(<var>+URL, 
-Stream, +Options</var>)</a></dt>
<dd class="defbody">
Open the data at the HTTP server as a Prolog stream. <var>URL</var> is 
either an atom specifying a <var>URL</var> or a list representing a 
broken-down <var>URL</var> as specified below. After this predicate 
succeeds the data can be read from <var>Stream</var>. After completion 
this stream must be closed using the built-in Prolog predicate
<span class="pred-ext">close/1</span>. <var>Options</var> provides 
additional options:

<dl class="latex">
<dt><strong>authenticate</strong>(<var>+Boolean</var>)</dt>
<dd class="defbody">
If <code>false</code> (default <code>true</code>), do <i>not</i> try to 
automatically authenticate the client if a 401 (Unauthorized) status 
code is received.
</dd>
<dt><strong>authorization</strong>(<var>+Term</var>)</dt>
<dd class="defbody">
Send authorization. See also <a class="pred" href="#http_set_authorization/2">http_set_authorization/2</a>. 
Supported schemes:

<dl class="latex">
<dt><strong>basic</strong>(<var>+User, +Password</var>)</dt>
<dd class="defbody">
HTTP Basic authentication.
</dd>
<dt><strong>bearer</strong>(<var>+Token</var>)</dt>
<dd class="defbody">
HTTP Bearer authentication.
</dd>
<dt><strong>digest</strong>(<var>+User, +Password</var>)</dt>
<dd class="defbody">
HTTP Digest authentication. This option is only provided if the plugin <code>library(http/http_digest)</code> 
is also loaded.
</dd>
</dl>

</dd>
<dt><strong>unix_socket</strong>(<var>+Path</var>)</dt>
<dd class="defbody">
Connect to the given Unix domain socket. In this scenario the host name 
and port or ignored. If the server replies with a <i>redirect</i> 
message and the host differs from the original host as normal TCP 
connection is used to handle the redirect. This option is inspired by <code>curl(1)</code>&rsquo;s 
option&lsquo;--unix-socket`.
</dd>
<dt><strong>connection</strong>(<var>+Connection</var>)</dt>
<dd class="defbody">
Specify the <code>Connection</code> header. Default is <code>close</code>. 
The alternative is <code>Keep-alive</code>. This maintains a pool of 
available connections as determined by <span class="pred-ext">keep_connection/1</span>. 
The <code>library(http/websockets)</code> uses <code>Keep-alive, Upgrade</code>. 
Keep-alive connections can be closed explicitly using
<a class="pred" href="#http_close_keep_alive/1">http_close_keep_alive/1</a>. 
Keep-alive connections may significantly improve repetitive requests on 
the same server, especially if the IP route is long, HTTPS is used or 
the connection uses a proxy.
</dd>
<dt><strong>final_url</strong>(<var>-FinalURL</var>)</dt>
<dd class="defbody">
Unify <var>FinalURL</var> with the final destination. This differs from 
the original <var>URL</var> if the returned head of the original 
indicates an HTTP redirect (codes 301, 302 or 303). Without a redirect, <var>FinalURL</var> 
is the same as <var>URL</var> if <var>URL</var> is an atom, or a
<var>URL</var> constructed from the parts.
</dd>
<dt><strong>header</strong>(<var>Name, -AtomValue</var>)</dt>
<dd class="defbody">
If provided, <var>AtomValue</var> is unified with the value of the 
indicated field in the reply header. <var>Name</var> is matched 
case-insensitive and the underscore (_) matches the hyphen (-). Multiple 
of these options may be provided to extract multiple header fields. If 
the header is not available
<var>AtomValue</var> is unified to the empty atom (&rdquo; ).
</dd>
<dt><strong>headers</strong>(<var>-List</var>)</dt>
<dd class="defbody">
If provided, <var>List</var> is unified with a list of Name(Value) pairs 
corresponding to fields in the reply header. Name and Value follow the 
same conventions used by the <code>header(Name,Value)</code> option. A 
pseudo header <code>status_code(Code)</code> is added to provide the 
HTTP status as an integer. See also <code>raw_headers(-List)</code> 
which provides the entire HTTP reply header in unparsed representation.
</dd>
<dt><strong>method</strong>(<var>+Method</var>)</dt>
<dd class="defbody">
One of <code>get</code> (default), <code>head</code>, <code>delete</code>, <code>post</code>, <code>put</code> 
or
<code>patch</code>. The <code>head</code> message can be used in 
combination with the <code>header(Name, Value)</code> option to access 
information on the resource without actually fetching the resource 
itself. The returned stream must be closed immediately.

<p>If <code>post(Data)</code> is provided, the default is <code>post</code>.
</dd>
<dt><strong>size</strong>(<var>-Size</var>)</dt>
<dd class="defbody">
<var>Size</var> is unified with the integer value of <code>Content-Length</code> 
in the reply header.
</dd>
<dt><strong>version</strong>(<var>-Version</var>)</dt>
<dd class="defbody">
<var>Version</var> is a <i>pair</i> <code>Major-Minor</code>, where <var>Major</var> 
and <var>Minor</var> are integers representing the HTTP version in the 
reply header.
</dd>
<dt><strong>range</strong>(<var>+Range</var>)</dt>
<dd class="defbody">
Ask for partial content. <var>Range</var> is a term <i>Unit(From,To)</i>, 
where <var>From</var> is an integer and <var>To</var> is either an 
integer or the atom <code>end</code>. HTTP 1.1 only supports Unit = <code>bytes</code>. 
E.g., to ask for bytes 1000-1999, use the option
<code>range(bytes(1000,1999))</code>
</dd>
<dt><strong>raw_encoding</strong>(<var>+Encoding</var>)</dt>
<dd class="defbody">
Do not install a decoding filter for <var>Encoding</var>. For example, 
using <code>raw_encoding('applocation/gzip')</code> the system will not 
decompress the stream if it is compressed using <code>gzip</code>.
</dd>
<dt><strong>raw_headers</strong>(<var>-Lines</var>)</dt>
<dd class="defbody">
Unify <var>Lines</var> with a list of strings that represents the 
complete reply header returned by the server. See also <code>headers(-List)</code>.
</dd>
<dt><strong>redirect</strong>(<var>+Boolean</var>)</dt>
<dd class="defbody">
If <code>false</code> (default <code>true</code>), do <i>not</i> 
automatically redirect if a 3XX code is received. Must be combined with
<code>status_code(Code)</code> and one of the header options to read the 
redirect reply. In particular, without <code>status_code(Code)</code> a 
redirect is mapped to an exception.
</dd>
<dt><strong>status_code</strong>(<var>-Code</var>)</dt>
<dd class="defbody">
If this option is present and <var>Code</var> unifies with the HTTP 
status code, do <b>not</b> translate errors (4xx, 5xx) into an 
exception. Instead, <a class="pred" href="#http_open/3">http_open/3</a> 
behaves as if 2xx (success) is returned, providing the application to 
read the error document from the returned stream.
</dd>
<dt><strong>output</strong>(<var>-Out</var>)</dt>
<dd class="defbody">
Unify the output stream with <var>Out</var> and do not close it. This 
can be used to upgrade a connection.
</dd>
<dt><strong>timeout</strong>(<var>+Timeout</var>)</dt>
<dd class="defbody">
If provided, set a timeout on the stream using <span class="pred-ext">set_stream/2</span>. 
With this option if no new data arrives within <var>Timeout</var> 
seconds the stream raises an exception. Default is to wait forever (<code>infinite</code>).
</dd>
<dt><strong>post</strong>(<var>+Data</var>)</dt>
<dd class="defbody">
Issue a <code>POST</code> request on the HTTP server. <var>Data</var> is 
handed to <a class="pred" href="#http_post_data/3">http_post_data/3</a>.
</dd>
<dt><strong>proxy</strong>(<var>+Host:Port</var>)</dt>
<dd class="defbody">
Use an HTTP proxy to connect to the outside world. See also
<span class="pred-ext">socket:proxy_for_url/3</span>. This option 
overrules the proxy specification defined by <span class="pred-ext">socket:proxy_for_url/3</span>.
</dd>
<dt><strong>proxy</strong>(<var>+Host, +Port</var>)</dt>
<dd class="defbody">
Synonym for <code>proxy(+Host:Port)</code>. Deprecated.
</dd>
<dt><strong>proxy_authorization</strong>(<var>+Authorization</var>)</dt>
<dd class="defbody">
Send authorization to the proxy. Otherwise the same as the
<code>authorization</code> option.
</dd>
<dt><strong>bypass_proxy</strong>(<var>+Boolean</var>)</dt>
<dd class="defbody">
If <code>true</code>, bypass proxy hooks. Default is <code>false</code>.
</dd>
<dt><strong>request_header</strong>(<var>Name=Value</var>)</dt>
<dd class="defbody">
Additional name-value parts are added in the order of appearance to the 
HTTP request header. No interpretation is done.
</dd>
<dt><strong>max_redirect</strong>(<var>+Max</var>)</dt>
<dd class="defbody">
Sets the maximum length of a redirection chain. This is needed for some 
IRIs that redirect indefinitely to other IRIs without looping (e.g., 
redirecting to IRIs with a random element in them).
<var>Max</var> must be either a non-negative integer or the atom <code>infinite</code>. 
The default value is <code>10</code>.
</dd>
<dt><strong>user_agent</strong>(<var>+Agent</var>)</dt>
<dd class="defbody">
Defines the value of the <code>User-Agent</code> field of the HTTP 
header. Default is <code>SWI-Prolog</code>.
</dd>
</dl>

<p>The hook <a class="pred" href="#http:open_options/2">http:open_options/2</a> 
can be used to provide default options based on the broken-down <var>URL</var>. 
The option
<code>status_code(-Code)</code> is particularly useful to query <b>REST</b> 
interfaces that commonly return status codes other than <code>200</code> 
that need to be be processed by the client code.
<table class="arglist">
<tr><td><var>URL</var> </td><td>is either an atom or string (url) or a 
list of <i>parts</i>.

<p>When provided, this list may contain the fields
<code>scheme</code>, <code>user</code>, <code>password</code>, <code>host</code>, <code>port</code>, <code>path</code> 
and either <code>query_string</code> (whose argument is an atom) or <code>search</code> 
(whose argument is a list of
<code>Name(Value)</code> or <code>Name=Value</code> compound terms). 
Only <code>host</code> is mandatory. The example below opens the
<var>URL</var> <code>http://www.example.com/my/path?q=Hello%20World&amp;lang=en</code>. 
Note that values must <b>not</b> be quoted because the library inserts 
the required quotes.

<pre class="code">
http_open([ host('www.example.com'),
            path('/my/path'),
            search([ q='Hello world',
                     lang=en
                   ])
          ])
</pre>

<p></td></tr>
</table>

<dl class="tags">
<dt class="tag">throws</dt>
<dd>
<code>error(existence_error(url, Id),Context)</code> is raised if the 
HTTP result code is not in the range 200..299. Context has the shape <code>context(Message, status(Code, TextCode))</code>, 
where <var>Code</var> is the numeric HTTP code and <var>TextCode</var> 
is the textual description thereof provided by the server. <var>Message</var> 
may provide additional details or may be unbound.
</dd>
<dt class="tag">See also</dt>
<dd>
<span class="pred-ext">ssl_context/3</span> for SSL related options if
<code>library(http/http_ssl_plugin)</code> is loaded.
</dd>
</dl>

</dd>
<dt class="multidef"><span class="pred-tag">[multifile]</span><a id="map_method/2"><strong>map_method</strong>(<var>+MethodID, 
-Method</var>)</a></dt>
<dd class="defbody">
Support additional <code>METHOD</code> keywords. Default are the 
official HTTP methods as defined by the various RFCs.</dd>
<dt class="multidef"><span class="pred-tag">[semidet,multifile]</span><a id="http:disable_encoding_filter/1"><span class="module">http</span>:<strong>disable_encoding_filter</strong>(<var>+ContentType</var>)</a></dt>
<dd class="defbody">
Do not use the <code>Content-encoding</code> as <code>Transfer-encoding</code> 
encoding for specific values of <var>ContentType</var>. This predicate 
is multifile and can thus be extended by the user.</dd>
<dt class="pubdef"><span class="pred-tag">[det]</span><a id="http_set_authorization/2"><strong>http_set_authorization</strong>(<var>+URL, 
+Authorization</var>)</a></dt>
<dd class="defbody">
Set user/password to supply with URLs that have <var>URL</var> as 
prefix. If <var>Authorization</var> is the atom <code>-</code>, possibly 
defined authorization is cleared. For example:

<pre class="code">
?- http_set_authorization('http://www.example.com/private/',
                          basic('John', 'Secret'))
</pre>

<dl class="tags">
<dt class="tag">To be done</dt>
<dd>
Move to a separate module, so <a class="pred" href="#http_get/3">http_get/3</a>, 
etc. can use this too.
</dd>
</dl>

</dd>
<dt class="multidef"><span class="pred-tag">[semidet,multifile]</span><a id="iostream:open_hook/6"><span class="module">iostream</span>:<strong>open_hook</strong>(<var>+Spec, 
+Mode, -Stream, -Close, +Options0, -Options</var>)</a></dt>
<dd class="defbody">
Hook implementation that makes <span class="pred-ext">open_any/5</span> 
support <code>http</code> and
<code>https</code> URLs for <code>Mode == read</code>.</dd>
<dt class="pubdef"><span class="pred-tag">[det]</span><a id="keep_alive/4"><strong>keep_alive</strong>(<var>+StreamPair, 
+Host, +In, -Left</var>)</a></dt>
<dd class="defbody">
Callback when closing the range stream used to process the content of 
the reply. This callback makes the stream available for future 
keep-alive connections or closes the stream. The stream is closed if

<p>
<ul class="latex">
<li>There are too many bytes left unprocessed in the range stream.
<li>There are too many pooled connections.
</ul>
</dd>
<dt class="pubdef"><span class="pred-tag">[det]</span><a id="http_close_keep_alive/1"><strong>http_close_keep_alive</strong>(<var>+Address</var>)</a></dt>
<dd class="defbody">
Close all keep-alive connections matching <var>Address</var>. <var>Address</var> 
is of the form Host:Port. In particular, <code>http_close_keep_alive(_)</code> 
closes all currently known keep-alive connections.</dd>
<dt class="multidef"><span class="pred-tag">[nondet,multifile]</span><a id="http:open_options/2"><span class="module">http</span>:<strong>open_options</strong>(<var>+Parts, 
-Options</var>)</a></dt>
<dd class="defbody">
This hook is used by the HTTP client library to define default options 
based on the the broken-down request-URL. The following example 
redirects all trafic, except for localhost over a proxy:

<pre class="code">
:- multifile
    http:open_options/2.

http:open_options(Parts, Options) :-
    option(host(Host), Parts),
    Host \== localhost,
    Options = [proxy('proxy.local', 3128)].
</pre>

<p>This hook may return multiple solutions. The returned options are 
combined using <span class="pred-ext">merge_options/3</span> where 
earlier solutions overrule later solutions.</dd>
<dt class="multidef"><span class="pred-tag">[semidet,multifile]</span><a id="http:write_cookies/3"><span class="module">http</span>:<strong>write_cookies</strong>(<var>+Out, 
+Parts, +Options</var>)</a></dt>
<dd class="defbody">
Emit a <code>Cookie:</code> header for the current connection. <var>Out</var> 
is an open stream to the HTTP server, <var>Parts</var> is the 
broken-down request (see <span class="pred-ext">uri_components/2</span>) 
and <var>Options</var> is the list of options passed to http_open. The 
predicate is called as if using <span class="pred-ext">ignore/1</span>.

<dl class="tags">
<dt class="mtag">See also</dt>
<dd>
- complements <a class="pred" href="#http:update_cookies/3">http:update_cookies/3</a>. <br>
- <code>library(http/http_cookie)</code> implements cookie handling on 
top of these hooks.
</dd>
</dl>

</dd>
<dt class="multidef"><span class="pred-tag">[semidet,multifile]</span><a id="http:update_cookies/3"><span class="module">http</span>:<strong>update_cookies</strong>(<var>+CookieData, 
+Parts, +Options</var>)</a></dt>
<dd class="defbody">
Update the cookie database. <var>CookieData</var> is the value of the
<code>Set-Cookie</code> field, <var>Parts</var> is the broken-down 
request (see
<span class="pred-ext">uri_components/2</span>) and <var>Options</var> 
is the list of options passed to http_open.

<dl class="tags">
<dt class="mtag">See also</dt>
<dd>
- complements http:write_cookies <br>
- <code>library(http/http_cookies)</code> implements cookie handling on 
top of these hooks.
</dd>
</dl>

</dd>
</dl>

<p><h3 id="sec:httpclient"><a id="sec:2.2"><span class="sec-nr">2.2</span> <span class="sec-title">library(http/http_client): 
HTTP client library</span></a></h3>

<p><a id="sec:httpclient"></a>

<p>This library provides the four basic HTTP client actions: <code>GET</code>,
<code>DELETE</code>, <code>POST</code> and <code>PUT</code>. In 
addition, it provides <a class="pred" href="#http_read_data/3">http_read_data/3</a>, 
which is used by <code>library(http/http_parameters)</code> to decode <code>POST</code> 
data in server applications.

<p>This library is based on <a class="pred" href="#http_open/3">http_open/3</a>, 
which opens a URL as a Prolog stream. The reply is processed by <a class="pred" href="#http_read_data/3">http_read_data/3</a>. 
The following content-types are supported. Options passed to <a class="pred" href="#http_get/3">http_get/3</a> 
and friends are passed to <a class="pred" href="#http_read_data/3">http_read_data/3</a>, 
which in turn passes them to the conversion predicates. Support for 
additional content types can be added by extending the multifile 
predicate <a class="pred" href="#http_client:http_convert_data/4">http_client:http_convert_data/4</a>.

<dl class="latex">
<dt><strong>application/x-www-form-urlencoded</strong></dt>
<dd class="defbody">
Built in. Converts form-data into a list of <code>Name=Value</code> 
terms.
</dd>
<dt><strong>application/x-prolog</strong></dt>
<dd class="defbody">
Built in. Reads a single Prolog term.
</dd>
<dt><strong>multipart/form-data</strong></dt>
<dd class="defbody">
Processed if <code>library(http/http_multipart_plugin)</code> is loaded. 
This format should be used to handle web forms that upload a file.
</dd>
<dt><var><code>text/html</code></var> <strong><code>|</code></strong> <var><code>text/xml</code></var></dt>
<dd class="defbody">
Processed if <code>library(http/http_sgml_plugin)</code> is loaded. See <span class="pred-ext">load_html/3</span> 
for details and <span class="pred-ext">load_xml/3</span> for details. 
The output is often processed using <span class="pred-ext">xpath/3</span>.
</dd>
<dt><var><code>application/json</code></var> <strong><code>|</code></strong> <var><code>application/jsonrequest</code></var></dt>
<dd class="defbody">
Processed if <code>library(http/http_json)</code> is loaded. The option
<code>json_object(As)</code> can be used to return a term <code>json(Attributes)</code> 
(<var>As</var> is <code>term</code>) or a dict (<var>As</var> is <code>dict</code>).
</dd>
</dl>

<dl class="latex">
<dt class="pubdef"><span class="pred-tag">[det]</span><a id="http_get/3"><strong>http_get</strong>(<var>+URL, 
-Data, +Options</var>)</a></dt>
<dd class="defbody">
Get data from a <var>URL</var> server and convert it to a suitable 
Prolog representation based on the <code>Content-Type</code> header and 
plugins. This predicate is the common implementation of the HTTP client 
operations. The predicates <a class="pred" href="#http_delete/3">http_delete/3</a>, <a class="pred" href="#http_post/4">http_post/4</a> 
and
<a class="pred" href="#http_put/4">http_put/4</a> call this predicate 
with an appropriate
<code>method(+Method)</code> option and ---for <a class="pred" href="#http_post/4">http_post/4</a> 
and <a class="pred" href="#http_put/4">http_put/4</a>--- a <code>post(+Data)</code> 
option.

<p><var>Options</var> are passed to <a class="pred" href="#http_open/3">http_open/3</a> 
and <a class="pred" href="#http_read_data/3">http_read_data/3</a>. Other 
options:

<dl class="latex">
<dt><strong>reply_header</strong>(<var>-Fields</var>)</dt>
<dd class="defbody">
Synonym for <code>headers(Fields)</code> from <a class="pred" href="#http_open/3">http_open/3</a>. 
Provided for backward compatibility. Note that <code>http_version(Major-Minor)</code> 
is missing in the new version.
</dd>
</dl>

</dd>
<dt class="pubdef"><span class="pred-tag">[det]</span><a id="http_delete/3"><strong>http_delete</strong>(<var>+URL, 
-Data, +Options</var>)</a></dt>
<dd class="defbody">
Execute a <code>DELETE</code> method on the server. Arguments are the 
same as for <a class="pred" href="#http_get/3">http_get/3</a>. Typically 
one should pass the option
<code>status_code(-Code)</code> to assess and evaluate the returned 
status code. Without, codes other than 200 are interpreted as an error.

<dl class="tags">
<dt class="tag">See also</dt>
<dd>
Implemented on top of <a class="pred" href="#http_get/3">http_get/3</a>.
</dd>
<dt class="tag">To be done</dt>
<dd>
Properly map the 201, 202 and 204 replies.
</dd>
</dl>

</dd>
<dt class="pubdef"><span class="pred-tag">[det]</span><a id="http_post/4"><strong>http_post</strong>(<var>+URL, 
+Data, -Reply, +Options</var>)</a></dt>
<dd class="defbody">
Issue an HTTP <code>POST</code> request. <var>Data</var> is posted using
<a class="pred" href="#http_post_data/3">http_post_data/3</a>. The HTTP 
server reply is returned in <var>Reply</var>, using the same rules as 
for <a class="pred" href="#http_get/3">http_get/3</a>.

<dl class="tags">
<dt class="tag">See also</dt>
<dd>
Implemented on top of <a class="pred" href="#http_get/3">http_get/3</a>.
</dd>
</dl>

</dd>
<dt class="pubdef"><a id="http_put/4"><strong>http_put</strong>(<var>+URL, 
+Data, -Reply, +Options</var>)</a></dt>
<dd class="defbody">
Issue an HTTP <code>PUT</code> request. Arguments are the same as for
<a class="pred" href="#http_post/4">http_post/4</a>.

<dl class="tags">
<dt class="tag">See also</dt>
<dd>
Implemented on top of <a class="pred" href="#http_post/4">http_post/4</a>.
</dd>
</dl>

</dd>
<dt class="pubdef"><a id="http_patch/4"><strong>http_patch</strong>(<var>+URL, 
+Data, -Reply, +Options</var>)</a></dt>
<dd class="defbody">
Issue an HTTP <code>PATCH</code> request. Arguments are the same as for
<a class="pred" href="#http_post/4">http_post/4</a>.

<dl class="tags">
<dt class="tag">See also</dt>
<dd>
Implemented on top of <a class="pred" href="#http_post/4">http_post/4</a>.
</dd>
</dl>

</dd>
<dt class="pubdef"><span class="pred-tag">[det]</span><a id="http_read_data/3"><strong>http_read_data</strong>(<var>+Request, 
-Data, +Options</var>)</a></dt>
<dd class="defbody">
Read data from an HTTP connection and convert it according to the 
supplied <code>to(Format)</code> option or based on the <code>Content-type</code> 
in the <var>Request</var>. The following options are supported:

<dl class="latex">
<dt><strong>to</strong>(<var>Format</var>)</dt>
<dd class="defbody">
Convert data into <var>Format</var>. Values are:

<p>
<ul class="compact">
<li><code>stream(+WriteStream)</code>) Append the content of the message 
to Stream
<li>atom Return the reply as an atom
<li>string Return the reply as a string
<li>codes Return the reply as a list of codes
</ul>
</dd>
<dt><strong>form_data</strong>(<var>AsForm</var>)</dt>
<dt><strong>input_encoding</strong>(<var>+Encoding</var>)</dt>
<dt><strong>on_filename</strong>(<var>:CallBack</var>)</dt>
<dd class="defbody">
These options are implemented by the plugin
<code>library(http/http_multipart_plugin)</code> and apply to processing
<code>multipart/form-data</code> content.
</dd>
<dt><strong>content_type</strong>(<var>+Type</var>)</dt>
<dd class="defbody">
Overrule the content-type that is part of <var>Request</var> as a 
work-around for wrongly configured servers.
</dd>
</dl>

<p>Without plugins, this predicate handles

<dl class="latex">
<dt><strong>application/x-www-form-urlencoded</strong></dt>
<dd class="defbody">
Converts form-data into a list of <code>Name=Value</code> terms.
</dd>
<dt><strong>application/x-prolog</strong></dt>
<dd class="defbody">
Converts data into a Prolog term.
</dd>
</dl>

<table class="arglist">
<tr><td><var>Request</var> </td><td>is a parsed HTTP request as returned 
by
<a class="pred" href="#http_read_request/2">http_read_request/2</a> or 
available from the HTTP server's request dispatcher. <var>Request</var> 
must contain a term <code>input(In)</code> that provides the input 
stream from the HTTP server. </td></tr>
</table>
</dd>
<dt class="multidef"><span class="pred-tag">[semidet,multifile]</span><a id="http_convert_data/4"><strong>http_convert_data</strong>(<var>+In, 
+Fields, -Data, +Options</var>)</a></dt>
<dd class="defbody">
Multi-file hook to convert a HTTP payload according to the
<i>Content-Type</i> header. The default implementation deals with 
application/x-prolog. The HTTP framework provides implementations for 
JSON (<code>library(http/http_json)</code>), HTML/XML (<code>library(http/http_sgml_plugin)</code>)</dd>
<dt class="pubdef"><span class="pred-tag">[det]</span><a id="http_disconnect/1"><strong>http_disconnect</strong>(<var>+Connections</var>)</a></dt>
<dd class="defbody">
Close down some connections. Currently <var>Connections</var> must have 
the value <code>all</code>, closing all connections.

<dl class="tags">
<dt class="tag">deprecated</dt>
<dd>
New code should use <a class="pred" href="#http_close_keep_alive/1">http_close_keep_alive/1</a> 
from
<code>library(http/http_open)</code>.
</dd>
</dl>

</dd>
<dt class="multidef"><span class="pred-tag">[semidet,multifile]</span><a id="http:post_data_hook/3"><span class="module">http</span>:<strong>post_data_hook</strong>(<var>+Term, 
+Out, +Options</var>)</a></dt>
<dd class="defbody">
Hook to extend the datatypes supported by the <code>post(Data)</code> 
option of <a class="pred" href="#http_open/3">http_open/3</a>. The 
default implementation supports
<code>prolog(Term)</code>, sending a Prolog term as <code>application/x-prolog</code>.
</dd>
</dl>

<p><h2 id="sec:httpserver"><a id="sec:3"><span class="sec-nr">3</span> <span class="sec-title">The 
HTTP server libraries</span></a></h2>

<a id="sec:httpserver"></a>

<p>The HTTP server infra structure consists of a number of small modular 
libraries that are combined into <code>library(http/http_server)</code>. 
These modules are:

<dl class="latex">
<dt><b><code>library(http/thread_httpd)</code></b></dt>
<dd class="defbody">
This library is responsible for accepting and managing connections.<sup class="fn">2<span class="fn-text">In 
older versions there were two alternative libraries for managing 
connections based on XPCE and Unix inetd.</span></sup></dd>
<dt><b><code>library(http/http_dyn_workers)</code></b></dt>
<dd class="defbody">
This library dynamically adds and removes workers based on the workload 
of the server.</dd>
<dt><b><code>library(http/http_wrapper)</code></b></dt>
<dd class="defbody">
This library takes a connection, parses the HTTP request header and runs 
a goal that produces a CGI document based on the parsed request. It 
watches for exceptions and turns these into (error) status pages. The 
status page generation may be hooked to provide custom pages.</dd>
<dt><b><code>library(http/http_dispatch)</code></b></dt>
<dd class="defbody">
This library associates the <em>path</em> of the HTTP request with a
<em>handler</em> that services this particular path. It also manages 
timeouts and may pass the execution of a request to a dedicated thread 
with specified resource limits using <a id="idx:httpspawn2:8"></a><a class="pred" href="#http_spawn/2">http_spawn/2</a>. 
The module supports plugable request rewrite handlers that may be used 
to implement identification, authorization, input argument processing, 
etc.</dd>
<dt><b><code>library(http/http_parameters)</code></b></dt>
<dd class="defbody">
This library parses HTTP request parameters, both dealing with GET and 
POST style parameter passing.</dd>
<dt><b><code>library(http/html_write)</code></b></dt>
<dd class="defbody">
This library translates a Prolog term into an HTML document using Prolog
<em>grammar rules</em> (DCG). It provides a modular infrastructure to 
build pages that are guaranteed to be valid HTML. The HTTP server 
libraries provide several alternatives for generating HTML ranging from 
simple printing to <code>current_output</code> to XML-based templates 
(PWP).</dd>
<dt><b><code>library(http/http_json)</code></b></dt>
<dd class="defbody">
This library parses a POSTed HTTP document into a Prolog dict and 
formulates an HTTP JSON reply from a Prolog dict and is typically used 
to implement REST services.
</dd>
</dl>

<p>Most server implementation simply load the <code>library(http/http_server)</code> 
library, which loads the above modules and reexports all predicates 
except for those used for internal communication and older deprecated 
predicates. Specific use cases may load a subset of the individual 
libraries and may decide to replace one or more of them.

<p>A typical skeleton for building a server is given below. If this file 
is loaded as main file (using e.g., <code>swipl server.pl</code>) it 
creates a simple server that listens on port 8080. If the root is 
accessed it redirects to the home page and shows <b>Hello world!</b>.

<pre class="code">
:- use_module(library(http/http_server)).

:- initialization
    http_server([port(8080)]).

:- http_handler(root(.),
                http_redirect(moved, location_by_id(home_page)),
                []).
:- http_handler(root(home), home_page, []).

home_page(_Request) :-
    reply_html_page(
        title('Demo server'),
        [ h1('Hello world!')
        ]).
</pre>

<p><h3 id="sec:html-body"><a id="sec:3.1"><span class="sec-nr">3.1</span> <span class="sec-title">Creating 
an HTTP reply</span></a></h3>

<a id="sec:html-body"></a>

<p>The <em>handler</em> (e.g., home_page/1 above) is called with the 
parsed request (see <a class="sec" href="#sec:3.13">section 3.13</a>) as 
argument and
<code>current_output</code> set to a temporary buffer. Its task is 
closely related to the task of a CGI script; it must write a header 
declaring at least the <code>Content-type</code> field and a body. Below 
is a simple body writing the request as an HTML table.<sup class="fn">3<span class="fn-text">Note 
that writing an HTML reply this way is deprecated. In fact, the code is 
subject to <em>injection attacks</em> as the HTTP request field values 
are literally injected in the output while HTML reserved characters 
should be properly escaped.</span></sup>

<pre class="code">
reply(Request) :-
        format('Content-type: text/html~n~n', []),
        format('&lt;html&gt;~n', []),
        format('&lt;table border=1&gt;~n'),
        print_request(Request),
        format('~n&lt;/table&gt;~n'),
        format('&lt;/html&gt;~n', []).

print_request([]).
print_request([H|T]) :-
        H =.. [Name, Value],
        format('&lt;tr&gt;&lt;td&gt;~w&lt;td&gt;~w~n', [Name, Value]),
        print_request(T).
</pre>

<p>The infrastructure recognises the header fields described below. 
Other header lines are passed verbatim to the client. Typical examples 
are
<code>Set-Cookie</code> and authentication headers (see <a class="sec" href="#sec:3.7">section 
3.7</a>).

<dl class="latex">
<dt><b>Content-type:&nbsp;<var>Type</var></b></dt>
<dd>
This field is passed to the client and used by the infrastructure to 
determine the <em>encoding</em> to use for the stream. If <var>type</var> 
matches <code>text/*</code> or the type matches with <code>UTF-8</code> 
(case insensitive), the server uses UTF-8 encoding. The user may force 
UTF-8 encoding for arbitrary content types by adding <code>; 
charset=UTF-8</code> to the end of the <code>Content-type</code> header.</dd>
<dt><b>Transfer-encoding:&nbsp;chunked</b></dt>
<dd>
Causes the server to use <em>chunked</em> encoding if the client allows 
for it. See also <a class="sec" href="#sec:5">section 5</a> and the
<code>chunked</code> option in <a id="idx:httphandler3:9"></a><a class="pred" href="#http_handler/3">http_handler/3</a>.</dd>
<dt><b>Connection:&nbsp;close</b></dt>
<dd>
Causes the connection to be closed after the transfer. The default is to 
keep it open&lsquo;Keep-Alive&rsquo;if possible.</dd>
<dt><b>Location:&nbsp;<var>URL</var></b></dt>
<dd>
This header may be combined with the <code>Status</code> header to force 
a
<em>redirect</em> response to the given <var>URL</var>. The message body 
must be empty. Handling this header is primarily intended for 
compatibility with the CGI conventions. Prolog code should use
<a id="idx:httpredirect3:10"></a><a class="pred" href="#http_redirect/3">http_redirect/3</a>.</dd>
<dt><b>Status:&nbsp;<var>Status</var></b></dt>
<dd>
This header can be combined with <code>Location</code>, where <var>Status</var> 
must be one of 301 (moved), 302 (moved temporary, default) or 303 (see 
other). Using the status field also allows for formulating replies such 
as 201 (created).
</dd>
</dl>

<p>Note that the handler may send any type of document instead of HTML. 
After the header has been written, the <em>encoding</em> of the
<code>current_output</code> stream encoding is established as follows:

<p>
<ol class="latex">
<li>If the content type is <code>text/*</code> the stream is switched to 
UTF-8 encoding. If the content type does not provide attributes, <code>; charset=UTF-8</code> 
is added.
<li>The content type contains <code>UTF-8</code> the stream is switched 
to UTF-8 encoding.
<li><a id="idx:httpmimetypeencoding2:11"></a><a class="pred" href="#http:mime_type_encoding/2">http:mime_type_encoding/2</a> 
succeeds the returned encoding is used. The returned encoding must be 
valid for <a id="idx:setstream2:12"></a><span class="pred-ext">set_stream/2</span>.
<li>If the content type matches a list of known encodings, this is used. 
See <a id="idx:mimetypeencoding2:13"></a><span class="pred-ext">mime_type_encoding/2</span> 
is <code>http_header</code>. The current list deals with JSON, Turtle 
and SPARQL.
<li>Otherwise the stream uses octed (binary) encoding.
</ol>

<p><h4 id="sec:httpspecials"><a id="sec:3.1.1"><span class="sec-nr">3.1.1</span> <span class="sec-title">Returning 
special status codes</span></a></h4>

<a id="sec:httpspecials"></a>

<p>Besides returning a page by writing it to the current output stream, 
the server goal can raise an exception using <a id="idx:throw1:14"></a><span class="pred-ext">throw/1</span> 
to generate special pages such as <code>not_found</code>, <code>moved</code>, 
etc. The defined exceptions are:

<dl class="latex">
<dt><strong>http_reply</strong>(<var>+Reply, +HdrExtra, +Context</var>)</dt>
<dd class="defbody">
Return a result page using <a id="idx:httpreply3:15"></a><a class="pred" href="#http_reply/3">http_reply/3</a>. 
See <a id="idx:httpreply3:16"></a><a class="pred" href="#http_reply/3">http_reply/3</a> 
for supported values for Reply and <a class="sec" href="#sec:3.10">section 
3.10</a> for providing a custom error page.</dd>
<dt><strong>http_reply</strong>(<var>+Reply, +HdrExtra</var>)</dt>
<dd class="defbody">
Return a result page using <a id="idx:httpreply3:17"></a><a class="pred" href="#http_reply/3">http_reply/3</a>. 
Equivalent to
<code>http_reply(Reply, HdrExtra,[])</code>.</dd>
<dt><strong>http_reply</strong>(<var>+Reply</var>)</dt>
<dd class="defbody">
Equivalent to <code>http_reply(Reply, [],[])</code>.</dd>
<dt><strong>http</strong>(<var>not_modified</var>)</dt>
<dd class="defbody">
Equivalent to <code>http_reply(not_modified,[])</code>. This exception 
is for backward compatibility and can be used by the server to indicate 
the referenced resource has not been modified since it was requested 
last time.
</dd>
</dl>

<p>In addition, the normal <code>"200 OK"</code> reply status may be 
overruled by writing a CGI <code>Status</code> header prior to the 
remainder of the message. This is particularly useful for defining REST 
APIs. The following handler replies with a <code>"201 Created"</code> 
header:

<pre class="code">
handle_request(Request) :-
        process_data(Request, Id),      % application predicate
        format('Status: 201~n'),
        format('Content-type: text/plain~n~n'),
        format('Created object as ~q~n', [Id]).
</pre>

<p><h3 id="sec:httpdispatch"><a id="sec:3.2"><span class="sec-nr">3.2</span> <span class="sec-title">library(http/http_dispatch): 
Dispatch requests in the HTTP server</span></a></h3>

<p><a id="sec:httpdispatch"></a>

<p>Most code doesn't need to use this directly; instead use
<code>library(http/http_server)</code>, which combines this library with 
the typical HTTP libraries that most servers need.

<p>This module can be placed between <code>http_wrapper.pl</code> and 
the application code to associate HTTP <i>locations</i> to predicates 
that serve the pages. In addition, it associates parameters with 
locations that deal with timeout handling and user authentication. The 
typical setup is:

<pre class="code">
server(Port, Options) :-
        http_server(http_dispatch,
                    [ port(Port)
                    | Options
                    ]).

:- http_handler('/index.html', write_index, []).

write_index(Request) :-
        ...
</pre>

<dl class="latex">
<dt class="pubdef"><span class="pred-tag">[det]</span><a id="http_handler/3"><strong>http_handler</strong>(<var>+Path, 
:Closure, +Options</var>)</a></dt>
<dd class="defbody">
Register <var>Closure</var> as a handler for HTTP requests. <var>Path</var> 
is either an absolute path such as <code>'/home.html'</code> or a term 
Alias(Relative). Where Alias is associated with a concrete path using <a class="pred" href="#http:location/3">http:location/3</a> 
and resolved using <a class="pred" href="#http_absolute_location/3">http_absolute_location/3</a>. <var>Relative</var> 
can be a single atom or a term&lsquo;Segment1/Segment2/...`, where each 
element is either an atom or a variable. If a segment is a variable it 
matches any segment and the binding may be passed to the closure. If the 
last segment is a variable it may match multiple segments. This allows 
registering REST paths, for example:

<pre class="code">
:- http_handler(root(user/User), user(Method, User),
                [ method(Method),
                  methods([get,post,put])
                ]).

user(get, User, Request) :-
    ...
user(post, User, Request) :-
    ...
</pre>

<p>If an HTTP request arrives at the server that matches <var>Path</var>, <var>Closure</var> 
is called as below, where <var>Request</var> is the parsed HTTP request.

<pre class="code">
call(Closure, Request)
</pre>

<p><var>Options</var> is a list containing the following options:

<dl class="latex">
<dt><strong>authentication</strong>(<var>+Type</var>)</dt>
<dd class="defbody">
Demand authentication. Authentication methods are pluggable. The library <code>http_authenticate.pl</code> 
provides a plugin for user/password based <code>Basic</code> HTTP 
authentication.
</dd>
<dt><strong>chunked</strong></dt>
<dd class="defbody">
Use <code>Transfer-encoding: chunked</code> if the client allows for it.
</dd>
<dt><strong>condition</strong>(<var>:Goal</var>)</dt>
<dd class="defbody">
If present, the handler is ignored if <var>Goal</var> does not succeed.
</dd>
<dt><strong>content_type</strong>(<var>+Term</var>)</dt>
<dd class="defbody">
Specifies the content-type of the reply. This value is currently not 
used by this library. It enhances the reflexive capabilities of this 
library through <a class="pred" href="#http_current_handler/3">http_current_handler/3</a>.
</dd>
<dt><strong>id</strong>(<var>+Atom</var>)</dt>
<dd class="defbody">
Identifier of the handler. The default identifier is the predicate name. 
Used by <a class="pred" href="#http_location_by_id/2">http_location_by_id/2</a> 
and
<a class="pred" href="#http_link_to_id/3">http_link_to_id/3</a>.
</dd>
<dt><strong>hide_children</strong>(<var>+Bool</var>)</dt>
<dd class="defbody">
If <code>true</code> on a prefix-handler (see prefix), possible children 
are masked. This can be used to (temporary) overrule part of the tree.
</dd>
<dt><strong>method</strong>(<var>+Method</var>)</dt>
<dd class="defbody">
Declare that the handler processes <var>Method</var>. This is equivalent 
to
<code>methods([Method])</code>. Using <code>method(*)</code> allows for 
all methods.
</dd>
<dt><strong>methods</strong>(<var>+ListOfMethods</var>)</dt>
<dd class="defbody">
Declare that the handler processes all of the given methods. If this 
option appears multiple times, the methods are combined.
</dd>
<dt><strong>prefix</strong></dt>
<dd class="defbody">
Call Pred on any location that is a specialisation of <var>Path</var>. 
If multiple handlers match, the one with the longest path is used.
<var>Options</var> defined with a prefix handler are the default options 
for paths that start with this prefix. Note that the handler acts as a 
fallback handler for the tree below it:

<pre class="code">
:- http_handler(/, http_404([index('index.html')]),
                [spawn(my_pool),prefix]).
</pre>

</dd>
<dt><strong>priority</strong>(<var>+Integer</var>)</dt>
<dd class="defbody">
If two handlers handle the same path, the one with the highest priority 
is used. If equal, the last registered is used. Please be aware that the 
order of clauses in multifile predicates can change due to reloading 
files. The default priority is 0 (zero).
</dd>
<dt><strong>spawn</strong>(<var>+SpawnOptions</var>)</dt>
<dd class="defbody">
Run the handler in a separate thread. If <var>SpawnOptions</var> is an 
atom, it is interpreted as a thread pool name (see
<span class="pred-ext">create_thread_pool/3</span>). Otherwise the 
options are passed to
<a class="pred" href="#http_spawn/2">http_spawn/2</a> and from there to <span class="pred-ext">thread_create/3</span>. 
These options are typically used to set the stack limits.
</dd>
<dt><strong>time_limit</strong>(<var>+Spec</var>)</dt>
<dd class="defbody">
One of <code>infinite</code>, <code>default</code> or a positive number 
(seconds). If
<code>default</code>, the value from the setting <code>http:time_limit</code> 
is taken. The default of this setting is 300 (5 minutes). See
<span class="pred-ext">setting/2</span>.
</dd>
</dl>

<p>Note that <a class="pred" href="#http_handler/3">http_handler/3</a> 
is normally invoked as a directive and processed using term-expansion. 
Using term-expansion ensures proper update through <span class="pred-ext">make/0</span> 
when the specification is modified.

<dl class="tags">
<dt class="mtag">Errors</dt>
<dd>
- <code>existence_error(http_location, Location)</code> <br>
- <code>permission_error(http_method, Method, Location)</code>
</dd>
<dt class="tag">See also</dt>
<dd>
<a class="pred" href="#http_reply_file/3">http_reply_file/3</a> and <a class="pred" href="#http_redirect/3">http_redirect/3</a> 
are generic handlers to serve files and achieve redirects.
</dd>
</dl>

</dd>
<dt class="pubdef"><span class="pred-tag">[det]</span><a id="http_delete_handler/1"><strong>http_delete_handler</strong>(<var>+Spec</var>)</a></dt>
<dd class="defbody">
Delete handler for <var>Spec</var>. Typically, this should only be used 
for handlers that are registered dynamically. <var>Spec</var> is one of:

<dl class="latex">
<dt><strong>id</strong>(<var>Id</var>)</dt>
<dd class="defbody">
Delete a handler with the given id. The default id is the 
handler-predicate-name.
</dd>
<dt><strong>path</strong>(<var>Path</var>)</dt>
<dd class="defbody">
Delete handler that serves the given path.
</dd>
</dl>

</dd>
<dt class="pubdef"><span class="pred-tag">[det]</span><a id="http_dispatch/1"><strong>http_dispatch</strong>(<var>Request</var>)</a></dt>
<dd class="defbody">
Dispatch a <var>Request</var> using <a class="pred" href="#http_handler/3">http_handler/3</a> 
registrations. It performs the following steps:

<p>
<ol class="latex">
<li>Find a matching handler based on the <code>path</code> member of <var>Request</var>. 
If multiple handlers match due to the <code>prefix</code> option or 
variables in path segments (see <a class="pred" href="#http_handler/3">http_handler/3</a>), 
the longest specification is used. If multiple specifications of equal 
length match the one with the highest priority is used.
<li>Check that the handler matches the <code>method</code> member of the
<var>Request</var> or throw <code>permission_error(http_method, Method, Location)</code>
<li>Expand the request using expansion hooks registered by
<span class="pred-ext">http_request_expansion/3</span>. This may add 
fields to the request, such the authenticated user, parsed parameters, 
etc. The hooks may also throw exceptions, notably using <a class="pred" href="#http_redirect/3">http_redirect/3</a> 
or by throwing <code>http_reply(Term, ExtraHeader, Context)</code> 
exceptions.
<li>Extract possible fields from the <var>Request</var> using e.g.
<code>method(Method)</code> as one of the options.
<li>Call the registered <i>closure</i>, optionally spawning the request 
to a new thread or enforcing a time limit.
</ol>
</dd>
<dt class="pubdef"><a id="http_request_expansion/2"><strong>http_request_expansion</strong>(<var>:Goal, 
+Rank:number</var>)</a></dt>
<dd class="defbody">
Register <var>Goal</var> for expanding the HTTP request handler. <var>Goal</var> 
is called as below. If <var>Goal</var> fail the request is passed to the 
next expansion unmodified.

<pre class="code">
call(Goal, Request0, Request, Options)
</pre>

<p>If multiple goals are registered they expand the request in a 
pipeline starting with the expansion hook with the lowest rank.

<p>Besides rewriting the request, for example by validating the user 
identity based on HTTP authentication or cookies and adding this to the 
request, the hook may raise HTTP exceptions to indicate a bad request, 
permission error, etc. See <a class="pred" href="#http_status_reply/4">http_status_reply/4</a>.

<p>Initially, <span class="pred-ext">auth_expansion/3</span> is 
registered with rank <code>100</code> to deal with the older <a class="pred" href="#http:authenticate/3">http:authenticate/3</a> 
hook.</dd>
<dt class="pubdef"><span class="pred-tag">[semidet]</span><a id="http_current_handler/2"><strong>http_current_handler</strong>(<var>+Location, 
:Closure</var>)</a></dt>
<dt class="pubdef"><span class="pred-tag">[nondet]</span><a id="http_current_handler/2"><strong>http_current_handler</strong>(<var>-Location, 
:Closure</var>)</a></dt>
<dd class="defbody">
True if <var>Location</var> is handled by <var>Closure</var>.</dd>
<dt class="pubdef"><span class="pred-tag">[semidet]</span><a id="http_current_handler/3"><strong>http_current_handler</strong>(<var>+Location, 
:Closure, -Options</var>)</a></dt>
<dt class="pubdef"><span class="pred-tag">[nondet]</span><a id="http_current_handler/3"><strong>http_current_handler</strong>(<var>?Location, 
:Closure, ?Options</var>)</a></dt>
<dd class="defbody">
Resolve the current handler and options to execute it.</dd>
<dt class="pubdef"><span class="pred-tag">[det]</span><a id="http_location_by_id/2"><strong>http_location_by_id</strong>(<var>+ID, 
-Location</var>)</a></dt>
<dd class="defbody">
True when <var>Location</var> represents the HTTP path to which the 
handler with identifier <var>ID</var> is bound. Handler identifiers are 
deduced from the <a class="pred" href="#http_handler/3">http_handler/3</a> 
declaration as follows:

<dl class="latex">
<dt><b>Explicit id</b></dt>
<dd>
If a term <code>id(ID)</code> appears in the option list of the handler, <var>ID</var> 
it is used and takes preference over using the predicate.
</dd>
<dt><b>Using the handler predicate</b></dt>
<dd>
<var>ID</var> matches a handler if the predicate name matches <var>ID</var>. 
The
<var>ID</var> may have a module qualification, e.g., <code>Module:Pred</code>
</dd>
</dl>

<p>If the handler is declared with a pattern, e.g., <code>root(user/User)</code>, 
the location to access a particular <i>user</i> may be accessed using 
e.g., <code>user('Bob')</code>. The number of arguments to the compound 
term must match the number of variables in the path pattern.

<p>A plain atom <var>ID</var> can be used to find a handler with a 
pattern. The returned location is the path up to the first variable, 
e.g.,
<code>/user/</code> in the example above.

<p>User code is adviced to use <a class="pred" href="#http_link_to_id/3">http_link_to_id/3</a> 
which can also add query parameters to the URL. This predicate is a 
helper for
<a class="pred" href="#http_link_to_id/3">http_link_to_id/3</a>.

<dl class="tags">
<dt class="tag">Errors</dt>
<dd>
<code>existence_error(http_handler_id, Id)</code>.
</dd>
<dt class="tag">See also</dt>
<dd>
<a class="pred" href="#http_link_to_id/3">http_link_to_id/3</a> and the <code>library(http/html_write)</code> 
construct
<code>location_by_id(ID)</code> or its abbreviation <code>#(ID)</code>
</dd>
</dl>

</dd>
<dt class="pubdef"><a id="http_link_to_id/3"><strong>http_link_to_id</strong>(<var>+HandleID, 
+Parameters, -HREF</var>)</a></dt>
<dd class="defbody">
<var>HREF</var> is a link on the local server to a handler with given 
ID, passing the given <var>Parameters</var>. This predicate is typically 
used to formulate a <var>HREF</var> that resolves to a handler 
implementing a particular predicate. The code below provides a typical 
example. The predicate <span class="pred-ext">user_details/1</span> 
returns a page with details about a user from a given id. This predicate 
is registered as a handler. The DCG <span class="pred-ext">user_link//1</span> 
renders a link to a user, displaying the name and calling <span class="pred-ext">user_details/1</span> 
when clicked. Note that the location (<code>root(user_details)</code>) 
is irrelevant in this equation and HTTP locations can thus be moved 
freely without breaking this code fragment.

<pre class="code">
:- http_handler(root(user_details), user_details, []).

user_details(Request) :-
    http_parameters(Request,
                    [ user_id(ID)
                    ]),
    ...

user_link(ID) --&gt;
    { user_name(ID, Name),
      http_link_to_id(user_details, [id(ID)], HREF)
    },
    html(a([class(user), href(HREF)], Name)).
</pre>

<table class="arglist">
<tr><td><var>HandleID</var> </td><td>is either an atom, possibly module 
qualified predicate or a compound term if the hander is defined using a 
pattern. See <a class="pred" href="#http_handler/3">http_handler/3</a> 
and <a class="pred" href="#http_location_by_id/2">http_location_by_id/2</a>. </td></tr>
<tr><td><var>Parameters</var> </td><td>is one of

<p>
<ul class="latex">
<li><code>path_postfix(File)</code> to pass a single value as the last 
segment of the HTTP location (path). This way of passing a parameter is 
commonly used in REST APIs.

<p>New code should use a path pattern in the handler declaration and a 
term&lsquo;<var>HandleID</var>(Arg, ...)`
<li>A list of search parameters for a <code>GET</code> request.
</ul>

<p></td></tr>
</table>

<dl class="tags">
<dt class="tag">See also</dt>
<dd>
<a class="pred" href="#http_location_by_id/2">http_location_by_id/2</a> 
and <a class="pred" href="#http_handler/3">http_handler/3</a> for 
defining and specifying handler IDs.
</dd>
</dl>

</dd>
<dt class="pubdef"><span class="pred-tag">[det]</span><a id="http_reload_with_parameters/3"><strong>http_reload_with_parameters</strong>(<var>+Request, 
+Parameters, -HREF</var>)</a></dt>
<dd class="defbody">
Create a request on the current handler with replaced search parameters.</dd>
<dt class="pubdef"><span class="pred-tag">[det]</span><a id="http_reply_file/3"><strong>http_reply_file</strong>(<var>+FileSpec, 
+Options, +Request</var>)</a></dt>
<dd class="defbody">
<var>Options</var> is a list of

<dl class="latex">
<dt><strong>cache</strong>(<var>+Boolean</var>)</dt>
<dd class="defbody">
If <code>true</code> (default), handle If-modified-since and send 
modification time.
</dd>
<dt><strong>mime_type</strong>(<var>+Type</var>)</dt>
<dd class="defbody">
Overrule mime-type guessing from the filename as provided by <span class="pred-ext">file_mime_type/2</span>.
</dd>
<dt><strong>static_gzip</strong>(<var>+Boolean</var>)</dt>
<dd class="defbody">
If <code>true</code> (default <code>false</code>) and, in addition to 
the plain file, there is a <code>.gz</code> file that is not older than 
the plain file and the client acceps <code>gzip</code> encoding, send 
the compressed file with <code>Transfer-encoding: gzip</code>.
</dd>
<dt><strong>cached_gzip</strong>(<var>+Boolean</var>)</dt>
<dd class="defbody">
If <code>true</code> (default <code>false</code>) the system maintains 
cached gzipped files in a directory accessible using the file search 
path <code>http_gzip_cache</code> and serves these similar to the <code>static_gzip(true)</code> 
option. If the gzip file does not exist or is older than the input the 
file is recreated.
</dd>
<dt><strong>unsafe</strong>(<var>+Boolean</var>)</dt>
<dd class="defbody">
If <code>false</code> (default), validate that <var>FileSpec</var> does 
not contain references to parent directories. E.g., specifications such 
as <code>www('../../etc/passwd')</code> are not allowed.
</dd>
<dt><strong>headers</strong>(<var>+List</var>)</dt>
<dd class="defbody">
Provides additional reply-header fields, encoded as a list of <i>Field(Value)</i>.
</dd>
</dl>

<p>If caching is not disabled, it processes the request headers
<code>If-modified-since</code> and <code>Range</code>.

<dl class="tags">
<dt class="mtag">throws</dt>
<dd>
- <code>http_reply(not_modified)</code> <br>
- <code>http_reply(file(MimeType, Path))</code>
</dd>
</dl>

</dd>
<dt class="pubdef"><span class="pred-tag">[det]</span><a id="http_safe_file/2"><strong>http_safe_file</strong>(<var>+FileSpec, 
+Options</var>)</a></dt>
<dd class="defbody">
True if <var>FileSpec</var> is considered <i>safe</i>. If it is an atom, 
it cannot be absolute and cannot have references to parent directories. 
If it is of the form <code>alias(Sub)</code>, than Sub cannot have 
references to parent directories.

<dl class="tags">
<dt class="mtag">Errors</dt>
<dd>
- instantiation_error <br>
- <code>permission_error(read, file, FileSpec)</code>
</dd>
</dl>

</dd>
<dt class="pubdef"><span class="pred-tag">[det]</span><a id="http_redirect/3"><strong>http_redirect</strong>(<var>+How, 
+To, +Request</var>)</a></dt>
<dd class="defbody">
Redirect to a new location. The argument order, using the
<var>Request</var> as last argument, allows for calling this directly 
from the handler declaration:

<pre class="code">
:- http_handler(root(.),
                http_redirect(moved, myapp('index.html')),
                []).
</pre>

<table class="arglist">
<tr><td><var>How</var> </td><td>is one of <code>moved</code>, <code>moved_temporary</code> 
or <code>see_other</code> </td></tr>
<tr><td><var>To</var> </td><td>is an atom, a aliased path as defined by
<a class="pred" href="#http_absolute_location/3">http_absolute_location/3</a>. 
or a term <code>location_by_id(Id)</code> or its abbreviations <code>#(Id)</code> 
or <code>#(Id)+Parameters</code>. If <var>To</var> is not absolute, it 
is resolved relative to the current location. </td></tr>
</table>
</dd>
<dt class="pubdef"><span class="pred-tag">[det]</span><a id="http_404/2"><strong>http_404</strong>(<var>+Options, 
+Request</var>)</a></dt>
<dd class="defbody">
Reply using an "HTTP 404 not found" page. This handler is intended as 
fallback handler for <i>prefix</i> handlers. <var>Options</var> 
processed are:

<dl class="latex">
<dt><strong>index</strong>(<var>Location</var>)</dt>
<dd class="defbody">
If there is no path-info, redirect the request to
<var>Location</var> using <a class="pred" href="#http_redirect/3">http_redirect/3</a>.
</dd>
</dl>

<dl class="tags">
<dt class="tag">Errors</dt>
<dd>
<code>http_reply(not_found(Path))</code>
</dd>
</dl>

</dd>
<dt class="pubdef"><a id="http_switch_protocol/2"><strong>http_switch_protocol</strong>(<var>:Goal, 
+Options</var>)</a></dt>
<dd class="defbody">
Send an <code>"HTTP 101 Switching Protocols"</code> reply. After sending 
the reply, the HTTP library calls <code>call(Goal, InStream, OutStream)</code>, 
where InStream and OutStream are the raw streams to the HTTP client. 
This allows the communication to continue using an an alternative 
protocol.

<p>If <var>Goal</var> fails or throws an exception, the streams are 
closed by the server. Otherwise <var>Goal</var> is responsible for 
closing the streams. Note that <var>Goal</var> runs in the HTTP handler 
thread. Typically, the handler should be registered using the <code>spawn</code> 
option if <a class="pred" href="#http_handler/3">http_handler/3</a> or <var>Goal</var> 
must call <span class="pred-ext">thread_create/3</span> to allow the 
HTTP worker to return to the worker pool.

<p>The streams use binary (octet) encoding and have their I/O timeout 
set to the server timeout (default 60 seconds). The predicate <span class="pred-ext">set_stream/2</span> 
can be used to change the encoding, change or cancel the timeout.

<p>This predicate interacts with the server library by throwing an 
exception.

<p>The following options are supported:

<dl class="latex">
<dt><strong>header</strong>(<var>+Headers</var>)</dt>
<dd class="defbody">
Backward compatible. Use <code>headers(+Headers)</code>.
</dd>
<dt><strong>headers</strong>(<var>+Headers</var>)</dt>
<dd class="defbody">
Additional headers send with the reply. Each header takes the form 
Name(Value).
</dd>
</dl>

</dd>
</dl>

<p><h3 id="sec:httpdirindex"><a id="sec:3.3"><span class="sec-nr">3.3</span> <span class="sec-title">library(http/http_dirindex): 
HTTP directory listings</span></a></h3>

<p><a id="sec:httpdirindex"></a>

<dl class="tags">
<dt class="tag">To be done</dt>
<dd>
Provide more options (sorting, selecting columns, hiding files)
</dd>
</dl>

<p>This module provides a simple API to generate an index for a physical 
directory. The index can be customised by overruling the dirindex.css 
CSS file and by defining additional rules for icons using the hook
<span class="pred-ext">http:file_extension_icon/2</span>.

<dl class="latex">
<dt class="pubdef"><span class="pred-tag">[det]</span><a id="http_reply_dirindex/3"><strong>http_reply_dirindex</strong>(<var>+DirSpec, 
:Options, +Request</var>)</a></dt>
<dd class="defbody">
Provide a directory listing for <var>Request</var>, assuming it is an 
index for the physical directrory Dir. If the request-path does not end 
with /, first return a moved (301 Moved Permanently) reply.

<p>The calling conventions allows for direct calling from
<a class="pred" href="#http_handler/3">http_handler/3</a>.</dd>
<dt class="pubdef"><span class="pred-tag">[det]</span><a id="directory_index//2"><strong>directory_index</strong>(<var>+Dir, 
:Options</var>)</a><code>//</code></dt>
<dd class="defbody">
Show index for a directory. <var>Options</var> processed:

<dl class="latex">
<dt><strong>order_by</strong>(<var>+Field</var>)</dt>
<dd class="defbody">
Sort the files in the directory listing by <var>Field</var>. <var>Field</var> 
is one of <code>name</code> (default), <code>size</code> or <code>time</code>.
</dd>
<dt><strong>order</strong>(<var>+AscentDescent</var>)</dt>
<dd class="defbody">
Sorting order. Default is <code>ascending</code>. The altenative is
<code>descending</code>
</dd>
<dt><strong>name</strong>(<var>:RenderName</var>)</dt>
<dd class="defbody">
DCG used to render a name in the table. The File is passed.
</dd>
</dl>

</dd>
<dt class="multidef"><span class="pred-tag">[nondet,multifile]</span><a id="http:mime_type_icon/2"><span class="module">http</span>:<strong>mime_type_icon</strong>(<var>+MimeType, 
-IconName</var>)</a></dt>
<dd class="defbody">
Multi-file hook predicate that can be used to associate icons to files 
listed by <a class="pred" href="#http_reply_dirindex/3">http_reply_dirindex/3</a>. 
The actual icon file is located by <code>absolute_file_name(icons(IconName), Path, [])</code>.

<dl class="tags">
<dt class="tag">See also</dt>
<dd>
<span class="pred-ext">serve_files_in_directory/2</span> serves the 
images.
</dd>
</dl>

</dd>
</dl>

<p><h3 id="sec:httpfiles"><a id="sec:3.4"><span class="sec-nr">3.4</span> <span class="sec-title">library(http/http_files): 
Serve plain files from a hierarchy</span></a></h3>

<p><a id="sec:httpfiles"></a>

<dl class="tags">
<dt class="tag">See also</dt>
<dd>
<a class="pred" href="#pwp_handler/2">pwp_handler/2</a> provides similar 
facilities, where .pwp files can be used to add dynamic behaviour.
</dd>
</dl>

<p>Although the SWI-Prolog Web Server is intended to serve documents 
that are computed dynamically, serving plain files is sometimes 
necessary. This small module combines the functionality of <a class="pred" href="#http_reply_file/3">http_reply_file/3</a> 
and
<a class="pred" href="#http_reply_dirindex/3">http_reply_dirindex/3</a> 
to act as a simple web-server. Such a server can be created using the 
following code sample, which starts a server at port 8080 that serves 
files from the current directory (&rsquo;.&rsquo;). Note that the 
handler needs a <code>prefix</code> option to specify that it must 
handle all paths that begin with the registed location of the handler.

<pre class="code">
:- use_module(library(http/http_server)).
:- use_module(library(http/http_files)).

:- http_handler(root(.), http_reply_from_files('.', []), [prefix]).

:- initialization(http_server([port(8080)]), main).
</pre>

<dl class="latex">
<dt class="pubdef"><a id="http_reply_from_files/3"><strong>http_reply_from_files</strong>(<var>+Dir, 
+Options, +Request</var>)</a></dt>
<dd class="defbody">
HTTP handler that serves files from the directory <var>Dir</var>. This 
handler uses <a class="pred" href="#http_reply_file/3">http_reply_file/3</a> 
to reply plain files. If the request resolves to a directory, it uses 
the option <code>indexes</code> to locate an index file (see below) or 
uses <a class="pred" href="#http_reply_dirindex/3">http_reply_dirindex/3</a> 
to create a listing of the directory.

<p><var>Options</var>:

<dl class="latex">
<dt><strong>indexes</strong>(<var>+List</var>)</dt>
<dd class="defbody">
<var>List</var> of files tried to find an index for a directory. The 
default is <code>['index.html']</code>.
</dd>
<dt><strong>not_found</strong>(<var>+Action</var>)</dt>
<dd class="defbody">
<var>Action</var> defines what happens if the target file was not found.
<var>Options</var>: <code>fail</code> makes the handler fail silently. <code>404</code> 
make the handler call <a class="pred" href="#http_404/2">http_404/2</a>. 
Default is <code>fail</code>.
</dd>
</dl>

<p>Note that this handler must be tagged as a <code>prefix</code> 
handler (see
<a class="pred" href="#http_handler/3">http_handler/3</a> and module 
introduction). This also implies that it is possible to override more 
specific locations in the hierarchy using <a class="pred" href="#http_handler/3">http_handler/3</a> 
with a longer path-specifier.

<p>When using <a class="pred" href="#http_handler/3">http_handler/3</a> 
to bind this predicate to an HTTP location, make sure it is bound to a 
location that ends in a <code>/</code>. When using <a class="pred" href="#http:location/3">http:location/3</a> 
to define symbolic names to HTTP locations this is written as
<div style="text-align:center">
<code>:-</code> <code>http_handler(aliasname(.), http_reply_from_files(srcdir, []), [prefix])</code>.
</div>
<table class="arglist">
<tr><td><var>Dir</var> </td><td>is either a directory or an 
path-specification as used by <span class="pred-ext">absolute_file_name/3</span>. 
This option provides great flexibility in (re-)locating the physical 
files and allows merging the files of multiple physical locations into 
one web-hierarchy by using multiple
<span class="pred-ext">user:file_search_path/2</span> clauses that 
define the same alias. </td></tr>
</table>

<dl class="tags">
<dt class="tag">See also</dt>
<dd>
The hookable predicate <span class="pred-ext">file_mime_type/2</span> is 
used to determine the <code>Content-type</code> from the file name.
</dd>
</dl>

</dd>
</dl>

<p><h3 id="sec:httpsession"><a id="sec:3.5"><span class="sec-nr">3.5</span> <span class="sec-title">library(http/http_session): 
HTTP Session management</span></a></h3>

<p><a id="sec:httpsession"></a>

<p>This library defines session management based on HTTP cookies. 
Session management is enabled simply by loading this module. Details can 
be modified using <a class="pred" href="#http_set_session_options/1">http_set_session_options/1</a>. 
By default, this module creates a session whenever a request is 
processes that is inside the hierarchy defined for session handling (see 
path option in
<a class="pred" href="#http_set_session_options/1">http_set_session_options/1</a>). 
Automatic creation of a session can be stopped using the option <code>create(noauto)</code>. 
The predicate
<a class="pred" href="#http_open_session/2">http_open_session/2</a> must 
be used to create a session if <code>noauto</code> is enabled. Sessions 
can be closed using <a class="pred" href="#http_close_session/1">http_close_session/1</a>.

<p>If a session is active, <a class="pred" href="#http_in_session/1">http_in_session/1</a> 
returns the current session and <a class="pred" href="#http_session_assert/1">http_session_assert/1</a> 
and friends maintain data about the session. If the session is 
reclaimed, all associated data is reclaimed too.

<p>Begin and end of sessions can be monitored using <code>library(broadcast)</code>. 
The broadcasted messages are:

<dl class="latex">
<dt><strong>http_session</strong>(<var>begin(SessionID,Peer)</var>)</dt>
<dd class="defbody">
Broadcasted if a session is started
</dd>
<dt><strong>http_session</strong>(<var>end(SessionId,Peer)</var>)</dt>
<dd class="defbody">
Broadcasted if a session is ended. See <a class="pred" href="#http_close_session/1">http_close_session/1</a>.
</dd>
</dl>

<p>For example, the following calls <code>end_session(SessionId)</code> 
whenever a session terminates. Please note that sessions ends are not 
scheduled to happen at the actual timeout moment of the session. 
Instead, creating a new session scans the active list for timed-out 
sessions. This may change in future versions of this library.

<pre class="code">
:- listen(http_session(end(SessionId, Peer)),
          end_session(SessionId)).
</pre>

<dl class="latex">
<dt class="pubdef"><span class="pred-tag">[det]</span><a id="http_set_session_options/1"><strong>http_set_session_options</strong>(<var>+Options</var>)</a></dt>
<dd class="defbody">
Set options for the session library. Provided options are:

<dl class="latex">
<dt><strong>timeout</strong>(<var>+Seconds</var>)</dt>
<dd class="defbody">
Session timeout in seconds. Default is 600 (10 min). A timeout of <code>0</code> 
(zero) disables timeout.
</dd>
<dt><strong>cookie</strong>(<var>+Cookiekname</var>)</dt>
<dd class="defbody">
Name to use for the cookie to identify the session. Default <code>swipl_session</code>.
</dd>
<dt><strong>path</strong>(<var>+Path</var>)</dt>
<dd class="defbody">
<var>Path</var> to which the cookie is associated. Default is
<code>/</code>. Cookies are only sent if the HTTP request path is a 
refinement of <var>Path</var>.
</dd>
<dt><strong>route</strong>(<var>+Route</var>)</dt>
<dd class="defbody">
Set the route name. Default is the unqualified hostname. To cancel 
adding a route, use the empty atom. See <span class="pred-ext">route/1</span>.
</dd>
<dt><strong>enabled</strong>(<var>+Boolean</var>)</dt>
<dd class="defbody">
Enable/disable session management. Sesion management is enabled by 
default after loading this file.
</dd>
<dt><strong>create</strong>(<var>+Atom</var>)</dt>
<dd class="defbody">
Defines when a session is created. This is one of <code>auto</code> 
(default), which creates a session if there is a request whose path 
matches the defined session path or <code>noauto</code>, in which cases 
sessions are only created by calling
<a class="pred" href="#http_open_session/2">http_open_session/2</a> 
explicitely.
</dd>
<dt><strong>proxy_enabled</strong>(<var>+Boolean</var>)</dt>
<dd class="defbody">
Enable/disable proxy session management. Proxy session management 
associates the <i>originating</i> IP address of the client to the 
session rather than the <i>proxy</i> IP address. Default is false.
</dd>
<dt><strong>gc</strong>(<var>+When</var>)</dt>
<dd class="defbody">
<var>When</var> is one of <code>active</code>, which starts a thread 
that performs session cleanup at close to the moment of the timeout or <code>passive</code>, 
which runs session GC when a new session is created.
</dd>
<dt><strong>samesite</strong>(<var>+Restriction</var>)</dt>
<dd class="defbody">
One of <code>none</code>, <code>lax</code> (default), or <code>strict</code> 
- The SameSite attribute prevents the CSRF vulnerability. strict has 
best security, but prevents links from external sites from operating 
properly. lax stops most CSRF attacks against REST endpoints but rarely 
interferes with legitimage operations. <code>none</code> removes the 
samesite attribute entirely. __Caution: The value <code>none</code> 
exposes the entire site to CSRF attacks.
</dd>
<dt><strong>granularity</strong>(<var>+Integer</var>)</dt>
<dd class="defbody">
Granularity for updating that the session is active. Default is 60 
(seconds). Smaller values lead to more precise session timeout at the 
cost of more database updates. This may notably a problem when using 
Redis.
</dd>
</dl>

<p>In addition, extension libraries can define <span class="pred-ext">session_option/2</span> 
to make this predicate support more options. In particular,
<code>library(http/http_redis_plugin)</code> defines the following 
additional options:

<dl class="latex">
<dt><strong>redis_db</strong>(<var>+DB</var>)</dt>
<dd class="defbody">
Alias name of the redis database to access. See <span class="pred-ext">redis_server/3</span>.
</dd>
<dt><strong>redis_ro</strong>(<var>+DB</var>)</dt>
<dd class="defbody">
Alias name of the redis database for read-only access. See
<span class="pred-ext">redis_server/3</span>.
</dd>
<dt><strong>redis_prefix</strong>(<var>+Atom</var>)</dt>
<dd class="defbody">
Prefix to use for all HTTP session related keys. Default is
<code>'swipl:http:session'</code>
</dd>
</dl>

</dd>
<dt class="pubdef"><span class="pred-tag">[nondet]</span><a id="http_session_option/1"><strong>http_session_option</strong>(<var>?Option</var>)</a></dt>
<dd class="defbody">
True if <var>Option</var> is a current option of the session system.</dd>
<dt class="pubdef"><span class="pred-tag">[semidet]</span><a id="session_setting/2"><strong>session_setting</strong>(<var>+SessionID, 
?Setting</var>)</a></dt>
<dd class="defbody">
Find setting for <var>SessionID</var>. It is possible to overrule some 
session settings using <code>http_session_set(Setting)</code>.</dd>
<dt class="pubdef"><span class="pred-tag">[det]</span><a id="http_set_session/1"><strong>http_set_session</strong>(<var>Setting</var>)</a></dt>
<dt class="pubdef"><span class="pred-tag">[det]</span><a id="http_set_session/2"><strong>http_set_session</strong>(<var>SessionId, 
Setting</var>)</a></dt>
<dd class="defbody">
Overrule a setting for the current or specified session. Currently, the 
only setting that can be overruled is <code>timeout</code>.

<dl class="tags">
<dt class="tag">Errors</dt>
<dd>
<code>permission_error(set, http_session, Setting)</code> if setting a 
setting that is not supported on per-session basis.
</dd>
</dl>

</dd>
<dt class="pubdef"><span class="pred-tag">[det]</span><a id="http_session_id/1"><strong>http_session_id</strong>(<var>-SessionId</var>)</a></dt>
<dd class="defbody">
True if <var>SessionId</var> is an identifier for the current session.
<table class="arglist">
<tr><td><var>SessionId</var> </td><td>is an atom. </td></tr>
</table>

<dl class="tags">
<dt class="tag">Errors</dt>
<dd>
<code>existence_error(http_session, _)</code>
</dd>
<dt class="tag">See also</dt>
<dd>
<a class="pred" href="#http_in_session/1">http_in_session/1</a> for a 
version that fails if there is no session.
</dd>
</dl>

</dd>
<dt class="pubdef"><span class="pred-tag">[semidet]</span><a id="http_in_session/1"><strong>http_in_session</strong>(<var>-SessionId</var>)</a></dt>
<dd class="defbody">
True if <var>SessionId</var> is an identifier for the current session. 
The current session is extracted from <code>session(ID)</code> from the 
current HTTP request (see <a class="pred" href="#http_current_request/1">http_current_request/1</a>). 
The value is cached in a backtrackable global variable <code>http_session_id</code>. 
Using a backtrackable global variable is safe because continuous worker 
threads use a failure driven loop and spawned threads start without any 
global variables. This variable can be set from the commandline to fake 
running a goal from the commandline in the context of a session.

<dl class="tags">
<dt class="tag">See also</dt>
<dd>
<a class="pred" href="#http_session_id/1">http_session_id/1</a>
</dd>
</dl>

</dd>
<dt class="pubdef"><span class="pred-tag">[det]</span><a id="http_open_session/2"><strong>http_open_session</strong>(<var>-SessionID, 
+Options</var>)</a></dt>
<dd class="defbody">
Establish a new session. This is normally used if the create option is 
set to <code>noauto</code>. <var>Options</var>:

<dl class="latex">
<dt><strong>renew</strong>(<var>+Boolean</var>)</dt>
<dd class="defbody">
If <code>true</code> (default <code>false</code>) and the current 
request is part of a session, generate a new session-id. By default, 
this predicate returns the current session as obtained with
<a class="pred" href="#http_in_session/1">http_in_session/1</a>.
</dd>
</dl>

<dl class="tags">
<dt class="tag">Errors</dt>
<dd>
<code>permission_error(open, http_session, CGI)</code> if this call is 
used after closing the CGI header.</dd>
<dt class="mtag">See also</dt>
<dd>
- <a class="pred" href="#http_set_session_options/1">http_set_session_options/1</a> 
to control the <code>create</code> option. <br>
- <a class="pred" href="#http_close_session/1">http_close_session/1</a> 
for closing the session.
</dd>
</dl>

</dd>
<dt class="pubdef"><span class="pred-tag">[det]</span><a id="http_session_asserta/1"><strong>http_session_asserta</strong>(<var>+Data</var>)</a></dt>
<dt class="pubdef"><span class="pred-tag">[det]</span><a id="http_session_assert/1"><strong>http_session_assert</strong>(<var>+Data</var>)</a></dt>
<dt class="pubdef"><span class="pred-tag">[nondet]</span><a id="http_session_retract/1"><strong>http_session_retract</strong>(<var>?Data</var>)</a></dt>
<dt class="pubdef"><span class="pred-tag">[det]</span><a id="http_session_retractall/1"><strong>http_session_retractall</strong>(<var>?Data</var>)</a></dt>
<dd class="defbody">
Versions of <span class="pred-ext">assert/1</span>, <span class="pred-ext">retract/1</span> 
and <span class="pred-ext">retractall/1</span> that associate data with 
the current HTTP session.</dd>
<dt class="pubdef"><span class="pred-tag">[nondet]</span><a id="http_session_data/1"><strong>http_session_data</strong>(<var>?Data</var>)</a></dt>
<dd class="defbody">
True if <var>Data</var> is associated using <a class="pred" href="#http_session_assert/1">http_session_assert/1</a> 
to the current HTTP session.

<dl class="tags">
<dt class="tag">Errors</dt>
<dd>
<code>existence_error(http_session,_)</code>
</dd>
</dl>

</dd>
<dt class="pubdef"><span class="pred-tag">[det]</span><a id="http_session_asserta/2"><strong>http_session_asserta</strong>(<var>+Data, 
+SessionID</var>)</a></dt>
<dt class="pubdef"><span class="pred-tag">[det]</span><a id="http_session_assert/2"><strong>http_session_assert</strong>(<var>+Data, 
+SessionID</var>)</a></dt>
<dt class="pubdef"><span class="pred-tag">[nondet]</span><a id="http_session_retract/2"><strong>http_session_retract</strong>(<var>?Data, 
+SessionID</var>)</a></dt>
<dt class="pubdef"><span class="pred-tag">[det]</span><a id="http_session_retractall/2"><strong>http_session_retractall</strong>(<var>@Data, 
+SessionID</var>)</a></dt>
<dt class="pubdef"><span class="pred-tag">[det]</span><a id="http_session_data/2"><strong>http_session_data</strong>(<var>?Data, 
+SessionID</var>)</a></dt>
<dd class="defbody">
Versions of <span class="pred-ext">assert/1</span>, <span class="pred-ext">retract/1</span> 
and <span class="pred-ext">retractall/1</span> that associate data with 
an explicit HTTP session.

<dl class="tags">
<dt class="tag">See also</dt>
<dd>
<a class="pred" href="#http_current_session/2">http_current_session/2</a>.
</dd>
</dl>

</dd>
<dt class="pubdef"><span class="pred-tag">[nondet]</span><a id="http_current_session/2"><strong>http_current_session</strong>(<var>?SessionID, 
?Data</var>)</a></dt>
<dd class="defbody">
Enumerate the current sessions and associated data. There are two <i>pseudo</i> 
data elements:

<dl class="latex">
<dt><strong>idle</strong>(<var>Seconds</var>)</dt>
<dd class="defbody">
Session has been idle for <var>Seconds</var>.
</dd>
<dt><strong>peer</strong>(<var>Peer</var>)</dt>
<dd class="defbody">
<var>Peer</var> of the connection.
</dd>
</dl>

</dd>
<dt class="pubdef"><span class="pred-tag">[det]</span><a id="http_close_session/1"><strong>http_close_session</strong>(<var>+SessionID</var>)</a></dt>
<dd class="defbody">
Closes an HTTP session. This predicate can be called from any thread to 
terminate a session. It uses the <span class="pred-ext">broadcast/1</span> 
service with the message below.

<pre class="code">
http_session(end(SessionId, Peer))
</pre>

<p>The broadcast is done <b>before</b> the session data is destroyed and 
the listen-handlers are executed in context of the session that is being 
closed. Here is an example that destroys a Prolog thread that is 
associated to a thread:

<pre class="code">
:- listen(http_session(end(SessionId, _Peer)),
          kill_session_thread(SessionID)).

kill_session_thread(SessionID) :-
        http_session_data(thread(ThreadID)),
        thread_signal(ThreadID, throw(session_closed)).
</pre>

<p>Succeed without any effect if <var>SessionID</var> does not refer to 
an active session.

<p>If <a class="pred" href="#http_close_session/1">http_close_session/1</a> 
is called from a handler operating in the current session and the CGI 
stream is still in state
<code>header</code>, this predicate emits a <code>Set-Cookie</code> to 
expire the cookie.

<dl class="tags">
<dt class="tag">Errors</dt>
<dd>
<code>type_error(atom, SessionID)</code>
</dd>
<dt class="tag">See also</dt>
<dd>
<span class="pred-ext">listen/2</span> for acting upon closed sessions
</dd>
</dl>

</dd>
<dt class="pubdef"><span class="pred-tag">[det]</span><a id="http_session_cookie/1"><strong>http_session_cookie</strong>(<var>-Cookie</var>)</a></dt>
<dd class="defbody">
Generate a random cookie that can be used by a browser to identify the 
current session. The cookie has the format XXXX-XXXX-XXXX-XXXX[.<var>&lt;</var>route<var>&gt;</var>], 
where XXXX are random hexadecimal numbers and [.<var>&lt;</var>route<var>&gt;</var>] 
is the optionally added routing information.</dd>
<dt class="multidef"><span class="pred-tag">[semidet,multifile]</span><a id="hooked/0"><strong>hooked</strong></a></dt>
<dt class="multidef"><span class="pred-tag">[multifile]</span><a id="hook/1"><strong>hook</strong>(<var>+Goal</var>)</a></dt>
<dd class="defbody">
These multifile predicates may be used to hook the data storage of this 
library. An example is implemented by
<code>library(http/http_redis_plugin)</code>, storing all session data 
in a redis database.
</dd>
</dl>

<p><h3 id="sec:httpcors"><a id="sec:3.6"><span class="sec-nr">3.6</span> <span class="sec-title">library(http/http_cors): 
Enable CORS: Cross-Origin Resource Sharing</span></a></h3>

<p><a id="sec:httpcors"></a>

<dl class="tags">
<dt class="mtag">See also</dt>
<dd>
- <a class="url" href="http://en.wikipedia.org/wiki/Cross-site_scripting">http://en.wikipedia.org/wiki/Cross-site_scripting</a> 
for understanding Cross-site scripting. <br>
- <a class="url" href="http://www.w3.org/TR/cors/">http://www.w3.org/TR/cors/</a> 
for understanding CORS
</dd>
</dl>

<p>This small module allows for enabling Cross-Origin Resource Sharing 
(CORS) for a specific request. Typically, CORS is enabled for API 
services that you want to have useable from browser client code that is 
loaded from another domain. An example are the LOD and SPARQL services 
in ClioPatria.

<p>Because CORS is a security risc (see references), it is disabled by 
default. It is enabled through the setting http:cors. The value of this 
setting is a list of domains that are allowed to access the service. 
Because * is used as a wildcard match, the value [*] allows access from 
anywhere.

<p>Services for which CORS is relevant must call <a class="pred" href="#cors_enable/0">cors_enable/0</a> 
as part of the HTTP response, as shown below. Note that <a class="pred" href="#cors_enable/0">cors_enable/0</a> 
is a no-op if the setting http:cors is set to the empty list (<code>[]</code>).

<pre class="code">
my_handler(Request) :-
      ....,
      cors_enable,
      reply_json(Response, []).
</pre>

<p>If a site uses a <i>Preflight</i> <code>OPTIONS</code> request to 
find the server's capabilities and access politics, <a class="pred" href="#cors_enable/2">cors_enable/2</a> 
can be used to formulate an appropriate reply. For example:

<pre class="code">
my_handler(Request) :-
      option(method(options), Request), !,
      cors_enable(Request,
                  [ methods([get,post,delete])
                  ]),
      format('~n').                           % 200 with empty body
</pre>

<dl class="latex">
<dt class="pubdef"><span class="pred-tag">[det]</span><a id="cors_enable/0"><strong>cors_enable</strong></a></dt>
<dd class="defbody">
Emit the HTTP header <code>Access-Control-Allow-Origin</code> using 
domains from the setting http:cors. This this setting is <code>[]</code> 
(default), nothing is written. This predicate is typically used for 
replying to API HTTP-request (e.g., replies to an AJAX request that 
typically serve JSON or XML).</dd>
<dt class="pubdef"><span class="pred-tag">[det]</span><a id="cors_enable/2"><strong>cors_enable</strong>(<var>+Request, 
+Options</var>)</a></dt>
<dd class="defbody">
CORS reply to a <i>Preflight</i> <code>OPTIONS</code> request. <var>Request</var> 
is the HTTP request. <var>Options</var> provides:

<dl class="latex">
<dt><strong>methods</strong>(<var>+List</var>)</dt>
<dd class="defbody">
<var>List</var> of supported HTTP methods. The default is <code>GET</code>, 
only allowing for read requests.
</dd>
<dt><strong>headers</strong>(<var>+List</var>)</dt>
<dd class="defbody">
<var>List</var> of headers the client asks for and we allow. The default 
is to simply echo what has been requested for.
</dd>
</dl>

<p>Both methods and headers may use Prolog friendly syntax, e.g.,
<code>get</code> for a method and <code>content_type</code> for a 
header.

<dl class="tags">
<dt class="tag">See also</dt>
<dd>
<a class="url" href="http://www.html5rocks.com/en/tutorials/cors/">http://www.html5rocks.com/en/tutorials/cors/</a>
</dd>
</dl>

</dd>
</dl>

<p><h3 id="sec:httpauthenticate"><a id="sec:3.7"><span class="sec-nr">3.7</span> <span class="sec-title">library(http/http_authenticate): 
Authenticate HTTP connections using 401 headers</span></a></h3>

<p><a id="sec:httpauthenticate"></a>

<p>This module provides the basics to validate an HTTP <code>Authorization</code> 
header. User and password information are read from a Unix/Apache 
compatible password file.

<p>This library provides, in addition to the HTTP authentication, 
predicates to read and write password files.

<dl class="latex">
<dt class="pubdef"><a id="http_authenticate/3"><strong>http_authenticate</strong>(<var>+Type, 
+Request, -Fields</var>)</a></dt>
<dd class="defbody">
True if <var>Request</var> contains the information to continue 
according to <var>Type</var>. <var>Type</var> identifies the required 
authentication technique:

<dl class="latex">
<dt><strong>basic</strong>(<var>+PasswordFile</var>)</dt>
<dd class="defbody">
Use HTTP <code>Basic</code> authetication and verify the password from <var>PasswordFile</var>. <var>PasswordFile</var> 
is a file holding usernames and passwords in a format compatible to Unix 
and Apache. Each line is record with <code>:</code> separated fields. 
The first field is the username and the second the password <i>hash</i>. 
Password hashes are validated using <span class="pred-ext">crypt/2</span>.
</dd>
</dl>

<p>Successful authorization is cached for 60 seconds to avoid overhead 
of decoding and lookup of the user and password data.

<p><a class="pred" href="#http_authenticate/3">http_authenticate/3</a> 
just validates the header. If authorization is not provided the browser 
must be challenged, in response to which it normally opens a 
user-password dialogue. Example code realising this is below. The 
exception causes the HTTP wrapper code to generate an HTTP 401 reply.

<pre class="code">
(   http_authenticate(basic(passwd), Request, Fields)
-&gt;  true
;   throw(http_reply(authorise(basic, Realm)))
).
</pre>

<table class="arglist">
<tr><td><var>Fields</var> </td><td>is a list of fields from the 
password-file entry. The first element is the user. The hash is skipped. </td></tr>
</table>

<dl class="tags">
<dt class="tag">To be done</dt>
<dd>
Should we also cache failures to reduce the risc of DoS attacks?
</dd>
</dl>

</dd>
<dt class="pubdef"><span class="pred-tag">[semidet]</span><a id="http_authorization_data/2"><strong>http_authorization_data</strong>(<var>+AuthorizeText, 
?Data</var>)</a></dt>
<dd class="defbody">
Decode the HTTP <code>Authorization</code> header. <var>Data</var> is a 
term

<pre class="code">
Method(User, Password)
</pre>

<p>where Method is the (downcased) authorization method (typically
<code>basic</code>), User is an atom holding the user name and Password 
is a list of codes holding the password</dd>
<dt class="pubdef"><span class="pred-tag">[nondet]</span><a id="http_current_user/3"><strong>http_current_user</strong>(<var>+File, 
?User, ?Fields</var>)</a></dt>
<dd class="defbody">
True when <var>User</var> is present in the htpasswd file <var>File</var> 
and <var>Fields</var> provides the additional fields.
<table class="arglist">
<tr><td><var>Fields</var> </td><td>are the fields from the password file <var>File</var>, 
converted using <span class="pred-ext">name/2</span>, which means that 
numeric values are passed as numbers and other fields as atoms. The 
password hash is the first element of <var>Fields</var> and is a string. </td></tr>
</table>
</dd>
<dt class="pubdef"><span class="pred-tag">[det]</span><a id="http_read_passwd_file/2"><strong>http_read_passwd_file</strong>(<var>+Path, 
-Data</var>)</a></dt>
<dd class="defbody">
Read a password file. <var>Data</var> is a list of terms of the format 
below, where User is an atom identifying the user, Hash is a string 
containing the salted password hash and Fields contain additional 
fields. The string value of each field is converted using <span class="pred-ext">name/2</span> 
to either a number or an atom.

<pre class="code">
passwd(User, Hash, Fields)
</pre>

</dd>
<dt class="pubdef"><span class="pred-tag">[det]</span><a id="http_write_passwd_file/2"><strong>http_write_passwd_file</strong>(<var>+File, 
+Data:list</var>)</a></dt>
<dd class="defbody">
Write password data <var>Data</var> to <var>File</var>. <var>Data</var> 
is a list of entries as below. See <a class="pred" href="#http_read_passwd_file/2">http_read_passwd_file/2</a> 
for details.

<pre class="code">
passwd(User, Hash, Fields)
</pre>

<dl class="tags">
<dt class="tag">To be done</dt>
<dd>
Write to a new file and atomically replace the old one.
</dd>
</dl>

</dd>
<dt class="multidef"><span class="pred-tag">[multifile]</span><a id="http:authenticate/3"><span class="module">http</span>:<strong>authenticate</strong>(<var>+AuthData, 
+Request, -Fields</var>)</a></dt>
<dd class="defbody">
Plugin for <code>library(http_dispatch)</code> to perform basic HTTP 
authentication.

<p>This predicate throws <code>http_reply(authorise(basic, Realm))</code>.
<table class="arglist">
<tr><td><var>AuthData</var> </td><td>must be a term <code>basic(File, Realm)</code> </td></tr>
<tr><td><var>Request</var> </td><td>is the HTTP request </td></tr>
<tr><td><var>Fields</var> </td><td>describes the authenticated user with 
the option
<code>user(User)</code> and with the option <code>user_details(Fields)</code> 
if the password file contains additional fields after the user and 
password. </td></tr>
</table>
</dd>
</dl>

<p><h3 id="sec:httpdigest"><a id="sec:3.8"><span class="sec-nr">3.8</span> <span class="sec-title">library(http/http_digest): 
HTTP Digest authentication</span></a></h3>

<p><a id="sec:httpdigest"></a>

<dl class="tags">
<dt class="tag">See also</dt>
<dd>
<a class="url" href="https://tools.ietf.org/html/rfc2617">https://tools.ietf.org/html/rfc2617</a>
</dd>
</dl>

<p>This library implements HTTP <i>Digest Authentication</i> as per 
RFC2617. Unlike <i>Basic Authentication</i>, digest authentication is 
based on challenge-reponse and therefore does not need to send the 
password over the (insecure) connection. In addition, it provides a 
count mechanism that ensure that old credentials cannot be reused, which 
prevents attackers from using old credentials with a new request. Digest 
authentication have the following advantages and disadvantages:

<p>
<ul class="latex">
<li>Advantages

<p>
<ul class="compact">
<li>Authentication without exchanging the password
<li>No re-use of authentication data
</ul>

<p>
<li>Disadvantages

<p>
<ul class="latex">
<li>An extra round trip is needed for the first authentication
<li>Server-side storage of the password is the MD5 hash of the user, <i>realm</i> 
and password. As MD5 hashes are quick to compute, one needs strong 
passwords. This fixed algorithm also allows for <i>rainbow table</i> 
attacks, although their value is limited because you need to precompute 
the rainbow table for every server (<i>realm</i>) and user.
<li>The connection is sensitive to man-in-the-middle attack, where the 
attacker can both change the request and response.
<li>Both client and server need to keep an administration of issued <i>nonce</i> 
values and associated <i>nonce count</i> values.
</ul>
</ul>

<p>And, of course, the connection itself remains insecure. Digest based 
authentication is a viable alternative if HTTPS is not a good option and 
security of the data itself is not an issue.

<p>This library acts as plugin for <code>library(http/http_dispatch)</code>, 
where the registered handler (<a class="pred" href="#http_handler/3">http_handler/3</a>) 
can be given the option below to initiate digest authentication.

<p>
<ul class="compact">
<li><code>authentication(digest(PasswdFile, Realm))</code>
</ul>

<p>Above, <var>PasswdFile</var> is a file containing lines of the from 
below, where PasswordHash is computed using <a class="pred" href="#http_digest_password_hash/4">http_digest_password_hash/4</a>. 
See also
<code>library(http/http_authenticate)</code>, <a class="pred" href="#http_read_passwd_file/2">http_read_passwd_file/2</a> 
and
<a class="pred" href="#http_write_passwd_file/2">http_write_passwd_file/2</a>.

<pre class="code">
User ":" PasswordHash (":" Extra)*
</pre>

<p>This library also hooks into <code>library(http/http_open)</code> if 
the option
<code>authorization(digest(User, Password))</code> is given.

<dl class="latex">
<dt class="pubdef"><a id="http_digest_challenge//2"><strong>http_digest_challenge</strong>(<var>+Realm, 
+Options</var>)</a><code>//</code></dt>
<dd class="defbody">
Generate the content for a 401 <code>WWW-Authenticate: Digest</code> 
header field.</dd>
<dt class="pubdef"><span class="pred-tag">[det]</span><a id="http_parse_digest_challenge/2"><strong>http_parse_digest_challenge</strong>(<var>+Challenge, 
-Fields</var>)</a></dt>
<dd class="defbody">
Parse the value of an HTTP <code>WWW-Authenticate</code> header into a 
list of Name(Value) terms.</dd>
<dt class="pubdef"><a id="http_digest_response/5"><strong>http_digest_response</strong>(<var>+Challenge, 
+User, +Password, -Reply, +Options</var>)</a></dt>
<dd class="defbody">
Formulate a reply to a digest authentication request. <var>Options</var>:

<dl class="latex">
<dt><strong>path</strong>(<var>+Path</var>)</dt>
<dd class="defbody">
The request URI send along with the authentication. Defaults to <code>/</code>
</dd>
<dt><strong>method</strong>(<var>+Method</var>)</dt>
<dd class="defbody">
The HTTP method. Defaults to <code>'GET'</code>
</dd>
<dt><strong>nc</strong>(<var>+Integer</var>)</dt>
<dd class="defbody">
The nonce-count as an integer. This is formatted as an 8 hex-digit 
string.
</dd>
</dl>

<table class="arglist">
<tr><td><var>Challenge</var> </td><td>is a list Name(Value), normally 
from
<a class="pred" href="#http_parse_digest_challenge/2">http_parse_digest_challenge/2</a>. 
Must contain
<code>realm</code> and <code>nonce</code>. Optionally contains
<code>opaque</code>. </td></tr>
<tr><td><var>User</var> </td><td>is the user we want to authenticated </td></tr>
<tr><td><var>Password</var> </td><td>is the user's password </td></tr>
<tr><td><var>Options</var> </td><td>provides additional options </td></tr>
</table>
</dd>
<dt class="pubdef"><span class="pred-tag">[det]</span><a id="http_digest_password_hash/4"><strong>http_digest_password_hash</strong>(<var>+User, 
+Realm, +Password, -Hash</var>)</a></dt>
<dd class="defbody">
Compute the password hash for the HTTP password file. Note that the HTTP 
digest mechanism does allow us to use a seeded expensive arbitrary hash 
function. Instead, the hash is defined as the MD5 of the following 
components:

<pre class="code">
&lt;user&gt;:&lt;realm&gt;:&lt;password&gt;.
</pre>

<p>The inexpensive MD5 algorithm makes the hash sensitive to brute force 
attacks while the lack of seeding make the hashes sensitive for <i>rainbow 
table</i> attacks, although the value is somewhat limited because the <i>realm</i> 
and <i>user</i> are part of the hash.</dd>
<dt class="multidef"><span class="pred-tag">[multifile]</span><a id="http:authenticate/3"><span class="module">http</span>:<strong>authenticate</strong>(<var>+Digest, 
+Request, -Fields</var>)</a></dt>
<dd class="defbody">
Plugin for <code>library(http_dispatch)</code> to perform basic HTTP 
authentication. Note that we keep the authentication details cached to 
avoid a&lsquo;nonce-replay&rsquo;error in the case that the application 
tries to verify multiple times.

<p>This predicate throws <code>http_reply(authorise(digest(Digest)))</code>
<table class="arglist">
<tr><td><var>Digest</var> </td><td>is a term <code>digest(File, Realm, Options)</code> </td></tr>
<tr><td><var>Request</var> </td><td>is the HTTP request </td></tr>
<tr><td><var>Fields</var> </td><td>describes the authenticated user with 
the option
<code>user(User)</code> and with the option <code>user_details(Fields)</code> 
if the password file contains additional fields after the user and 
password. </td></tr>
</table>
</dd>
<dt class="multidef"><span class="pred-tag">[semidet,multifile]</span><a id="http:authenticate_client/2"><span class="module">http</span>:<strong>authenticate_client</strong>(<var>+URL, 
+Action</var>)</a></dt>
<dd class="defbody">
This hooks is called by <a class="pred" href="#http_open/3">http_open/3</a> 
with the following <var>Action</var> value:

<dl class="latex">
<dt><strong>send_auth_header</strong>(<var>+AuthData, +Out, +Options</var>)</dt>
<dd class="defbody">
Called when sending the initial request. <var>AuthData</var> contains 
the value for the <a class="pred" href="#http_open/3">http_open/3</a> 
option <code>authorization(AuthData)</code> and <var>Out</var> is a 
stream on which to write additional HTTP headers.
</dd>
<dt><strong>auth_reponse</strong>(<var>+Headers, +OptionsIn, -Options</var>)</dt>
<dd class="defbody">
Called if the server replies with a 401 code, challenging the client. 
Our implementation adds a
<code>request_header(authorization=Digest)</code> header to <var>Options</var>, 
causing
<a class="pred" href="#http_open/3">http_open/3</a> to retry the request 
with the additional option.
</dd>
</dl>

</dd>
</dl>

<p><h3 id="sec:httpdynworkers"><a id="sec:3.9"><span class="sec-nr">3.9</span> <span class="sec-title">library(http/http_dyn_workers): 
Dynamically schedule HTTP workers.</span></a></h3>

<p><a id="sec:httpdynworkers"></a>

<p>Most code doesn't need to use this directly; instead use
<code>library(http/http_server)</code>, which combines this library with 
the typical HTTP libraries that most servers need.

<p>This module defines hooks into the HTTP framework to dynamically 
schedule worker threads. Dynamic scheduling relieves us from finding a 
good value for the size of the HTTP worker pool.

<p>The decision to add a worker follows these rules:

<p>
<ul class="latex">
<li>If the load average caused by the worker threads exceeds 
http:max_load, no worker is added.
<li>Wait for some time, depending on how close we are to the 
http:max_workers limit.

<p>
<ul class="compact">
<li>If the worker is still needed, add it.
</ul>
</ul>

<p>The policy depends on three settings:

<dl class="latex">
<dt><var><code>http</code></var><strong><code>:</code></strong><var><code>max_workers</code></var></dt>
<dd class="defbody">
The maximum number of workers that will be created. Default is 100.
</dd>
<dt><var><code>http</code></var><strong><code>:</code></strong><var><code>worker_idle_limit</code></var></dt>
<dd class="defbody">
The number of seconds a dynamic worker waits for a new job. If no job 
arrives in time it terminates. Default is 10 seconds.
</dd>
<dt><var><code>http</code></var><strong><code>:</code></strong><var><code>max_load</code></var></dt>
<dd class="defbody">
Max load average created by <b>the HTTP server</b>, i.e. the amount of 
CPU time consumed per second. Default is 10.
</dd>
</dl>

<dl class="latex">
<dt class="multidef"><span class="pred-tag">[multifile]</span><a id="http:schedule_workers/1"><span class="module">http</span>:<strong>schedule_workers</strong>(<var>+Dict</var>)</a></dt>
<dd class="defbody">
Called if there is no immediately free worker to handle the incomming 
request. The request is forwarded to the thread
<code>__http_scheduler</code> as the hook is called in time critical 
code.
</dd>
</dl>

<p><h4 id="sec:http-sse"><a id="sec:3.9.1"><span class="sec-nr">3.9.1</span> <span class="sec-title">Providing 
Server-Sent Events (sse)</span></a></h4>

<a id="sec:http-sse"></a>

<p><a class="url" href="https://developer.mozilla.org/en-US/docs/Web/API/Server-sent_events/Using_server-sent_events">Server-Sent 
Events</a> allows for setting up a simple event stream from the server 
to the client. It can serve roles similar to <em>long polling</em> and <em>web 
sockets</em>, enabling the server to notify its clients on some event. <em>Long 
polling</em> uses a normal HTTP (usually) GET request that blocks for a 
long time on the server. The server finishes the request when it wants 
to notify the client or after some time (e.g., a minute) to avoid a 
timeout on the client or some proxy. After receiving an event or 
timeout, the client repeats the request.
<em>Web sockets</em> <em>upgrade</em> a the socket used for a normal 
HTTP request to create a bi-directional open communication channel that 
exchanges encapsulated messages in both directions. <em>Server-Sent 
Events</em> open a normal HTTP channel over which the server can sent 
simple text messages using a format similar to the HTTP header: a 
sequence of <i>Name: Value</i> lines followed by two newlines. Unlike 
long polling, the request does not complete after a message.

<p>Following the MDN documentation above, and SSE request can be served 
using the simple example below that generates an event, counting every 
minute. Note the handler declaration that processes the request on a new 
thread and disables timeout for this location. Note that this 
implementation uses a thread per client. This design limits the 
scalability.

<pre class="code">
:- http_handler(root(events), events,
                [ spawn([]),
                  time_limit(infinite)
                ]).

events(_Request) :-
    format('X-Accel-Buffering: no\r\n\c
            Content-Type: text/event-stream\r\n\c
            Cache-Control: no-cache\r\n\r\n'),

    between(1, infinite, Min),
        format('event: minute~n'),
        format('data: {"minute": ~d}~n~n', [Min]),
        flush_output,
        sleep(60),
        fail.
</pre>

<p>Of course, rather than <a id="idx:sleep1:18"></a><span class="pred-ext">sleep/1</span> 
to decide when to fire the next event this thread typically has to wait 
for events in the application. This can be achieved using <a id="idx:threadwait2:19"></a><span class="pred-ext">thread_wait/2</span> 
or message queues.

<p><h3 id="sec:http-custom-error-page"><a id="sec:3.10"><span class="sec-nr">3.10</span> <span class="sec-title">Custom 
Error Pages</span></a></h3>

<a id="sec:http-custom-error-page"></a>

<p>It is possible to create arbitrary error pages for responses 
generated when a http_reply term is thrown. Currently this is only 
supported for status 403 (<i>authentication required</i>). To do this, 
instead of throwing <code>http_reply(authorise(Term))</code> throw
<code>http_reply(authorise(Term), [], Key)</code>, where <var>Key</var> 
is an arbitrary term relating to the page you want to generate. You must 
then also define a clause of the multifile predicate <a id="idx:httpstatuspagehook3:20"></a><a class="pred" href="#http:status_page_hook/3">http:status_page_hook/3</a>:

<dl class="latex">
<dt class="pubdef"><a id="http:status_page_hook/3"><strong>http:status_page_hook</strong>(<var>+TermOrCode, 
+Context, -CustomHTML</var>)</a></dt>
<dd class="defbody">
TermOrCode is either the first argument of the <code>http_reply</code> 
exception or the HTTP status code, i.e., the hook is called twice. New 
code should using the <var>Term</var>. Context is the third argument of 
the http_reply exception which was thrown, and CustomHTML is a list of 
HTML tokens. A page equivalent to the default page for 401 is generated 
by the example below.

<pre class="code">
:- multifile http:status_page_hook/3.

http:status_page_hook(authorise(Term), _Context, HTML) :-
    phrase(page([ title('401 Authorization Required')
                ],
                [ h1('Authorization Required'),
                  p(['This server could not verify that you ',
                     'are authorized to access the document ',
                     'requested.  Either you supplied the wrong ',
                     'credentials (e.g., bad password), or your ',
                     'browser doesn\'t understand how to supply ',
                     'the credentials required.'
                     ]),
                  \address
                ]),
           HTML).
</pre>

<p></dd>
</dl>

<p><h3 id="sec:httpopenid"><a id="sec:3.11"><span class="sec-nr">3.11</span> <span class="sec-title">library(http/http_openid): 
OpenID consumer and server library</span></a></h3>

<p><a id="sec:httpopenid"></a>

<p>This library implements the OpenID protocol (<a class="url" href="http://openid.net/)">http://openid.net/)</a>. 
OpenID is a protocol to share identities on the network. The protocol 
itself uses simple basic HTTP, adding reliability using digitally signed 
messages.

<p>Steps, as seen from the <i>consumer</i> (or <i>relying partner</i>).

<p>
<ol class="latex">
<li>Show login form, asking for <code>openid_identifier</code>
<li>Get HTML page from <code>openid_identifier</code> and lookup
<code>&lt;link rel="openid.server" href="server"&gt;</code>
<li>Associate to <i>server</i>
<li>Redirect browser (302) to server using mode <code>checkid_setup</code>, 
asking to validate the given OpenID.
<li>OpenID server redirects back, providing digitally signed 
conformation of the claimed identity.
<li>Validate signature and redirect to the target location.
</ol>

<p>A <b>consumer</b> (an application that allows OpenID login) typically 
uses this library through <a class="pred" href="#openid_user/3">openid_user/3</a>. 
In addition, it must implement the hook http_openid:<code>openid_hook(trusted(OpenId, Server))</code> 
to define accepted OpenID servers. Typically, this hook is used to 
provide a white-list of acceptable servers. Note that accepting any 
OpenID server is possible, but anyone on the internet can setup a dummy 
OpenID server that simply grants and signs every request. Here is an 
example:

<pre class="code">
:- multifile http_openid:openid_hook/1.

http_openid:openid_hook(trusted(_, OpenIdServer)) :-
    (   trusted_server(OpenIdServer)
    -&gt;  true
    ;   throw(http_reply(moved_temporary('/openid/trustedservers')))
    ).

trusted_server('http://www.myopenid.com/server').
</pre>

<p>By default, information who is logged on is maintained with the 
session using <a class="pred" href="#http_session_assert/1">http_session_assert/1</a> 
with the term <code>openid(Identity)</code>. The hooks 
login/logout/logged_in can be used to provide alternative administration 
of logged-in users (e.g., based on client-IP, using cookies, etc.).

<p>To create a <b>server</b>, you must do four things: bind the handlers
<a class="pred" href="#openid_server/2">openid_server/2</a> and <a class="pred" href="#openid_grant/1">openid_grant/1</a> 
to HTTP locations, provide a user-page for registered users and define 
the <code>grant(Request, Options)</code> hook to verify your users. An 
example server is provided in in
<var>&lt;</var>plbase<var>&gt;</var>/<code>doc/packages/examples/demo_openid.pl</code>

<dl class="latex">
<dt class="multidef"><span class="pred-tag">[multifile]</span><a id="openid_hook/1"><strong>openid_hook</strong>(<var>+Action</var>)</a></dt>
<dd class="defbody">
Call hook on the OpenID management library. Defined hooks are:

<dl class="latex">
<dt><strong>login</strong>(<var>+OpenID</var>)</dt>
<dd class="defbody">
Consider <var>OpenID</var> logged in.
</dd>
<dt><strong>logout</strong>(<var>+OpenID</var>)</dt>
<dd class="defbody">
Logout <var>OpenID</var>
</dd>
<dt><strong>logged_in</strong>(<var>?OpenID</var>)</dt>
<dd class="defbody">
True if <var>OpenID</var> is logged in
</dd>
<dt><strong>grant</strong>(<var>+Request, +Options</var>)</dt>
<dd class="defbody">
Server: Reply positive on OpenID
</dd>
<dt><strong>trusted</strong>(<var>+OpenID, +Server</var>)</dt>
<dd class="defbody">
True if <var>Server</var> is a trusted <var>OpenID</var> server
</dd>
<dt><strong>ax</strong>(<var>Values</var>)</dt>
<dd class="defbody">
Called if the server provided AX attributes
</dd>
<dt><strong>x_parameter</strong>(<var>+Server, -Name, -Value</var>)</dt>
<dd class="defbody">
Called to find additional HTTP parameters to send with the OpenID verify 
request.
</dd>
</dl>

</dd>
<dt class="pubdef"><span class="pred-tag">[det]</span><a id="openid_login/1"><strong>openid_login</strong>(<var>+OpenID</var>)</a></dt>
<dd class="defbody">
Associate the current HTTP session with <var>OpenID</var>. If another
<var>OpenID</var> is already associated, this association is first 
removed.</dd>
<dt class="pubdef"><span class="pred-tag">[det]</span><a id="openid_logout/1"><strong>openid_logout</strong>(<var>+OpenID</var>)</a></dt>
<dd class="defbody">
Remove the association of the current session with any <var>OpenID</var></dd>
<dt class="pubdef"><span class="pred-tag">[semidet]</span><a id="openid_logged_in/1"><strong>openid_logged_in</strong>(<var>-OpenID</var>)</a></dt>
<dd class="defbody">
True if session is associated with <var>OpenID</var>.</dd>
<dt class="pubdef"><span class="pred-tag">[det]</span><a id="openid_user/3"><strong>openid_user</strong>(<var>+Request:http_request, 
-OpenID:url, +Options</var>)</a></dt>
<dd class="defbody">
True if <var>OpenID</var> is a validated <var>OpenID</var> associated 
with the current session. The scenario for which this predicate is 
designed is to allow an HTTP handler that requires a valid login to use 
the transparent code below.

<pre class="code">
handler(Request) :-
      openid_user(Request, OpenID, []),
      ...
</pre>

<p>If the user is not yet logged on a sequence of redirects will follow:

<p>
<ol class="latex">
<li>Show a page for login (default: page /openid/login), predicate <span class="pred-ext">reply_openid_login/1</span>)
<li>By default, the <var>OpenID</var> login page is a form that is 
submitted to the <code>verify</code>, which calls <a class="pred" href="#openid_verify/2">openid_verify/2</a>.
<li><a class="pred" href="#openid_verify/2">openid_verify/2</a> does the 
following:

<p>
<ul class="compact">
<li>Find the <var>OpenID</var> claimed identity and server
<li>Associate to the <var>OpenID</var> server
<li>redirects to the <var>OpenID</var> server for validation
</ul>

<p>
<li>The <var>OpenID</var> server will redirect here with the 
authetication information. This is handled by <a class="pred" href="#openid_authenticate/4">openid_authenticate/4</a>.
</ol>

<p><var>Options</var>:

<dl class="latex">
<dt><strong>login_url</strong>(<var>Login</var>)</dt>
<dd class="defbody">
(Local) URL of page to enter <var>OpenID</var> information. Default is 
the handler for <span class="pred-ext">openid_login_page/1</span>
</dd>
</dl>

<dl class="tags">
<dt class="tag">See also</dt>
<dd>
<a class="pred" href="#openid_authenticate/4">openid_authenticate/4</a> 
produces errors if login is invalid or cancelled.
</dd>
</dl>

</dd>
<dt class="pubdef"><span class="pred-tag">[det]</span><a id="openid_login_form//2"><strong>openid_login_form</strong>(<var>+ReturnTo, 
+Options</var>)</a><code>//</code></dt>
<dd class="defbody">
Create the OpenID form. This exported as a separate DCG, allowing 
applications to redefine /openid/login and reuse this part of the page. <var>Options</var> 
processed:

<dl class="latex">
<dt><strong>action</strong>(<var>Action</var>)</dt>
<dd class="defbody">
URL of action to call. Default is the handler calling
<span class="pred-ext">openid_verify/1</span>.
</dd>
<dt><strong>buttons</strong>(<var>+Buttons</var>)</dt>
<dd class="defbody">
<var>Buttons</var> is a list of <code>img</code> structures where the <code>href</code> 
points to an OpenID 2.0 endpoint. These buttons are displayed below the 
OpenID URL field. Clicking the button sets the URL field and submits the 
form. Requires Javascript support.

<p>If the <code>href</code> is <i>relative</i>, clicking it opens the 
given location after adding&rsquo;openid.return_to&rsquo;and&lsquo;stay&rsquo;.
</dd>
<dt><strong>show_stay</strong>(<var>+Boolean</var>)</dt>
<dd class="defbody">
If <code>true</code>, show a checkbox that allows the user to stay 
logged on.
</dd>
</dl>

</dd>
<dt class="pubdef"><a id="openid_verify/2"><strong>openid_verify</strong>(<var>+Options, 
+Request</var>)</a></dt>
<dd class="defbody">
Handle the initial login form presented to the user by the relying party 
(consumer). This predicate discovers the OpenID server, associates 
itself with this server and redirects the user's browser to the OpenID 
server, providing the extra openid.X name-value pairs. <var>Options</var> 
is, against the conventions, placed in front of the <var>Request</var> 
to allow for smooth cooperation with <code>http_dispatch.pl</code>. <var>Options</var> 
processes:

<dl class="latex">
<dt><strong>return_to</strong>(<var>+URL</var>)</dt>
<dd class="defbody">
Specifies where the OpenID provider should return to. Normally, that is 
the current location.
</dd>
<dt><strong>trust_root</strong>(<var>+URL</var>)</dt>
<dd class="defbody">
Specifies the <code>openid.trust_root</code> attribute. Defaults to the 
root of the current server (i.e., <code>http://host[.port]/</code>).
</dd>
<dt><strong>realm</strong>(<var>+URL</var>)</dt>
<dd class="defbody">
Specifies the <code>openid.realm</code> attribute. Default is the
<code>trust_root</code>.
</dd>
<dt><strong>ax</strong>(<var>+Spec</var>)</dt>
<dd class="defbody">
<var>Request</var> the exchange of additional attributes from the 
identity provider. See <span class="pred-ext">http_ax_attributes/2</span> 
for details.
</dd>
</dl>

<p>The OpenId server will redirect to the <code>openid.return_to</code> 
URL.

<dl class="tags">
<dt class="tag">throws</dt>
<dd>
<code>http_reply(moved_temporary(Redirect))</code>
</dd>
</dl>

</dd>
<dt class="pubdef"><span class="pred-tag">[nondet]</span><a id="openid_server/3"><strong>openid_server</strong>(<var>?OpenIDLogin, 
?OpenID, ?Server</var>)</a></dt>
<dd class="defbody">
True if <var>OpenIDLogin</var> is the typed id for <var>OpenID</var> 
verified by
<var>Server</var>.
<table class="arglist">
<tr><td><var>OpenIDLogin</var> </td><td>ID as typed by user (canonized) </td></tr>
<tr><td><var>OpenID</var> </td><td>ID as verified by server </td></tr>
<tr><td><var>Server</var> </td><td>URL of the <var>OpenID</var> server </td></tr>
</table>
</dd>
<dt class="pubdef"><span class="pred-tag">[det]</span><a id="openid_current_url/2"><strong>openid_current_url</strong>(<var>+Request, 
-URL</var>)</a></dt>
<dd class="defbody">
Find the public <var>URL</var> for <var>Request</var> that we can make 
available to our identity provider. This must be an absolute <var>URL</var> 
where we can be contacted. Before trying a configured version through
<a class="pred" href="#http_public_url/2">http_public_url/2</a>, we try 
to see wether the login message contains a referer parameter or wether 
the browser provided one.</dd>
<dt class="pubdef"><a id="openid_current_host/3"><strong>openid_current_host</strong>(<var>Request, 
Host, Port</var>)</a></dt>
<dd class="defbody">
Find current location of the server.

<dl class="tags">
<dt class="tag">deprecated</dt>
<dd>
New code should use <a class="pred" href="#http_current_host/4">http_current_host/4</a> 
with the option <code>global(true)</code>.
</dd>
</dl>

</dd>
<dt class="pubdef"><a id="ssl_verify/5"><strong>ssl_verify</strong>(<var>+SSL, 
+ProblemCert, +AllCerts, +FirstCert, +Error</var>)</a></dt>
<dd class="defbody">
Accept all certificates. We do not care too much. Only the user cares 
s/he is not entering her credentials with a spoofed side. As we 
redirect, the browser will take care of this.</dd>
<dt class="pubdef"><span class="pred-tag">[semidet]</span><a id="openid_authenticate/4"><strong>openid_authenticate</strong>(<var>+Request, 
-Server:url, -OpenID:url, -ReturnTo:url</var>)</a></dt>
<dd class="defbody">
Succeeds if <var>Request</var> comes from the <var>OpenID</var> server 
and confirms that User is a verified <var>OpenID</var> user. <var>ReturnTo</var> 
provides the URL to return to.

<p>After <a class="pred" href="#openid_verify/2">openid_verify/2</a> has 
redirected the browser to the <var>OpenID</var> server, and the <var>OpenID</var> 
server did its magic, it redirects the browser back to this address. The 
work is fairly trivial. If
<code>mode</code> is <code>cancel</code>, the OpenId server denied. If <code>id_res</code>, 
the OpenId server replied positive, but we must verify what the server 
told us by checking the HMAC-SHA signature.

<p>This call fails silently if their is no <code>openid.mode</code> 
field in the request.

<dl class="tags">
<dt class="mtag">throws</dt>
<dd>
- <code>openid(cancel)</code> if request was cancelled by the OpenId 
server <br>
- <code>openid(signature_mismatch)</code> if the HMAC signature check 
failed
</dd>
</dl>

</dd>
<dt class="pubdef"><a id="openid_server/2"><strong>openid_server</strong>(<var>+Options, 
+Request</var>)</a></dt>
<dd class="defbody">
Realise the OpenID server. The protocol demands a POST request here.</dd>
<dt class="pubdef"><a id="openid_grant/1"><strong>openid_grant</strong>(<var>+Request</var>)</a></dt>
<dd class="defbody">
Handle the reply from <span class="pred-ext">checkid_setup_server/3</span>. 
If the reply is
<code>yes</code>, check the authority (typically the password) and if 
all looks good redirect the browser to ReturnTo, adding the OpenID 
properties needed by the Relying Party to verify the login.</dd>
<dt class="pubdef"><span class="pred-tag">[det]</span><a id="openid_associate/3"><strong>openid_associate</strong>(<var>?URL, 
?Handle, ?Assoc</var>)</a></dt>
<dd class="defbody">
Calls <a class="pred" href="#openid_associate/4">openid_associate/4</a> 
as

<pre class="code">
openid_associate(URL, Handle, Assoc, []).
</pre>

</dd>
<dt class="pubdef"><span class="pred-tag">[det]</span><a id="openid_associate/4"><strong>openid_associate</strong>(<var>+URL, 
-Handle, -Assoc, +Options</var>)</a></dt>
<dt class="pubdef"><span class="pred-tag">[semidet]</span><a id="openid_associate/4"><strong>openid_associate</strong>(<var>?URL, 
+Handle, -Assoc, +Options</var>)</a></dt>
<dd class="defbody">
Associate with an open-id server. We first check for a still valid old 
association. If there is none or it is expired, we esstablish one and 
remember it. <var>Options</var>:

<dl class="latex">
<dt><strong>ns</strong>(<var>URL</var>)</dt>
<dd class="defbody">
One of <code>http://specs.openid.net/auth/2.0</code> (default) or
<code>http://openid.net/signon/1.1</code>.
</dd>
</dl>

<dl class="tags">
<dt class="tag">To be done</dt>
<dd>
Should we store known associations permanently? Where?
</dd>
</dl>

</dd>
</dl>

<p><h3 id="sec:httpparam"><a id="sec:3.12"><span class="sec-nr">3.12</span> <span class="sec-title">Get 
parameters from HTML forms</span></a></h3>

<a id="sec:httpparam"></a>

<p>The library <code>library(http/http_parameters)</code> provides two 
predicates to fetch HTTP request parameters as a type-checked list 
easily. The library transparently handles both GET and POST requests. It 
builds on top of the low-level request representation described in
<a class="sec" href="#sec:3.13">section 3.13</a>.

<dl class="latex">
<dt class="pubdef"><a id="http_parameters/2"><strong>http_parameters</strong>(<var>+Request, 
?Parameters</var>)</a></dt>
<dd class="defbody">
The predicate is passes the <var>Request</var> as provided to the 
handler goal by <a id="idx:httpwrapper5:21"></a><a class="pred" href="#http_wrapper/5">http_wrapper/5</a> 
as well as a partially instantiated lists describing the requested 
parameters and their types. Each parameter specification in <var>Parameters</var> 
is a term of the format
<var>Name</var>(<var>-Value</var>, <var>+Options</var>) . <var>Options</var> 
is a list of option terms describing the type, default, etc. If no 
options are specified the parameter must be present and its value is 
returned in
<var>Value</var> as an atom.

<p>If a parameter is missing the exception
<code>error(<code>existence_error(http_parameter, Name)</code>, _)</code> 
is thrown which. If the argument cannot be converted to the requested 
type, a
<code>error(<code>existence_error(Type, Value)</code>, _)</code> is 
raised, where the error context indicates the HTTP parameter. If not 
caught, the server translates both errors into a <code>400 Bad request</code> 
HTTP message.

<p>Options fall into three categories: those that handle presence of the 
parameter, those that guide conversion and restrict types and those that 
support automatic generation of documention. First, the 
presence-options:

<dl class="latex">
<dt><strong>default</strong>(<var>Default</var>)</dt>
<dd class="defbody">
If the named parameter is missing, <var>Value</var> is unified to
<var>Default</var>.</dd>
<dt><strong>optional</strong>(<var>true</var>)</dt>
<dd class="defbody">
If the named parameter is missing, <var>Value</var> is left unbound and 
no error is generated.</dd>
<dt><strong>list</strong>(<var>Type</var>)</dt>
<dd class="defbody">
The same parameter may not appear or appear multiple times. If this 
option is present, <code>default</code> and <code>optional</code> are 
ignored and the value is returned as a list. Type checking options are 
processed on each value.</dd>
<dt><strong>zero_or_more</strong></dt>
<dd class="defbody">
Deprecated. Use <code>list(Type)</code>.
</dd>
</dl>

<p>The type and conversion options are given below. The type-language 
can be extended by providing clauses for the multifile hook
<a id="idx:httpconvertparameter3:22"></a><span class="pred-ext">http:convert_parameter/3</span>.

<dl class="latex">
<dt><strong><code>;</code></strong>(<var>Type1, Type2</var>)</dt>
<dd class="defbody">
Succeed if either <var>Type1</var> or <var>Type2</var> applies. It 
allows for checks such as <code>(nonneg;oneof([infinite]))</code> to 
specify an integer or a symbolic value.</dd>
<dt><strong>oneof</strong>(<var>List</var>)</dt>
<dd class="defbody">
Succeeds if the value is member of the given list.</dd>
<dt><b>length <var>&gt; N</var></b></dt>
<dd class="defbody">
Succeeds if value is an atom of more than <var>N</var> characters.</dd>
<dt><b>length <var>&gt;= N</var></b></dt>
<dd class="defbody">
Succeeds if value is an atom of more than or equal to <var>N</var> 
characters.</dd>
<dt><b>length <var>&lt; N</var></b></dt>
<dd class="defbody">
Succeeds if value is an atom of less than <var>N</var> characters.</dd>
<dt><b>length <var>=&lt; N</var></b></dt>
<dd class="defbody">
Succeeds if value is an atom of length less than or equal to <var>N</var> 
characters.</dd>
<dt><strong>atom</strong></dt>
<dd class="defbody">
No-op. Allowed for consistency.</dd>
<dt><strong>string</strong></dt>
<dd class="defbody">
Convert value to a string.</dd>
<dt><strong>between</strong>(<var>+Low, +High</var>)</dt>
<dd class="defbody">
Convert value to a number and if either <var>Low</var> or <var>High</var> 
is a float, force value to be a float. Then check that the value is in 
the given range, which includes the boundaries.</dd>
<dt><strong>boolean</strong></dt>
<dd class="defbody">
Translate =true=, =yes=, =on= and&rsquo;1&rsquo;into =true=; =false=, 
=no=, =off= and&rsquo;0&rsquo;into =false= and raises an error 
otherwise.</dd>
<dt><strong>float</strong></dt>
<dd class="defbody">
Convert value to a float. Integers are transformed into float. Throws a 
type-error otherwise.</dd>
<dt><strong>integer</strong></dt>
<dd class="defbody">
Convert value to an integer. Throws a type-error otherwise.</dd>
<dt><strong>nonneg</strong></dt>
<dd class="defbody">
Convert value to a non-negative integer. Throws a type-error of the 
value cannot be converted to an integer and a domain-error otherwise.</dd>
<dt><strong>number</strong></dt>
<dd class="defbody">
Convert value to a number. Throws a type-error otherwise.
</dd>
</dl>

<p>The last set of options is to support automatic generation of HTTP 
API documentation from the sources.<sup class="fn">4<span class="fn-text">This 
facility is under development in ClioPatria; see <code>http_help.pl</code></span></sup>.

<dl class="latex">
<dt><strong>description</strong>(<var>+Atom</var>)</dt>
<dd class="defbody">
Description of the parameter in plain text.</dd>
<dt><strong>group</strong>(<var>+Parameters, +Options</var>)</dt>
<dd class="defbody">
Define a logical group of parameters. <var>Parameters</var> are 
processed as normal. <var>Options</var> may include a description of the 
group. Groups can be nested.
</dd>
</dl>

<p>Below is an example

<pre class="code">
reply(Request) :-
        http_parameters(Request,
                        [ title(Title, [ optional(true) ]),
                          name(Name,   [ length &gt;= 2 ]),
                          age(Age,     [ between(0, 150) ])
                        ]),
        ...
</pre>

<p>Same as <code>http_parameters(Request, Parameters,[])</code></dd>
<dt class="pubdef"><a id="http_parameters/3"><strong>http_parameters</strong>(<var>+Request, 
?Parameters, +Options</var>)</a></dt>
<dd class="defbody">
In addition to <a id="idx:httpparameters2:23"></a><a class="pred" href="#http_parameters/2">http_parameters/2</a>, 
the following options are defined.

<dl class="latex">
<dt><strong>form_data</strong>(<var>-Data</var>)</dt>
<dd class="defbody">
Return the entire set of provided <var>Name</var>=<var>Value</var> pairs 
from the GET or POST request. All values are returned as atoms.</dd>
<dt><strong>attribute_declarations</strong>(<var>:Goal</var>)</dt>
<dd class="defbody">
If a parameter specification lacks the parameter options, call
<code>call(Goal, +ParamName, -Options)</code> to find the options. 
Intended to share declarations over many calls to <a id="idx:httpparameters3:24"></a><a class="pred" href="#http_parameters/3">http_parameters/3</a>. 
Using this construct the above can be written as below.

<pre class="code">
reply(Request) :-
        http_parameters(Request,
                        [ title(Title),
                          name(Name),
                          age(Age)
                        ],
                        [ attribute_declarations(param)
                        ]),
        ...

param(title, [optional(true)]).
param(name,  [length &gt;= 2 ]).
param(age,   [integer]).
</pre>

<p></dd>
</dl>

</dd>
</dl>

<p><h3 id="sec:request"><a id="sec:3.13"><span class="sec-nr">3.13</span> <span class="sec-title">Request 
format</span></a></h3>

<a id="sec:request"></a>

<p>The body-code (see <a class="sec" href="#sec:3.1">section 3.1</a>) is 
driven by a <var>Request</var>. This request is generated from <a id="idx:httpreadrequest2:25"></a><a class="pred" href="#http_read_request/2">http_read_request/2</a> 
defined in
<code>library(http/http_header)</code>.

<dl class="latex">
<dt class="pubdef"><a id="http_read_request/2"><strong>http_read_request</strong>(<var>+Stream, 
-Request</var>)</a></dt>
<dd class="defbody">
Reads an HTTP request from <var>Stream</var> and unify <var>Request</var> 
with the parsed request. <var>Request</var> is a list of <code><var>Name</var>(Value)</code> 
elements. It provides a number of predefined elements for the result of 
parsing the first line of the request, followed by the additional 
request parameters. The predefined fields are:

<dl class="latex">
<dt><strong>host</strong>(<var>Host</var>)</dt>
<dd class="defbody">
If the request contains <code>Host: </code><var>Host</var>, Host is 
unified with the host-name. If <var>Host</var> is of the format &lt;<var>host</var>&gt;:&lt;<var>port</var>&gt;
<var>Host</var> only describes &lt;<var>host</var>&gt; and a field <code>port(Port)</code> 
where
<var>Port</var> is an integer is added.</dd>
<dt><strong>input</strong>(<var>Stream</var>)</dt>
<dd class="defbody">
The <var>Stream</var> is passed along, allowing to read more data or 
requests from the same stream. This field is always present.</dd>
<dt><strong>method</strong>(<var>Method</var>)</dt>
<dd class="defbody">
<var>Method</var> is the HTTP <em>method</em> represented as a 
lower-case atom (i.e., <code>delete</code>, <code>get</code>, <code>head</code>,
<code>options</code>, <code>patch</code>, <code>post</code>, <code>put</code>,
<code>trace</code>). This field is present if the header has been parsed 
successfully.</dd>
<dt><strong>path</strong>(<var>Path</var>)</dt>
<dd class="defbody">
Path associated to the request. This field is always present.</dd>
<dt><strong>peer</strong>(<var>Peer</var>)</dt>
<dd class="defbody">
<var>Peer</var> is a term <code>ip(A,B,C,D)</code> containing the IP 
address of the contacting host.</dd>
<dt><strong>port</strong>(<var>Port</var>)</dt>
<dd class="defbody">
Port requested. See <code>host</code> for details.</dd>
<dt><strong>request_uri</strong>(<var>RequestURI</var>)</dt>
<dd class="defbody">
This is the untranslated string that follows the method in the request 
header. It is used to construct the path and search fields of the <var>Request</var>. 
It is provided because reconstructing this string from the path and 
search fields may yield a different value due to different usage of 
percent encoding.</dd>
<dt><strong>search</strong>(<var>ListOfNameValue</var>)</dt>
<dd class="defbody">
Search-specification of URI. This is the part after the <code><code>?</code></code>, 
normally used to transfer data from HTML forms that use the HTTP GET 
method. In the URL it consists of a www-form-encoded list of <var>Name</var>=<var>Value</var> 
pairs. This is mapped to a list of Prolog <var>Name</var>=<var>Value</var> 
terms with decoded names and values. This field is only present if the 
location contains a search-specification.

<p>The URL specification does not <em>demand</em> the query part to be 
of the form <i>name=value</i>. If the field is syntactically incorrect, 
ListOfNameValue is bound the the empty list ([]).</dd>
<dt><strong>http_version</strong>(<var>Major-Minor</var>)</dt>
<dd class="defbody">
If the first line contains the <code>HTTP/</code><var>Major</var>.<var>Minor</var> 
version indicator this element indicate the HTTP version of the peer. 
Otherwise this field is not present.</dd>
<dt><strong>cookie</strong>(<var>ListOfNameValue</var>)</dt>
<dd class="defbody">
If the header contains a <code>Cookie</code> line, the value of the 
cookie is broken down in <var>Name</var>=<var>Value</var> pairs, where 
the
<var>Name</var> is the lowercase version of the cookie name as used for 
the HTTP fields.</dd>
<dt><strong>set_cookie</strong>(<var>set_cookie(Name, Value, Options)</var>)</dt>
<dd class="defbody">
If the header contains a <code>SetCookie</code> line, the cookie field 
is broken down into the <var>Name</var> of the cookie, the <var>Value</var> 
and a list of <var>Name</var>=<var>Value</var> pairs for additional 
options such as <code>expire</code>, <code>path</code>, <code>domain</code> 
or <code>secure</code>.
</dd>
</dl>

<p>If the first line of the request is tagged with
<code>HTTP/</code><var>Major</var>.<var>Minor</var>, <a id="idx:httpreadrequest2:26"></a><a class="pred" href="#http_read_request/2">http_read_request/2</a> 
reads all input upto the first blank line. This header consists of
<var>Name</var>:<var>Value</var> fields. Each such field appears as a 
term
<code><var>Name</var>(Value)</code> in the <var>Request</var>, where <var>Name</var> 
is canonicalised for use with Prolog. Canonisation implies that the
<var>Name</var> is converted to lower case and all occurrences of the
<code><code>-</code></code> are replaced by <code>_</code>. The value 
for the
<code>Content-length</code> fields is translated into an integer.
</dd>
</dl>

<p>Here is an example:

<pre class="code">
?- http_read_request(user_input, X).
|: GET /mydb?class=person HTTP/1.0
|: Host: gollem
|:
X = [ input(user),
      method(get),
      search([ class = person
             ]),
      path('/mydb'),
      http_version(1-0),
      host(gollem)
    ].
</pre>

<p><h4 id="sec:http-read-post"><a id="sec:3.13.1"><span class="sec-nr">3.13.1</span> <span class="sec-title">Handling 
POST requests</span></a></h4>

<a id="sec:http-read-post"></a>

<p>Where the HTTP <code>GET</code> operation is intended to get a 
document, using a <var>path</var> and possibly some additional search 
information, the <code>POST</code> operation is intended to hand 
potentially large amounts of data to the server for processing.

<p>The <var>Request</var> parameter above contains the term <code>method(post)</code>. 
The data posted is left on the input stream that is available through 
the term <code>input(Stream)</code> from the <var>Request</var> header. 
This data can be read using <a id="idx:httpreaddata3:27"></a><a class="pred" href="#http_read_data/3">http_read_data/3</a> 
from the HTTP client library. Here is a demo implementation simply 
returning the parsed posted data as plain text (assuming <a id="idx:pp1:28"></a><span class="pred-ext">pp/1</span> 
pretty-prints the data).

<pre class="code">
reply(Request) :-
        member(method(post), Request), !,
        http_read_data(Request, Data, []),
        format('Content-type: text/plain~n~n', []),
        pp(Data).
</pre>

<p>If the POST is initiated from a browser, content-type is generally 
either <code>application/x-www-form-urlencoded</code> or
<code>multipart/form-data</code>.

<p><h3 id="sec:http-running-server"><a id="sec:3.14"><span class="sec-nr">3.14</span> <span class="sec-title">Running 
the server</span></a></h3>

<a id="sec:http-running-server"></a>

<p>The functionality of the server should be defined in one Prolog file 
(of course this file is allowed to load other files). Depending on the 
wanted server setup this&lsquo;body&rsquo;is wrapped into a small Prolog 
file combining the body with the appropriate server interface. There are 
three supported server-setups. For most applications we advise the 
multi-threaded server. Examples of this server architecture are the
<a class="url" href="http://www.swi-prolog.org/packages/pldoc.html">PlDoc</a> 
documentation system and the <a class="url" href="http://www.swi-prolog.org/packages/SeRQL/">SeRQL</a> 
Semantic Web server infrastructure.

<p>All the server setups may be wrapped in a <em>reverse proxy</em> to 
make them available from the public web-server as described in
<a class="sec" href="#sec:3.14.6">section 3.14.6</a>.

<p>
<ul class="latex">
<li><i>Using <code>library(thread_httpd)</code> for a multi-threaded 
server</i><br>
This server exploits the multi-threaded version of SWI-Prolog, running 
the users body code parallel from a pool of worker threads. As it avoids 
the state engine and copying required in the event-driven server it is 
generally faster and capable to handle multiple requests concurrently.

<p>This server is harder to debug due to the involved threading, 
although the GUI tracer provides reasonable support for multi-threaded 
applications using the <a id="idx:tspy1:29"></a><span class="pred-ext">tspy/1</span> 
command. It can provide fast communication to multiple clients and can 
be used for more demanding servers.

<p>
<li><i>Using <code>library(inetd_httpd)</code> for server-per-client</i><br>
In this setup the Unix <b>inetd</b> user-daemon is used to initialise a 
server for each connection. This approach is especially suitable for 
servers that have a limited startup-time. In this setup a crashing 
client does not influence other requests.

<p>This server is very hard to debug as the server is not connected to 
the user environment. It provides a robust implementation for servers 
that can be started quickly.
</ul>

<p><h4 id="sec:http-server-options"><a id="sec:3.14.1"><span class="sec-nr">3.14.1</span> <span class="sec-title">Common 
server interface options</span></a></h4>

<a id="sec:http-server-options"></a>

<p>All the server interfaces provide <code>http_server(:Goal, +Options)</code> 
to create the server. The list of options differ, but the servers share 
common options:

<dl class="latex">
<dt><strong>port</strong>(<var>?Port</var>)</dt>
<dd class="defbody">
Specify the port to listen to for stand-alone servers. <var>Port</var> 
is either an integer or unbound. If unbound, it is unified to the 
selected free port.
</dd>
</dl>

<p><h4 id="sec:mthttpd"><a id="sec:3.14.2"><span class="sec-nr">3.14.2</span> <span class="sec-title">Multi-threaded 
Prolog</span></a></h4>

<a id="sec:mthttpd"></a>

<p>The <code>library(http/thread_httpd.pl)</code> provides the 
infrastructure to manage multiple clients using a pool of <em>worker-threads</em>. 
This realises a popular server design, also seen in Java Tomcat and 
Microsoft .NET. As a single persistent server process maintains 
communication to all clients startup time is not an important issue and 
the server can easily maintain state-information for all clients.

<p>In addition to the functionality provided by the inetd server, the 
threaded server can also be used to realise an HTTPS server exploiting 
the <code>library(ssl)</code> library. See option <code>ssl(+SSLOptions)</code> 
below.

<dl class="latex">
<dt class="pubdef"><a id="http_server/2"><strong>http_server</strong>(<var>:Goal, 
+Options</var>)</a></dt>
<dd class="defbody">
Create the server. <var>Options</var> must provide the <code>port(?Port)</code> 
option to specify the port the server should listen to. If <var>Port</var> 
is unbound an arbitrary free port is selected and <var>Port</var> is 
unified to this port-number. The server consists of a small Prolog 
thread accepting new connection on <var>Port</var> and dispatching these 
to a pool of workers. Defined <var>Options</var> are:

<dl class="latex">
<dt><strong>port</strong>(<var>?Address</var>)</dt>
<dd class="defbody">
Address to bind to. <var>Address</var> is either a port (integer) or a 
term
<var>Host</var>:<var>Port</var>. The port may be a variable, causing the 
system to select a free port and unify the variable with the selected 
port. See also <a id="idx:tcpbind2:30"></a><span class="pred-ext">tcp_bind/2</span>.</dd>
<dt><strong>workers</strong>(<var>+N</var>)</dt>
<dd class="defbody">
Defines the number of worker threads in the pool. Default is to use
<var>five</var> workers. Choosing the optimal value for best performance 
is a difficult task depending on the number of CPUs in your system and 
how much resources are required for processing a request. Too high 
numbers makes your system switch too often between threads or even swap 
if there is not enough memory to keep all threads in memory, while a too 
low number causes clients to wait unnecessary for other clients to 
complete. See also <a id="idx:httpworkers2:31"></a><a class="pred" href="#http_workers/2">http_workers/2</a>.</dd>
<dt><strong>timeout</strong>(<var>+SecondsOrInfinite</var>)</dt>
<dd class="defbody">
Determines the maximum period of inactivity handling a request. If no 
data arrives within the specified time since the last data arrived, the 
connection raises an exception, and the worker discards the client and 
returns to the pool-queue for a new client. If it is <code>infinite</code>, 
a worker may wait forever on a client that doesn't complete its request. 
Default is 60&nbsp;seconds.</dd>
<dt><strong>keep_alive_timeout</strong>(<var>+SecondsOrInfinite</var>)</dt>
<dd class="defbody">
Maximum time to wait for new activity on <em>Keep-Alive</em> 
connections. Choosing the correct value for this parameter is hard. 
Disabling Keep-Alive is bad for performance if the clients request 
multiple documents for a single page. This may ---for example-- be 
caused by HTML frames, HTML pages with images, associated CSS files, 
etc. Keeping a connection open in the threaded model however prevents 
the thread servicing the client servicing other clients. The default is 
2 seconds.</dd>
<dt><strong>local</strong>(<var>+KBytes</var>)</dt>
<dd class="defbody">
Size of the local-stack for the workers. Default is taken from the 
commandline option.</dd>
<dt><strong>global</strong>(<var>+KBytes</var>)</dt>
<dd class="defbody">
Size of the global-stack for the workers. Default is taken from the 
commandline option.</dd>
<dt><strong>trail</strong>(<var>+KBytes</var>)</dt>
<dd class="defbody">
Size of the trail-stack for the workers. Default is taken from the 
commandline option.</dd>
<dt><strong>ssl</strong>(<var>+SSLOptions</var>)</dt>
<dd class="defbody">
Use SSL (Secure Socket Layer) rather than plain TCP/IP. A server created 
this way is accessed using the <code>https://</code> protocol. SSL 
allows for encrypted communication to avoid others from tapping the wire 
as well as improved authentication of client and server. The <var>SSLOptions</var> 
option list is passed to <a id="idx:sslcontext3:32"></a><span class="pred-ext">ssl_context/3</span>. 
The port option of the main option list is forwarded to the SSL&nbsp;layer. 
See the <code>library(ssl)</code> library for details.
</dd>
</dl>

</dd>
<dt class="pubdef"><a id="http_server_property/2"><strong>http_server_property</strong>(<var>?Port, 
?Property</var>)</a></dt>
<dd class="defbody">
True if <var>Property</var> is a property of the HTTP server running at
<var>Port</var>. Defined properties are:

<dl class="latex">
<dt><strong>goal</strong>(<var>:Goal</var>)</dt>
<dd class="defbody">
Goal used to start the server. This is often <a id="idx:httpdispatch1:33"></a><a class="pred" href="#http_dispatch/1">http_dispatch/1</a>.
</dd>
<dt><strong>scheme</strong>(<var>-Scheme</var>)</dt>
<dd class="defbody">
Scheme is one of <code>http</code> or <code>https</code>.
</dd>
<dt><strong>start_time</strong>(<var>-Time</var>)</dt>
<dd class="defbody">
Time-stamp when the server was created. See <a id="idx:formattime3:34"></a><span class="pred-ext">format_time/3</span> 
for creating a human-readable representation.
</dd>
</dl>

</dd>
<dt class="pubdef"><a id="http_workers/2"><strong>http_workers</strong>(<var>+Port, 
?Workers</var>)</a></dt>
<dd class="defbody">
Query or manipulate the number of workers of the server identified by
<var>Port</var>. If <var>Workers</var> is unbound it is unified with the 
number of running servers. If it is an integer greater than the current 
size of the worker pool new workers are created with the same 
specification as the running workers. If the number is less than the 
current size of the worker pool, this predicate inserts a number of&lsquo;quit&rsquo;requests 
in the queue, discarding the excess workers as they finish their jobs 
(i.e. no worker is abandoned while serving a client).

<p>This can be used to tune the number of workers for performance. 
Another possible application is to reduce the pool to one worker to 
facilitate easier debugging.</dd>
<dt class="pubdef"><a id="http_add_worker/2"><strong>http_add_worker</strong>(<var>+Port, 
+Options</var>)</a></dt>
<dd class="defbody">
Add a new worker to the HTTP server for port <var>Port</var>. <var>Options</var> 
overrule the default queue options. The following additional options are 
processed:

<dl class="latex">
<dt><strong>max_idle_time</strong>(<var>+Seconds</var>)</dt>
<dd class="defbody">
The created worker will automatically terminate if there is no new work 
within Seconds.
</dd>
</dl>

</dd>
<dt class="pubdef"><a id="http_stop_server/2"><strong>http_stop_server</strong>(<var>+Port, 
+Options</var>)</a></dt>
<dd class="defbody">
Stop the HTTP server at Port. Halting a server is done
<i>gracefully</i>, which means that requests being processed are not 
abandoned. The <var>Options</var> list is for future refinements of this 
predicate such as a forced immediate abort of the server, but is 
currently ignored.</dd>
<dt class="pubdef"><a id="http_current_worker/2"><strong>http_current_worker</strong>(<var>?Port, 
?ThreadID</var>)</a></dt>
<dd class="defbody">
True if <var>ThreadID</var> is the identifier of a Prolog thread serving
<var>Port</var>. This predicate is motivated to allow for the use of 
arbitrary interaction with the worker thread for development and 
statistics.</dd>
<dt class="pubdef"><a id="http_spawn/2"><strong>http_spawn</strong>(<var>:Goal, 
+Spec</var>)</a></dt>
<dd class="defbody">
Continue handling this request in a new thread running <var>Goal</var>. 
After
<a id="idx:httpspawn2:35"></a><a class="pred" href="#http_spawn/2">http_spawn/2</a>, 
the worker returns to the pool to process new requests. In its simplest 
form, <var>Spec</var> is the name of a thread pool as defined by
<a id="idx:threadpoolcreate3:36"></a><span class="pred-ext">thread_pool_create/3</span>. 
Alternatively it is an option list, whose options are passed to <a id="idx:threadcreateinpool4:37"></a><span class="pred-ext">thread_create_in_pool/4</span> 
if <var>Spec</var> contains
<code>pool(Pool)</code> or to <a id="idx:threadcreate3:38"></a><span class="pred-ext">thread_create/3</span> 
of the pool option is not present. If the dispatch module is used (see <a class="sec" href="#sec:3.2">section 
3.2</a>), spawning is normally specified as an option to the <a id="idx:httphandler3:39"></a><a class="pred" href="#http_handler/3">http_handler/3</a> 
registration.

<p>We recomment the use of thread pools. They allow registration of a 
set of threads using common characteristics, specify how many can be 
active and what to do if all threads are active. A typical application 
may define a small pool of threads with large stacks for computation 
intensive tasks, and a large pool of threads with small stacks to serve 
media. The declaration could be the one below, allowing for max 3 
concurrent solvers and a maximum backlog of 5 and 30 tasks creating 
image thumbnails.

<pre class="code">
:- use_module(library(thread_pool)).

:- thread_pool_create(compute, 3,
                      [ local(20000), global(100000), trail(50000),
                        backlog(5)
                      ]).
:- thread_pool_create(media, 30,
                      [ local(100), global(100), trail(100),
                        backlog(100)
                      ]).

:- http_handler('/solve',     solve,     [spawn(compute)]).
:- http_handler('/thumbnail', thumbnail, [spawn(media)]).
</pre>

<p></dd>
</dl>

<p><h4 id="sec:http-inetd"><a id="sec:3.14.3"><span class="sec-nr">3.14.3</span> <span class="sec-title">From 
(Unix) inetd</span></a></h4>

<a id="sec:http-inetd"></a>

<p>All modern Unix systems handle a large number of the services they 
run through the super-server <em>inetd</em> or one of its descendants (<em>xinetd</em>, <em>systemd</em> 
etc.) Such a program reads a configuration file (for example <code>/etc/inetd.conf</code>) 
and opens server-sockets on all ports defined in this file. As a request 
comes in it accepts it and starts the associated server such that 
standard I/O is performed through the socket. This approach has several 
advantages:

<p>
<ul class="latex">
<li><i>Simplification of servers</i><br>
Servers don't have to know about sockets and -operations.

<p>
<li><i>Centralised authorisation</i><br>
Using <em>tcpwrappers</em> and similar tools, simple and effective 
firewalling of all services can be realised.

<p>
<li><i>Automatic start and monitor</i><br>
The inetd automatically starts the server&lsquo;just-in-time&rsquo;and 
starts additional servers or restarts a crashed server according to its 
configuration.
</ul>

<p>The very small generic script for handling inetd based connections is 
in <code>inetd_httpd</code>, defining <a id="idx:httpserver1:40"></a><a class="pred" href="#http_server/1">http_server/1</a>:

<dl class="latex">
<dt class="pubdef"><a id="http_server/1"><strong>http_server</strong>(<var>:Goal</var>)</a></dt>
<dd class="defbody">
Initialises and runs <a id="idx:httpwrapper5:41"></a><a class="pred" href="#http_wrapper/5">http_wrapper/5</a> 
in a loop until failure or end-of-file. This server does not support the <var>Port</var> 
option as the port is specified with the <b>inetd</b> configuration. The 
only supported option is <var>After</var>.
</dd>
</dl>

<p>Here is the example from <code>demo_inetd</code>

<pre class="code">
#!/usr/bin/pl -t main -q -f
:- use_module(demo_body).
:- use_module(inetd_httpd).

main :-
        http_server(reply).
</pre>

<p>With the above file installed in <code>/home/jan/plhttp/demo_inetd</code>, 
the following line in <code>/etc/inetd</code> enables the server at port 
4001 guarded by <em>tcpwrappers</em>. After modifying inetd, send the 
daemon the <code>HUP</code> signal to make it reload its configuration. 
For more information, please check <strong>inetd.conf</strong>(5).

<pre class="code">
4001 stream tcp nowait nobody /usr/sbin/tcpd /home/jan/plhttp/demo_inetd
</pre>

<p><h4 id="sec:http-inetd-mswin"><a id="sec:3.14.4"><span class="sec-nr">3.14.4</span> <span class="sec-title">MS-Windows</span></a></h4>

<a id="sec:http-inetd-mswin"></a>

<p>There are rumours that <em>inetd</em> has been ported to Windows.

<p><h4 id="sec:http-server-as-cgi"><a id="sec:3.14.5"><span class="sec-nr">3.14.5</span> <span class="sec-title">As 
CGI script</span></a></h4>

<a id="sec:http-server-as-cgi"></a>

<p>To be done.

<p><h4 id="sec:proxy"><a id="sec:3.14.6"><span class="sec-nr">3.14.6</span> <span class="sec-title">Using 
a reverse proxy</span></a></h4>

<a id="sec:proxy"></a>

<p>There are several options for public deployment of a web service. The 
main decision is whether to run it on a standard port (port 80 for HTTP, 
port 443 for HTTPS) or a non-standard port such as for example 8000 or 
8080. Using a standard port below 1000 requires root access to the 
machine, and prevents other web services from using the same port. On 
the other hand, using a non-standard port may cause problems with 
intermediate proxy- and/or firewall policies that may block the port 
when you try to access the service from some networks. In both cases, 
you can either use a physical or a virtual machine running ---for 
example--- under <a class="url" href="http://www.vmware.com">VMWARE</a> 
or
<a class="url" href="http://www.cl.cam.ac.uk/research/srg/netos/xen/">XEN</a> 
to host the service. Using a dedicated (physical or virtual) machine to 
host a service isolates security threats. Isolation can also be achieved 
using a Unix <em>chroot</em> environment, which is however not a 
security feature.

<p>To make several different web services reachable on the same (either 
standard or non-standard) port, you can use a so-called <em>reverse 
proxy</em>. A reverse proxy uses rules to relay requests to other web 
services that use their own dedicated ports. This approach has several 
advantages:

<p>
<ul class="latex">
<li>We can run the service on a non-standard port, but still access it 
(via the proxy) on a standard port, just as for a dedicated machine. We 
do not need a separate machine though: We only need to configure the 
reverse proxy to relay requests to the intended target servers.
<li>As the main web server is doing the front-line service, the Prolog 
server is normally protected from malformed HTTP requests that could 
result in denial of service or otherwise compromise the server. In 
addition, the main web server can transparently provide encodings such 
as compression to the outside world.
</ul>

<p>Proxy technology can be combined with isolation methods such as 
dedicated machines, virtual machines and chroot jails. The proxy can 
also provide load balancing.

<p><b>Setting up an Apache reverse proxy</b> 

<p>The Apache reverse proxy setup is really simple. Ensure the modules
<code>proxy</code> and <code>proxy_http</code> are loaded. Then add two 
simple rules to the server configuration. Below is an example that makes 
a PlDoc server on port 4000 available from the main Apache server at 
port 80.

<pre class="code">
ProxyPass        /pldoc/ http://localhost:4000/pldoc/
ProxyPassReverse /pldoc/ http://localhost:4000/pldoc/
</pre>

<p>Apache rewrites the HTTP headers passing by, but using the above 
rules it does not examine the content. This implies that URLs embedded 
in the (HTML) content must use relative addressing. If the locations on 
the public and Prolog server are the same (as in the example above) it 
is allowed to use absolute locations. I.e. <code>/pldoc/search</code> is 
ok, but <code>http://myhost.com:4000/pldoc/search</code> is <em>not</em>. 
If the locations on the server differ, locations must be relative (i.e. not 
start with <code><code>/</code></code>.

<p>This problem can also be solved using the contributed Apache module
<code>proxy_html</code> that can be instructed to rewrite URLs embedded 
in HTML documents. In our experience, this is not troublefree as URLs 
can appear in many places in generated documents. JavaScript can create 
URLs on the fly, which makes rewriting virtually impossible.

<p><h3 id="sec:http-wrapper"><a id="sec:3.15"><span class="sec-nr">3.15</span> <span class="sec-title">The 
wrapper library</span></a></h3>

<a id="sec:http-wrapper"></a>

<p>The body is called by the module <code>library(http/http_wrapper.pl)</code>. 
This module realises the communication between the I/O streams and the 
body described in <a class="sec" href="#sec:3.1">section 3.1</a>. The 
interface is realised by
<a id="idx:httpwrapper5:42"></a><a class="pred" href="#http_wrapper/5">http_wrapper/5</a>:

<dl class="latex">
<dt class="pubdef"><a id="http_wrapper/5"><strong>http_wrapper</strong>(<var>:Goal, 
+In, +Out, -Connection, +Options</var>)</a></dt>
<dd class="defbody">
Handle an HTTP request where <var>In</var> is an input stream from the 
client, <var>Out</var> is an output stream to the client and <var>Goal</var> 
defines the goal realising the body. <var>Connection</var> is unified to
<code>&rsquo;Keep-alive&rsquo;</code> if both ends of the connection 
want to continue the connection or <code>close</code> if either side 
wishes to close the connection.

<p>This predicate reads an HTTP request-header from <var>In</var>, 
redirects current output to a memory file and then runs <code>call(Goal, 
Request)</code>, watching for exceptions and failure. If <var>Goal</var> 
executes successfully it generates a complete reply from the created 
output. Otherwise it generates an HTTP server error with additional 
context information derived from the exception.

<p><a id="idx:httpwrapper5:43"></a><a class="pred" href="#http_wrapper/5">http_wrapper/5</a> 
supports the following options:

<dl class="latex">
<dt><strong>request</strong>(<var>-Request</var>)</dt>
<dd class="defbody">
Return the executed request to the caller.</dd>
<dt><strong>peer</strong>(<var>+Peer</var>)</dt>
<dd class="defbody">
Add peer(Peer) to the request header handed to <var>Goal</var>. The 
format of <var>Peer</var> is defined by <a id="idx:tcpaccept3:44"></a><span class="pred-ext">tcp_accept/3</span> 
from the clib package.
</dd>
</dl>

</dd>
<dt class="pubdef"><a id="http:request_expansion/2"><strong>http:request_expansion</strong>(<var>+RequestIn, 
-RequestOut</var>)</a></dt>
<dd class="defbody">
This <em>multifile</em> hook predicate is called just before the goal 
that produces the body, while the output is already redirected to 
collect the reply. If it succeeds it must return a valid modified 
request. It is allowed to throw exceptions as defined in
<a class="sec" href="#sec:3.1.1">section 3.1.1</a>. It is intended for 
operations such as mapping paths, deny access for certain requests or 
manage cookies. If it writes output, these must be HTTP header fields 
that are added <em>before</em> header fields written by the body. The 
example below is from the session management library (see <a class="sec" href="#sec:3.5">section 
3.5</a>) sets a cookie.

<pre class="code">
        ...,
        format('Set-Cookie: ~w=~w; path=~w~n', [Cookie, SessionID, Path]),
        ...,
</pre>

</dd>
<dt class="pubdef"><a id="http_current_request/1"><strong>http_current_request</strong>(<var>-Request</var>)</a></dt>
<dd class="defbody">
Get access to the currently executing request. <var>Request</var> is the 
same as handed to <var>Goal</var> of <a id="idx:httpwrapper5:45"></a><a class="pred" href="#http_wrapper/5">http_wrapper/5</a> <em>after</em> 
applying rewrite rules as defined by <a id="idx:httprequestexpansion2:46"></a><a class="pred" href="#http:request_expansion/2">http:request_expansion/2</a>. 
Raises an existence error if there is no request in progress.</dd>
<dt class="pubdef"><a id="http_relative_path/2"><strong>http_relative_path</strong>(<var>+AbsPath, 
-RelPath</var>)</a></dt>
<dd class="defbody">
Convert an absolute path (without host, fragment or search) into a path 
relative to the current page, defined as the path component from the 
current request (see <a id="idx:httpcurrentrequest1:47"></a><a class="pred" href="#http_current_request/1">http_current_request/1</a>). 
This call is intended to create reusable components returning relative 
paths for easier support of reverse proxies.

<p>If ---for whatever reason--- the conversion is not possible it simply 
unifies <var>RelPath</var> to <var>AbsPath</var>.
</dd>
</dl>

<p><h3 id="sec:httphost"><a id="sec:3.16"><span class="sec-nr">3.16</span> <span class="sec-title">library(http/http_host): 
Obtain public server location</span></a></h3>

<p><a id="sec:httphost"></a>

<p>This library finds the public address of the running server. This can 
be used to construct URLs that are visible from anywhere on the 
internet. This module was introduced to deal with OpenID, where a 
request is redirected to the OpenID server, which in turn redirects to 
our server (see <code>http_openid.pl</code>).

<p>The address is established from the settings <code>http:public_host</code> 
and
<code>http:public_port</code> if provided. Otherwise it is deduced from 
the request.

<dl class="latex">
<dt class="pubdef"><span class="pred-tag">[det]</span><a id="http_public_url/2"><strong>http_public_url</strong>(<var>+Request, 
-URL</var>)</a></dt>
<dd class="defbody">
True when <var>URL</var> is an absolute <var>URL</var> for the current 
request. Typically, the login page should redirect to this <var>URL</var> 
to avoid losing the session.</dd>
<dt class="pubdef"><span class="pred-tag">[det]</span><a id="http_public_host_url/2"><strong>http_public_host_url</strong>(<var>+Request, 
-URL</var>)</a></dt>
<dd class="defbody">
True when <var>URL</var> is the public <var>URL</var> at which this 
server can be contacted. This value is not easy to obtain. See
<a class="pred" href="#http_public_host/4">http_public_host/4</a> for 
the hardest part: find the host and port.</dd>
<dt class="pubdef"><span class="pred-tag">[det]</span><a id="http_public_host/4"><strong>http_public_host</strong>(<var>?Request, 
-Hostname, -Port, +Options</var>)</a></dt>
<dd class="defbody">
Current global host and port of the HTTP server. This is the basis to 
form absolute address, which we need for redirection based interaction 
such as the OpenID protocol. <var>Options</var> are:

<dl class="latex">
<dt><strong>global</strong>(<var>+Bool</var>)</dt>
<dd class="defbody">
If <code>true</code> (default <code>false</code>), try to replace a 
local hostname by a world-wide accessible name.
</dd>
</dl>

<p>This predicate performs the following steps to find the host and 
port:

<p>
<ol class="latex">
<li>Use the settings <code>http:public_host</code> and <code>http:public_port</code>
<li>Use <code>X-Forwarded-Host</code> header, which applies if this 
server runs behind a proxy.
<li>Use the <code>Host</code> header, which applies for HTTP 1.1 if we 
are contacted directly.
<li>Use <span class="pred-ext">gethostname/1</span> to find the host and
<span class="pred-ext">http_current_server/2</span> to find the port.
</ol>
<table class="arglist">
<tr><td><var>Request</var> </td><td>is the current request. If it is 
left unbound, and the request is needed, it is obtained with
<a class="pred" href="#http_current_request/1">http_current_request/1</a>. </td></tr>
</table>
</dd>
<dt class="pubdef"><span class="pred-tag">[det]</span><a id="http_current_host/4"><strong>http_current_host</strong>(<var>?Request, 
-Hostname, -Port, +Options</var>)</a></dt>
<dd class="defbody">

<dl class="tags">
<dt class="tag">deprecated</dt>
<dd>
Use <a class="pred" href="#http_public_host/4">http_public_host/4</a> 
(same semantics)
</dd>
</dl>

</dd>
</dl>

<p><h3 id="sec:httplog"><a id="sec:3.17"><span class="sec-nr">3.17</span> <span class="sec-title">library(http/http_log): 
HTTP Logging module</span></a></h3>

<p><a id="sec:httplog"></a>

<p>Simple module for logging HTTP requests to a file. Logging is enabled 
by loading this file and ensure the setting http:logfile is not the 
empty atom. The default file for writing the log is <code>httpd.log</code>. 
See
<code>library(settings)</code> for details.

<p>The level of logging can be modified using the multifile predicate
<span class="pred-ext">http_log:nolog/1</span> to hide HTTP request 
fields from the logfile and
<span class="pred-ext">http_log:password_field/1</span> to hide 
passwords from HTTP search specifications (e.g. <code>/topsecret?password=secret</code>).

<dl class="latex">
<dt class="pubdef"><span class="pred-tag">[semidet]</span><a id="http_log_stream/1"><strong>http_log_stream</strong>(<var>-Stream</var>)</a></dt>
<dd class="defbody">
True when <var>Stream</var> is a stream to the opened HTTP log file. 
Opens the log file in <code>append</code> mode if the file is not yet 
open. The log file is determined from the setting <code>http:logfile</code>. 
If this setting is set to the empty atom (&rdquo; ), this predicate 
fails.

<p>If a file error is encountered, this is reported using
<span class="pred-ext">print_message/2</span>, after which this 
predicate silently fails. Opening is retried every minute when a new 
message arrives.

<p>Before opening the log file, the message <code>http_log_open(Term)</code> 
is broadcasted. This message allows for creating the directory, 
renaming, deleting or truncating an existing log file.</dd>
<dt class="pubdef"><span class="pred-tag">[det]</span><a id="http_log_close/1"><strong>http_log_close</strong>(<var>+Reason</var>)</a></dt>
<dd class="defbody">
If there is a currently open HTTP logfile, close it after adding a term <code>server(Reason, Time)</code>. 
to the logfile. This call is intended for cooperation with the Unix 
logrotate facility using the following schema:

<p>
<ul class="latex">
<li>Move logfile (the HTTP server keeps writing to the moved file)
<li>Inform the server using an HTTP request that calls
<a class="pred" href="#http_log_close/1">http_log_close/1</a>
<li>Compress the moved logfile
</ul>

<dl class="tags">
<dt class="tag">author</dt>
<dd>
Suggested by Jacco van Ossenbruggen
</dd>
</dl>

</dd>
<dt class="pubdef"><span class="pred-tag">[det]</span><a id="http_log/2"><strong>http_log</strong>(<var>+Format, 
+Args</var>)</a></dt>
<dd class="defbody">
Write message from <var>Format</var> and <var>Args</var> to log-stream. 
See <span class="pred-ext">format/2</span> for details. Succeed without 
side effects if logging is not enabled.</dd>
<dt class="multidef"><span class="pred-tag">[semidet,multifile]</span><a id="password_field/1"><strong>password_field</strong>(<var>+Field</var>)</a></dt>
<dd class="defbody">
Multifile predicate that can be defined to hide passwords from the 
logfile.</dd>
<dt class="multidef"><span class="pred-tag">[multifile]</span><a id="nolog/1"><strong>nolog</strong>(<var>+HTTPField</var>)</a></dt>
<dd class="defbody">
Multifile predicate that can be defined to hide request parameters from 
the request logfile.</dd>
<dt class="multidef"><span class="pred-tag">[semidet,multifile]</span><a id="nolog_post_content_type/1"><strong>nolog_post_content_type</strong>(<var>+Type</var>)</a></dt>
<dd class="defbody">
Multifile hook called with the <code>Content-type</code> header. If the 
hook succeeds, the POST data is not logged. For example, to stop logging 
anything but application/json messages:

<pre class="code">
:- multifile http_log:nolog_post_content_type/1.

http_log:nolog_post_content_type(Type) :-
   Type \= (application/json).
</pre>

<table class="arglist">
<tr><td><var>Type</var> </td><td>is a term MainType/SubType </td></tr>
</table>
</dd>
<dt class="pubdef"><span class="pred-tag">[det]</span><a id="post_data_encoded/2"><strong>post_data_encoded</strong>(<var>?Bytes:string, 
?Encoded:string</var>)</a></dt>
<dd class="defbody">
Encode the POST body for inclusion into the HTTP log file. The POST data 
is (in/de)flated using <span class="pred-ext">zopen/3</span> and base64 
encoded using <span class="pred-ext">base64//1</span>. The encoding 
makes long text messages shorter and keeps readable logfiles if binary 
data is posted.</dd>
<dt class="pubdef"><span class="pred-tag">[det]</span><a id="http_logrotate/1"><strong>http_logrotate</strong>(<var>+Options</var>)</a></dt>
<dd class="defbody">
Rotate the available log files. Note that there are two ways to deal 
with the rotation of log files:

<p>
<ol class="latex">
<li>Use the OS log rotation facility. In that case the OS must (1) move 
the logfile and (2) have something calling
<a class="pred" href="#http_log_close/1">http_log_close/1</a> to close 
the (moved) file and make this server create a new one on the next log 
message. If
<code>library(http/http_unix_daemon)</code> is used, closing is achieved 
by sending SIGHUP or SIGUSR1 to the process.
<li>Call this predicate at scheduled intervals. This can be achieved by 
calling <a class="pred" href="#http_schedule_logrotate/2">http_schedule_logrotate/2</a> 
in the context of <code>library(http/http_unix_daemon)</code> which 
schedules the maintenance actions.
</ol>

<p><var>Options</var>:

<dl class="latex">
<dt><strong>min_size</strong>(<var>+Bytes</var>)</dt>
<dd class="defbody">
Do not rotate if the log file is smaller than <var>Bytes</var>. The 
default is 1Mbytes.
</dd>
<dt><strong>keep_logs</strong>(<var>+Count</var>)</dt>
<dd class="defbody">
Number of rotated log files to keep (default 10)
</dd>
<dt><strong>compress_logs</strong>(<var>+Format</var>)</dt>
<dd class="defbody">
Compress the log files to the given format.
</dd>
<dt><strong>background</strong>(<var>+Boolean</var>)</dt>
<dd class="defbody">
If <code>true</code>, rotate the log files in the background.
</dd>
</dl>

</dd>
<dt class="pubdef"><a id="http_schedule_logrotate/2"><strong>http_schedule_logrotate</strong>(<var>When, 
Options</var>)</a></dt>
<dd class="defbody">
Schedule log rotation based on maintenance broadcasts. <var>When</var> 
is one of:

<dl class="latex">
<dt><strong>daily</strong>(<var>Hour:Min</var>)</dt>
<dd class="defbody">
Run each day at <var>Hour</var>:<var>Min</var>. <var>Min</var> is 
rounded to a multitude of 5.
</dd>
<dt><strong>weekly</strong>(<var>Day, Hour:Min</var>)</dt>
<dd class="defbody">
Run at the given <var>Day</var> and Time each week. <var>Day</var> is 
either a number 1..7 (1 is Monday) or a weekday name or abbreviation.
</dd>
<dt><strong>monthly</strong>(<var>DayOfTheMonth, Hour:Min</var>)</dt>
<dd class="defbody">
Run each month at the given Day (1..31). Note that not all months have 
all days.
</dd>
</dl>

<p>This must be used with a timer that broadcasts a
<code>maintenance(_,_)</code> message (see <span class="pred-ext">broadcast/1</span>). 
Such a timer is part of <code>library(http/http_unix_daemon)</code>.
</dd>
</dl>

<p><h3 id="sec:httpserverhealth"><a id="sec:3.18"><span class="sec-nr">3.18</span> <span class="sec-title">library(http/http_server_health): 
HTTP Server health statistics</span></a></h3>

<p><a id="sec:httpserverhealth"></a>

<p>This module defines an HTTP handler for <code>/health</code>. The 
handler returns a JSON document with elementary health statistics on the 
running instance. The location can be changed using <a class="pred" href="#http_handler/3">http_handler/3</a>. 
Keys may be added using additional clauses for <a class="pred" href="#health/2">health/2</a> 
or hidden using <a class="pred" href="#hide/1">hide/1</a>.

<p>This library defines an HTTP handler and defines two multifile 
predicates (<a class="pred" href="#health/2">health/2</a> and <a class="pred" href="#hide/1">hide/1</a>) 
to control the information presented.

<dl class="latex">
<dt class="pubdef"><a id="server_health/1"><strong>server_health</strong>(<var>+Request</var>)</a></dt>
<dd class="defbody">
HTTP handler that replies with the overall health of the server. Returns 
a JSON object from all solutions of <a class="pred" href="#health/2">health/2</a>.

<p>Processes an optional parameter <code>fields</code> to specify the 
fields that should be returned. The fields content is "," or white space 
delimited.</dd>
<dt class="multidef"><span class="pred-tag">[nondet,multifile]</span><a id="health/2"><strong>health</strong>(<var>-Key, 
-Value</var>)</a></dt>
<dd class="defbody">
Multifile extensible. True when <var>Key</var>/<var>Value</var> can be 
reported as a health statistics. Keys may be added by adding clauses to 
this multifile predicate. Keys may be filtered using <a class="pred" href="#hide/1">hide/1</a>. 
Predefined
<var>Key</var> values are:

<dl class="latex">
<dt><strong>up</strong></dt>
<dd class="defbody">
Defined to be <code>true</code>.
</dd>
<dt><strong>epoch</strong></dt>
<dd class="defbody">
Starting time of the server in seconds after Jan 1, 1970 UTC.
</dd>
<dt><strong>cpu_time</strong></dt>
<dd class="defbody">
Total process CPU usage in seconds.
</dd>
<dt><strong>threads</strong></dt>
<dd class="defbody">
Number of active threads
</dd>
<dt><strong>workers</strong></dt>
<dd class="defbody">
Number of HTTP <i>worker</i> threads.
</dd>
<dt><strong>requests</strong></dt>
<dd class="defbody">
Number of HTTP requests processed.
</dd>
<dt><strong>bytes_sent</strong></dt>
<dd class="defbody">
Number of bytes send in reply to HTTP requests.
</dd>
<dt><strong>open_files</strong></dt>
<dd class="defbody">
Number of open file streams. This includes physical files as well as 
sockets (except for Windows). On Linux we count the file handles in <code>/proc/self/fd</code>. 
Otherwise we use
<span class="pred-ext">stream_property/2</span> with the <code>file_no(Fd)</code> 
property.
</dd>
<dt><strong>loadavg</strong></dt>
<dd class="defbody">
An array holding the load average over the last [1,5,15] minutes. This 
key is only supported on Linux machines. It is based on <code>/proc/loadavg</code>
</dd>
<dt><strong>heap</strong></dt>
<dd class="defbody">
When compiled with TCMalloc, this provides two properties:

<dl class="latex">
<dt><var><code>inuse</code></var><strong><code>:</code></strong><var><var>Bytes</var></var></dt>
<dd class="defbody">
Total amount of in-use memory in bytes
</dd>
<dt><var><code>size</code></var><strong><code>:</code></strong><var><var>Bytes</var></var></dt>
<dd class="defbody">
Same as <code>inuse</code>, but including the TCMalloc overhead and 
(thus) memory that has been freed and is not (yet) reused.
</dd>
</dl>

</dd>
</dl>

<table class="arglist">
<tr><td><var>Key</var> </td><td>is the name of the JSON key. Must be an 
atom </td></tr>
<tr><td><var>Value</var> </td><td>is the Prolog representation for a 
JSON (dict) value. </td></tr>
</table>
</dd>
<dt class="multidef"><span class="pred-tag">[nondet,multifile]</span><a id="hide/1"><strong>hide</strong>(<var>?Key</var>)</a></dt>
<dd class="defbody">
Multifile hook. If true for a specific <var>Key</var>, hide this 
statistics from the output. This may be used to hide keys that are 
considered a security risk.
</dd>
</dl>

<p><h3 id="sec:http-debug"><a id="sec:3.19"><span class="sec-nr">3.19</span> <span class="sec-title">Debugging 
HTTP servers</span></a></h3>

<a id="sec:http-debug"></a>

<p>The library <code>library(http/http_error)</code> defines a hook that 
decorates uncaught exceptions with a stack-trace. This will generate a <em>500 
internal server error</em> document with a stack-trace. To enable this 
feature, simply load this library. Please do note that providing error 
information to the user simplifies the job of a hacker trying to 
compromise your server. It is therefore not recommended to load this 
file by default.

<p>The example program <code>calc.pl</code> has the error handler loaded 
which can be triggered by forcing a divide-by-zero in the calculator.

<p><h3 id="sec:httpheader"><a id="sec:3.20"><span class="sec-nr">3.20</span> <span class="sec-title">library(http/http_header): 
Handling HTTP headers</span></a></h3>

<p><a id="sec:httpheader"></a>

<p>The library <code>library(http/http_header)</code> provides 
primitives for parsing and composing HTTP headers. Its functionality is 
normally hidden by the other parts of the HTTP server and client 
libraries.

<dl class="latex">
<dt class="pubdef"><span class="pred-tag">[det]</span><a id="http_read_request/2"><strong>http_read_request</strong>(<var>+FdIn:stream, 
-Request</var>)</a></dt>
<dd class="defbody">
Read an HTTP request-header from <var>FdIn</var> and return the 
broken-down request fields as +Name(+Value) pairs in a list. <var>Request</var> 
is unified to <code>end_of_file</code> if <var>FdIn</var> is at the end 
of input.</dd>
<dt class="pubdef"><a id="http_read_reply_header/2"><strong>http_read_reply_header</strong>(<var>+FdIn, 
-Reply</var>)</a></dt>
<dd class="defbody">
Read the HTTP reply header. Throws an exception if the current input 
does not contain a valid reply header.</dd>
<dt class="pubdef"><span class="pred-tag">[det]</span><a id="http_reply/2"><strong>http_reply</strong>(<var>+Data, 
+Out:stream</var>)</a></dt>
<dt class="pubdef"><span class="pred-tag">[det]</span><a id="http_reply/3"><strong>http_reply</strong>(<var>+Data, 
+Out:stream, +HdrExtra</var>)</a></dt>
<dt class="pubdef"><span class="pred-tag">[det]</span><a id="http_reply/4"><strong>http_reply</strong>(<var>+Data, 
+Out:stream, +HdrExtra, -Code</var>)</a></dt>
<dt class="pubdef"><span class="pred-tag">[det]</span><a id="http_reply/5"><strong>http_reply</strong>(<var>+Data, 
+Out:stream, +HdrExtra, +Context, -Code</var>)</a></dt>
<dt class="pubdef"><span class="pred-tag">[det]</span><a id="http_reply/6"><strong>http_reply</strong>(<var>+Data, 
+Out:stream, +HdrExtra, +Context, +Request, -Code</var>)</a></dt>
<dd class="defbody">
Compose a complete HTTP reply from the term <var>Data</var> using 
additional headers from <var>HdrExtra</var> to the output stream <var>Out</var>. 
ExtraHeader is a list of Field(Value). <var>Data</var> is one of:

<dl class="latex">
<dt><strong>html</strong>(<var>HTML</var>)</dt>
<dd class="defbody">
<var>HTML</var> tokens as produced by <a class="pred" href="#html//1">html//1</a> 
from <code>html_write.pl</code>
</dd>
<dt><strong>file</strong>(<var>+MimeType, +FileName</var>)</dt>
<dd class="defbody">
Reply content of <var>FileName</var> using <var>MimeType</var>
</dd>
<dt><strong>file</strong>(<var>+MimeType, +FileName, +Range</var>)</dt>
<dd class="defbody">
Reply partial content of <var>FileName</var> with given <var>MimeType</var>
</dd>
<dt><strong>tmp_file</strong>(<var>+MimeType, +FileName</var>)</dt>
<dd class="defbody">
Same as <code>file</code>, but do not include modification time
</dd>
<dt><strong>bytes</strong>(<var>+MimeType, +Bytes</var>)</dt>
<dd class="defbody">
Send a sequence of <var>Bytes</var> with the indicated <var>MimeType</var>.
<var>Bytes</var> is either a string of character codes 0..255 or list of 
integers in the range 0..255. <var>Out</var>-of-bound codes result in a 
representation error exception.
</dd>
<dt><strong>stream</strong>(<var>+In, +Len</var>)</dt>
<dd class="defbody">
Reply content of stream.
</dd>
<dt><strong>cgi_stream</strong>(<var>+In, +Len</var>)</dt>
<dd class="defbody">
Reply content of stream, which should start with an HTTP header, 
followed by a blank line. This is the typical output from a CGI script.
</dd>
<dt><strong><var>Status</var></strong></dt>
<dd class="defbody">
HTTP status report as defined by <a class="pred" href="#http_status_reply/4">http_status_reply/4</a>.
</dd>
</dl>

<table class="arglist">
<tr><td><var>HdrExtra</var> </td><td>provides additional reply-header 
fields, encoded as Name(Value). It can also contain a field
<code>content_length(-Len)</code> to <i>retrieve</i> the value of the 
Content-length header that is replied. </td></tr>
<tr><td><var>Code</var> </td><td>is the numeric HTTP status code sent </td></tr>
</table>

<dl class="tags">
<dt class="tag">To be done</dt>
<dd>
Complete documentation
</dd>
</dl>

</dd>
<dt class="pubdef"><span class="pred-tag">[det]</span><a id="http_status_reply/4"><strong>http_status_reply</strong>(<var>+Status, 
+Out, +HdrExtra, -Code</var>)</a></dt>
<dt class="pubdef"><span class="pred-tag">[det]</span><a id="http_status_reply/5"><strong>http_status_reply</strong>(<var>+Status, 
+Out, +HdrExtra, +Context, -Code</var>)</a></dt>
<dt class="pubdef"><span class="pred-tag">[det]</span><a id="http_status_reply/6"><strong>http_status_reply</strong>(<var>+Status, 
+Out, +HdrExtra, +Context, +Request, -Code</var>)</a></dt>
<dd class="defbody">
Emit HTML non-200 status reports. Such requests are always sent as UTF-8 
documents.

<p><var>Status</var> can be one of the following:

<dl class="latex">
<dt><strong>authorise</strong>(<var>Method</var>)</dt>
<dd class="defbody">
Challenge authorization. <var>Method</var> is one of

<p>
<ul class="compact">
<li><code>basic(Realm)</code>
<li><code>digest(Digest)</code>
</ul>
</dd>
<dt><strong>authorise</strong>(<var>basic, Realm</var>)</dt>
<dd class="defbody">
Same as <code>authorise(basic(Realm))</code>. Deprecated.
</dd>
<dt><strong>bad_request</strong>(<var>ErrorTerm</var>)</dt>
<dt><strong>busy</strong></dt>
<dt><strong>created</strong>(<var>Location</var>)</dt>
<dt><strong>forbidden</strong>(<var>Url</var>)</dt>
<dt><strong>moved</strong>(<var>To</var>)</dt>
<dt><strong>moved_temporary</strong>(<var>To</var>)</dt>
<dt><strong>no_content</strong></dt>
<dt><strong>not_acceptable</strong>(<var>WhyHtml</var>)</dt>
<dt><strong>not_found</strong>(<var>Path</var>)</dt>
<dt><strong>method_not_allowed</strong>(<var>Method, Path</var>)</dt>
<dt><strong>not_modified</strong></dt>
<dt><strong>resource_error</strong>(<var>ErrorTerm</var>)</dt>
<dt><strong>see_other</strong>(<var>To</var>)</dt>
<dt><strong>switching_protocols</strong>(<var>Goal, Options</var>)</dt>
<dt><strong>server_error</strong>(<var>ErrorTerm</var>)</dt>
<dt><strong>unavailable</strong>(<var>WhyHtml</var>)</dt>
<dd class="defbody">
</dd>
</dl>

</dd>
<dt class="multidef"><span class="pred-tag">[semidet,multifile]</span><a id="http:serialize_reply/2"><span class="module">http</span>:<strong>serialize_reply</strong>(<var>+Reply, 
-Body</var>)</a></dt>
<dd class="defbody">
Multifile hook to serialize the result of <span class="pred-ext">http:status_reply/3</span> 
into a term

<dl class="latex">
<dt><strong>body</strong>(<var>Type, Encoding, Content</var>)</dt>
<dd class="defbody">
In this term, <var>Type</var> is the media type, <var>Encoding</var> is 
the required wire encoding and <var>Content</var> a string representing 
the content.
</dd>
</dl>

</dd>
<dt class="pubdef"><a id="http_join_headers/3"><strong>http_join_headers</strong>(<var>+Default, 
+Header, -Out</var>)</a></dt>
<dd class="defbody">
Append headers from <var>Default</var> to <var>Header</var> if they are 
not already part of it.</dd>
<dt class="pubdef"><a id="http_update_encoding/3"><strong>http_update_encoding</strong>(<var>+HeaderIn, 
-Encoding, -HeaderOut</var>)</a></dt>
<dd class="defbody">
Allow for rewrite of the header, adjusting the encoding. We distinguish 
three options. If the user announces&lsquo;text&rsquo;, we always use 
UTF-8 encoding. If the user announces charset=utf-8 we use UTF-8 and 
otherwise we use octet (raw) encoding. Alternatively we could 
dynamically choose for ASCII, ISO-Latin-1 or UTF-8.</dd>
<dt class="multidef"><span class="pred-tag">[semidet,multifile]</span><a id="http:mime_type_encoding/2"><span class="module">http</span>:<strong>mime_type_encoding</strong>(<var>+MimeType, 
-Encoding</var>)</a></dt>
<dd class="defbody">
<var>Encoding</var> is the (default) character encoding for <var>MimeType</var>. 
This is used for setting the encoding for HTTP replies after the user 
calls
<code>format('Content-type: &lt;MIME type&gt;~n')</code>. This hook is 
called before
<span class="pred-ext">mime_type_encoding/2</span>. This default defines <code>utf8</code> 
for JSON and Turtle derived <code>application/</code> MIME types.</dd>
<dt class="pubdef"><a id="http_update_connection/4"><strong>http_update_connection</strong>(<var>+CGIHeader, 
+Request, -Connection, -Header</var>)</a></dt>
<dd class="defbody">
Merge keep-alive information from <var>Request</var> and <var>CGIHeader</var> 
into
<var>Header</var>.</dd>
<dt class="pubdef"><a id="http_update_transfer/4"><strong>http_update_transfer</strong>(<var>+Request, 
+CGIHeader, -Transfer, -Header</var>)</a></dt>
<dd class="defbody">
Decide on the transfer encoding from the <var>Request</var> and the CGI 
header. The behaviour depends on the setting http:chunked_transfer. If <code>never</code>, 
even explitic requests are ignored. If <code>on_request</code>, chunked 
encoding is used if requested through the CGI header and allowed by the 
client. If
<code>if_possible</code>, chunked encoding is used whenever the client 
allows for it, which is interpreted as the client supporting HTTP 1.1 or 
higher.

<p>Chunked encoding is more space efficient and allows the client to 
start processing partial results. The drawback is that errors lead to 
incomplete pages instead of a nicely formatted complete page.</dd>
<dt class="pubdef"><span class="pred-tag">[det]</span><a id="http_post_data/3"><strong>http_post_data</strong>(<var>+Data, 
+Out:stream, +HdrExtra</var>)</a></dt>
<dd class="defbody">
Send data on behalf on an HTTP POST request. This predicate is normally 
called by <a class="pred" href="#http_post/4">http_post/4</a> from <code>http_client.pl</code> 
to send the POST data to the server. <var>Data</var> is one of:

<p>
<ul class="latex">
<li><code>html(+Tokens)</code> Result of <a class="pred" href="#html//1">html//1</a> 
from <code>html_write.pl</code>
<li><code>json(+Term)</code> Posting a JSON query and processing the 
JSON reply (or any other reply understood by <a class="pred" href="#http_read_data/3">http_read_data/3</a>) 
is simple as
<code>http_post(URL, json(Term), Reply, [])</code>, where Term is a JSON 
term as described in <code>json.pl</code> and reply is of the same 
format if the server replies with JSON, when using module <code>:- use_module(library(http/http_json))</code>. 
Note that the module is used in both http server and http client, see
<code>library(http/http_json)</code>.
<li><code>xml(+Term)</code> Post the result of <span class="pred-ext">xml_write/3</span> 
using the Mime-type
<code>text/xml</code>
<li><code>xml(+Type, +Term)</code> Post the result of <span class="pred-ext">xml_write/3</span> 
using the given Mime-type and an empty option list to <span class="pred-ext">xml_write/3</span>.
<li><code>xml(+Type, +Term, +Options)</code> Post the result of <span class="pred-ext">xml_write/3</span> 
using the given Mime-type and option list for <span class="pred-ext">xml_write/3</span>.
<li><code>file(+File)</code> Send contents of a file. Mime-type is 
determined by
<span class="pred-ext">file_mime_type/2</span>.
<li><code>file(+Type, +File)</code> Send file with content of indicated 
mime-type.
<li><code>memory_file(+Type, +Handle)</code> Similar to <code>file(+Type, +File)</code>, 
but using a memory file instead of a real file. See <span class="pred-ext">new_memory_file/1</span>.
<li><code>codes(+Codes)</code> As <code>codes(text/plain, Codes)</code>.
<li><code>codes(+Type, +Codes)</code> Send Codes using the indicated 
MIME-type.
<li><code>bytes(+Type, +Bytes)</code> Send Bytes using the indicated 
MIME-type. Bytes is either a string of character codes 0..255 or list of 
integers in the range 0..255. <var>Out</var>-of-bound codes result in a 
representation error exception.
<li><code>atom(+Atom)</code> As <code>atom(text/plain, Atom)</code>.
<li><code>atom(+Type, +Atom)</code> Send Atom using the indicated 
MIME-type.
<li><code>string(+String)</code>
<li><code>string(+Type, +String)</code> Similar to <code>atom(Atom)</code> 
and <code>atom(Type,Atom)</code>, accepting a SWI-Prolog string.
<li><code>cgi_stream(+Stream, +Len)</code> Read the input from Stream 
which, like CGI data starts with a partial HTTP header. The fields of 
this header are merged with the provided <var>HdrExtra</var> fields. The 
first Len characters of Stream are used.
<li><code>form(+ListOfParameter)</code> Send data of the MIME type 
application/x-www-form-urlencoded as produced by browsers issuing a POST 
request from an HTML form. ListOfParameter is a list of Name=Value or 
Name(Value).
<li><code>form_data(+ListOfData)</code> Send data of the MIME type <code>multipart/form-data</code> 
as produced by browsers issuing a POST request from an HTML form using 
enctype <code>multipart/form-data</code>. ListOfData is the same as for 
the List alternative described below. Below is an example. Repository, 
etc. are atoms providing the value, while the last argument provides a 
value from a file.

<pre class="code">
...,
http_post([ protocol(http),
            host(Host),
            port(Port),
            path(ActionPath)
          ],
          form_data([ repository = Repository,
                      dataFormat = DataFormat,
                      baseURI    = BaseURI,
                      verifyData = Verify,
                      data       = file(File)
                    ]),
          _Reply,
          []),
...,
</pre>

<p>
<li>List If the argument is a plain list, it is sent using the MIME type 
multipart/mixed and packed using <a class="pred" href="#mime_pack/3">mime_pack/3</a>. 
See <a class="pred" href="#mime_pack/3">mime_pack/3</a> for details on 
the argument format.
</ul>
</dd>
<dt class="pubdef"><span class="pred-tag">[det]</span><a id="http_reply_header/3"><strong>http_reply_header</strong>(<var>+Out:stream, 
+What, +HdrExtra</var>)</a></dt>
<dd class="defbody">
Create a reply header using <span class="pred-ext">reply_header//3</span> 
and send it to Stream.</dd>
<dt class="pubdef"><span class="pred-tag">[semidet]</span><a id="http_parse_header_value/3"><strong>http_parse_header_value</strong>(<var>+Field, 
+Value, -Prolog</var>)</a></dt>
<dd class="defbody">
Translate <var>Value</var> in a meaningful <var>Prolog</var> term. <var>Field</var> 
denotes the HTTP request field for which we do the translation. 
Supported fields are:

<dl class="latex">
<dt><strong>content_length</strong></dt>
<dd class="defbody">
Converted into an integer
</dd>
<dt><strong>status</strong></dt>
<dd class="defbody">
Converted into an integer
</dd>
<dt><strong>cookie</strong></dt>
<dd class="defbody">
Converted into a list with Name=<var>Value</var> by <span class="pred-ext">cookies//1</span>.
</dd>
<dt><strong>set_cookie</strong></dt>
<dd class="defbody">
Converted into a term <code>set_cookie(Name, Value, Options)</code>. 
Options is a list consisting of Name=<var>Value</var> or a single atom 
(e.g., <code>secure</code>)
</dd>
<dt><strong>host</strong></dt>
<dd class="defbody">
Converted to HostName:Port if applicable.
</dd>
<dt><strong>range</strong></dt>
<dd class="defbody">
Converted into <code>bytes(From, To)</code>, where From is an integer 
and To is either an integer or the atom <code>end</code>.
</dd>
<dt><strong>accept</strong></dt>
<dd class="defbody">
Parsed to a list of media descriptions. Each media is a term
<code>media(Type, TypeParams, Quality, AcceptExts)</code>. The list is 
sorted according to preference.
</dd>
<dt><strong>content_disposition</strong></dt>
<dd class="defbody">
Parsed into <code>disposition(Name, Attributes)</code>, where Attributes 
is a list of Name=<var>Value</var> pairs.
</dd>
<dt><strong>content_type</strong></dt>
<dd class="defbody">
Parsed into <code>media(Type/SubType, Attributes)</code>, where 
Attributes is a list of Name=<var>Value</var> pairs.
</dd>
<dt><strong>expires</strong></dt>
<dd class="defbody">
Parsed into a time stamp using <a class="pred" href="#http_timestamp/2">http_timestamp/2</a>.
</dd>
</dl>

<p>As some fields are already parsed in the <var>Request</var>, this 
predicate is a no-op when called on an already parsed field.
<table class="arglist">
<tr><td><var>Value</var> </td><td>is either an atom, a list of codes or 
an already parsed header value. </td></tr>
</table>
</dd>
<dt class="pubdef"><span class="pred-tag">[det]</span><a id="http_timestamp/2"><strong>http_timestamp</strong>(<var>?Time:timestamp, 
?Text:atom</var>)</a></dt>
<dd class="defbody">
Convert between a SWI-Prolog time stamp and a string in HTTP format 
(RFC1123). When parsing, it accepts RFC1123, RFC1036 and ASCTIME 
formats. See <span class="pred-ext">parse_time/3</span>.

<dl class="tags">
<dt class="tag">Errors</dt>
<dd>
<code>syntax_error(http_timestamp(Text))</code> if the string cannot be 
parsed.
</dd>
</dl>

</dd>
<dt class="pubdef"><span class="pred-tag">[det]</span><a id="http_read_header/2"><strong>http_read_header</strong>(<var>+Fd, 
-Header</var>)</a></dt>
<dd class="defbody">
Read Name: Value lines from FD until an empty line is encountered. 
Field-name are converted to Prolog conventions (all lower, _ instead of 
-): Content-Type: text/html <code>--&gt;</code> <code>content_type(text/html)</code></dd>
<dt class="pubdef"><span class="pred-tag">[det]</span><a id="http_parse_header/2"><strong>http_parse_header</strong>(<var>+Text:codes, 
-Header:list</var>)</a></dt>
<dd class="defbody">
<var>Header</var> is a list of Name(Value)-terms representing the 
structure of the HTTP header in <var>Text</var>.

<dl class="tags">
<dt class="tag">Errors</dt>
<dd>
<code>domain_error(http_request_line, Line)</code>
</dd>
</dl>

</dd>
<dt class="multidef"><span class="pred-tag">[det,multifile]</span><a id="http:///1"><span class="module">http</span>:<strong>//</strong>(<var>http_address</var>)</a></dt>
<dd class="defbody">
HTML-rule that emits the location of the HTTP server. This hook is 
called from <span class="pred-ext">address//0</span> to customise the 
server address. The server address is emitted on non-200-ok replies.</dd>
<dt class="multidef"><span class="pred-tag">[semidet,multifile]</span><a id="http:status_page/3"><span class="module">http</span>:<strong>status_page</strong>(<var>+Status, 
+Context, -HTMLTokens</var>)</a></dt>
<dd class="defbody">
Hook called by <a class="pred" href="#http_status_reply/4">http_status_reply/4</a> 
and <a class="pred" href="#http_status_reply/5">http_status_reply/5</a> 
that allows for emitting custom error pages for the following HTTP page 
types:

<p>
<ul class="compact">
<li>201 - <code>created(Location)</code>
<li>301 - <code>moved(To)</code>
<li>302 - <code>moved_temporary(To)</code>
<li>303 - <code>see_other(To)</code>
<li>400 - <code>bad_request(ErrorTerm)</code>
<li>401 - <code>authorise(AuthMethod)</code>
<li>403 - <code>forbidden(URL)</code>
<li>404 - <code>not_found(URL)</code>
<li>405 - <code>method_not_allowed(Method,URL)</code>
<li>406 - <code>not_acceptable(Why)</code>
<li>500 - <code>server_error(ErrorTerm)</code>
<li>503 - <code>unavailable(Why)</code>
</ul>

<p>The hook is tried twice, first using the status term, e.g.,
<code>not_found(URL)</code> and than with the code, e.g. <code>404</code>. 
The second call is deprecated and only exists for compatibility.
<table class="arglist">
<tr><td><var>Context</var> </td><td>is the 4th argument of <a class="pred" href="#http_status_reply/5">http_status_reply/5</a>, 
which is invoked after raising an exception of the format
<code>http_reply(Status, HeaderExtra, Context)</code>. The default 
context is <code>[]</code> (the empty list). </td></tr>
<tr><td><var>HTMLTokens</var> </td><td>is a list of tokens as produced 
by <a class="pred" href="#html//1">html//1</a>. It is passed to <a class="pred" href="#print_html/2">print_html/2</a>. </td></tr>
</table>
</dd>
</dl>

<p><h3 id="sec:htmlwrite"><a id="sec:3.21"><span class="sec-nr">3.21</span> <span class="sec-title">The <code>library(http/html_write)</code> 
library</span></a></h3>

<a id="sec:htmlwrite"></a>

<p>Producing output for the web in the form of an HTML document is a 
requirement for many Prolog programs. Just using <a id="idx:format2:48"></a><span class="pred-ext">format/2</span> 
is not satisfactory as it leads to poorly readable programs generating 
poor HTML. This library is based on using DCG rules.

<p>The <code>library(http/html_write)</code> structures the generation 
of HTML from a program. It is an extensible library, providing a <em>DCG</em> 
framework for generating legal HTML under (Prolog) program control. It 
is especially useful for the generation of structured pages (e.g. tables) 
from Prolog data structures.

<p>The normal way to use this library is through the DCG html//1. This 
non-terminal provides the central translation from a structured term 
with embedded calls to additional translation rules to a list of atoms 
that can then be printed using <a id="idx:printhtml12:49"></a><a class="pred" href="#print_html/1">print_html/[1,2]</a>.

<dl class="latex">
<dt class="pubdef"><a id="html//1"><strong>html</strong>(<var>:Spec</var>)</a><code>//</code></dt>
<dd class="defbody">
The DCG non-terminal html//1 is the main predicate of this library. It 
translates the specification for an HTML page into a list of atoms that 
can be written to a stream using <a id="idx:printhtml12:50"></a><a class="pred" href="#print_html/1">print_html/[1,2]</a>. 
The expansion rules of this predicate may be extended by defining the 
multifile DCG html_write:expand//1. <var>Spec</var> is either a single 
specification or a list of single specifications. Using nested lists is 
not allowed to avoid ambiguity caused by the atom <code><code>[]</code></code>

<p>
<ul class="latex">
<li><i>Atomic data</i><br>
Atomic data is quoted using html_quoted//1.

<p>
<li><i><var>Fmt</var> - <var>Args</var></i><br>
<var>Fmt</var> and <var>Args</var> are used as format-specification and 
argument list to <a id="idx:format3:51"></a><span class="pred-ext">format/3</span>. 
The result is quoted and added to the output list.

<p>
<li><i><code>\</code><var>List</var></i><br>
Escape sequence to add atoms directly to the output list. This can be 
used to embed external HTML code or emit script output. <var>List</var> 
is a list of the following terms:

<p>
<ul class="latex">
<li><i><var>Fmt</var> - <var>Args</var></i><br>
<var>Fmt</var> and <var>Args</var> are used as format-specification and 
argument list to <a id="idx:format3:52"></a><span class="pred-ext">format/3</span>. 
The result is added to the output list.
<li><i><var>Atomic</var></i><br>
Atomic values are added directly to the output list.
</ul>

<p>
<li><i><code>\</code><var>Term</var></i><br>
Invoke the non-terminal <var>Term</var> in the calling module. This is 
the common mechanism to realise abstraction and modularisation in 
generating HTML.

<p>
<li><i><var>Module</var>:<var>Term</var></i><br>
Invoke the non-terminal &lt;<var>Module</var>&gt;:&lt;<var>Term</var>&gt;. 
This is similar to
<code>\</code><var>Term</var> but allows for invoking grammar rules in 
external packages.

<p>
<li><i>&amp;(Entity)</i><br>
Emit <code>&amp;&lt;<var>Entity</var>&gt;;</code> or <code>&amp;#&lt;<var>Entity</var>&gt;;</code> 
if <var>Entity</var> is an integer. SWI-Prolog atoms and strings are 
represented as Unicode. Explicit use of this construct is rarely needed 
because code-points that are not supported by the output encoding are 
automatically converted into character-entities.

<p>
<li><i><code>Tag(Content)</code></i><br>
Emit HTML element <var>Tag</var> using <var>Content</var> and no 
attributes.
<var>Content</var> is handed to html//1. See <a class="sec" href="#sec:3.21.4">section 
3.21.4</a> for details on the automatically generated layout.

<p>
<li><i><code>Tag(Attributes, Content)</code></i><br>
Emit HTML element <var>Tag</var> using <var>Attributes</var> and <var>Content</var>.
<var>Attributes</var> is either a single attribute of a list of 
attributes. Each attributes is of the format <code>Name(Value)</code> or
<var>Name</var>=<var>Value</var>. <var>Value</var> is the atomic 
attribute value but allows for a limited functional notation:

<p>
<ul class="latex">
<li><i><var>A</var> + <var>B</var></i><br>
Concatenation of <var>A</var> and <var>B</var>
<li><i><var>Format</var>-<var>Arguments</var></i><br>
Use <a id="idx:format3:53"></a><span class="pred-ext">format/3</span> 
and emit the result as quoted value.
<li><i><code>encode(Atom)</code></i><br>
Use <a id="idx:uriencoded3:54"></a><span class="pred-ext">uri_encoded/3</span> 
to create a valid URL query component.
<li><i><code>location_by_id(ID)</code></i><br>
HTTP location of the HTTP handler with given ID. See <a id="idx:httplocationbyid2:55"></a><a class="pred" href="#http_location_by_id/2">http_location_by_id/2</a>.
<li><i><code><code>#</code>(ID)</code></i><br>
Abbreviated for for <code>location_by_id(ID)</code>.
<li><i><var>A</var> + <var>List</var></i><br>
<var>List</var> is handled as a URL&lsquo;search&rsquo;component. The 
list members are terms of the format <var>Name</var> = <var>Value</var> 
or
<code>Name(Value)</code>. Values are encoded as in the encode option 
described above.
<li><i><var>List</var></i><br>
Emit SGML multi-valued attributes (e.g., <code>NAMES</code>). Each value 
in list is separated by a space. This is particularly useful for setting 
multiple <code>class</code> attributes on an element. For example:

<pre class="code">
        ...
        span(class([c1,c2]), ...),
</pre>

<p>
</ul>

<p>The example below generates a URL that references the predicate
<a id="idx:setlang1:56"></a><span class="pred-ext">set_lang/1</span> in 
the application with given parameters. The <a id="idx:httphandler3:57"></a><a class="pred" href="#http_handler/3">http_handler/3</a> 
declaration binds <code>/setlang</code> to the predicate <a id="idx:setlang1:58"></a><span class="pred-ext">set_lang/1</span> 
for which we provide a very simple implementation. The code between <code>...</code> 
is part of an HTML page showing the english flag which, when pressed, 
calls <code>set_lang(Request)</code> where <var>Request</var> contains 
the search parameter <code>lang</code> = <code>en</code>. Note that the 
HTTP location (path) <code>/setlang</code> can be moved without 
affecting this code.

<pre class="code">
:- http_handler('/setlang', set_lang, []).

set_lang(Request) :-
        http_parameters(Request,
                        [ lang(Lang, [])
                        ]),
        http_session_retractall(lang(_)),
        http_session_assert(lang(Lang)),
        reply_html_page(title('Switched language'),
                        p(['Switch language to ', Lang])).


        ...
        html(a(href(location_by_id(set_lang) + [lang(en)]),
               img(src('/www/images/flags/en.png')))),
        ...
</pre>

<p>
</ul>
</dd>
<dt class="pubdef"><a id="page//2"><strong>page</strong>(<var>:HeadContent, 
:BodyContent</var>)</a><code>//</code></dt>
<dd class="defbody">
The DCG non-terminal page//2 generated a complete page, including the 
SGML
<code>DOCTYPE</code> declaration. <var>HeadContent</var> are elements to 
be placed in the <code>head</code> element and <var>BodyContent</var> 
are elements to be placed in the <code>body</code> element.

<p>To achieve common style (background, page header and footer), it is 
possible to define DCG non-terminals head//1 and/or body//1. 
Non-terminal page//1 checks for the definition of these non-terminals in 
the module it is called from as well as in the <code>user</code> module. 
If no definition is found, it creates a head with only the <var>HeadContent</var> 
(note that the
<code>title</code> is obligatory) and a <code>body</code> with <code>bgcolor</code> 
set to <code>white</code> and the provided <var>BodyContent</var>.

<p>Note that further customisation is easily achieved using html//1 
directly as page//2 is (besides handling the hooks) defined as:

<pre class="code">
page(Head, Body) --&gt;
        html([ \['&lt;!DOCTYPE HTML PUBLIC "-//IETF//DTD HTML 4.0//EN"&gt;\n'],
               html([ head(Head),
                      body(bgcolor(white), Body)
                    ])
             ]).
</pre>

</dd>
<dt class="pubdef"><a id="page//1"><strong>page</strong>(<var>:Contents</var>)</a><code>//</code></dt>
<dd class="defbody">
This version of the <a id="idx:page12:59"></a><span class="pred-ext">page/[1,2]</span> 
only gives you the SGML <code>DOCTYPE</code> and the <code>HTML</code> 
element. <var>Contents</var> is used to generate both the head and body 
of the page.</dd>
<dt class="pubdef"><a id="html_begin//1"><strong>html_begin</strong>(<var>+Begin</var>)</a><code>//</code></dt>
<dd class="defbody">
Just open the given element. <var>Begin</var> is either an atom or a 
compound term, In the latter case the arguments are used as arguments to 
the begin-tag. Some examples:

<pre class="code">
        html_begin(table)
        html_begin(table(border(2), align(center)))
</pre>

<p>This predicate provides an alternative to using the
<code>\</code><var>Command</var> syntax in the html//1 specification. 
The following two fragments are the same. The preferred solution depends 
on your preferences as well as whether the specification is generated or 
entered by the programmer.

<pre class="code">
table(Rows) --&gt;
        html(table([border(1), align(center), width('80%')],
                   [ \table_header,
                     \table_rows(Rows)
                   ])).

% or

table(Rows) --&gt;
        html_begin(table(border(1), align(center), width('80%'))),
        table_header,
        table_rows,
        html_end(table).
</pre>

</dd>
<dt class="pubdef"><a id="html_end//1"><strong>html_end</strong>(<var>+End</var>)</a><code>//</code></dt>
<dd class="defbody">
End an element. See <a id="idx:htmlbegin1:60"></a><span class="pred-ext">html_begin/1</span> 
for details.
</dd>
</dl>

<p><h4 id="sec:html-write"><a id="sec:3.21.1"><span class="sec-nr">3.21.1</span> <span class="sec-title">Emitting 
HTML documents</span></a></h4>

<a id="sec:html-write"></a>

<p>The non-terminal html//1 translates a specification into a list of 
atoms and layout instructions. Currently the layout instructions are 
terms of the format <code>nl(N)</code>, requesting at least <var>N</var> 
newlines. Multiple consecutive <code>nl(1)</code> terms are combined to 
an atom containing the maximum of the requested number of newline 
characters.

<p>To simplify handing the data to a client or storing it into a file, 
the following predicates are available from this library:

<dl class="latex">
<dt class="pubdef"><a id="reply_html_page/2"><strong>reply_html_page</strong>(<var>:Head, 
:Body</var>)</a></dt>
<dd class="defbody">
Same as <code>reply_html_page(default, Head, Body)</code>.</dd>
<dt class="pubdef"><a id="reply_html_page/3"><strong>reply_html_page</strong>(<var>+Style, 
:Head, :Body</var>)</a></dt>
<dd class="defbody">
Writes an HTML page preceded by an HTTP header as required by <code>library(http_wrapper)</code> 
(CGI-style). Here is a simple typical example:

<pre class="code">
reply(Request) :-
        reply_html_page(title('Welcome'),
                        [ h1('Welcome'),
                          p('Welcome to our ...')
                        ]).
</pre>

<p>The header and footer of the page can be hooked using the 
grammar-rules user:head//2 and user:body//2. The first argument passed 
to these hooks is the <var>Style</var> argument of <a id="idx:replyhtmlpage3:61"></a><a class="pred" href="#reply_html_page/3">reply_html_page/3</a> 
and the second is the 2nd (for head//2) or 3rd (for body//2) argument of <a id="idx:replyhtmlpage3:62"></a><a class="pred" href="#reply_html_page/3">reply_html_page/3</a>. 
These hooks can be used to restyle the page, typically by embedding the 
real body content in a <code>div</code>. E.g., the following code 
provides a menu on top of each page of that is identified using the 
style
<i>myapp</i>.

<pre class="code">
:- multifile
        user:body//2.

user:body(myapp, Body) --&gt;
        html(body([ div(id(top), \application_menu),
                    div(id(content), Body)
                  ])).
</pre>

<p>Redefining the <code>head</code> can be used to pull in scripts, but 
typically html_requires//1 provides a more modular approach for pulling 
scripts and CSS-files.</dd>
<dt class="pubdef"><a id="reply_html_partial/1"><strong>reply_html_partial</strong>(<var>+HTML</var>)</a></dt>
<dd class="defbody">
Reply with partial HTML document. The reply only contains the element 
from HTML, i.e., this predicate does not add a <code>DOCTYPE</code> 
header,
<code>html</code>, <code>head</code> or <code>body</code>. It is 
intended for JavaScript handlers that request a partial document and 
insert that somewhere into the existing page DOM. See <a id="idx:replyhtmlpage3:63"></a><a class="pred" href="#reply_html_page/3">reply_html_page/3</a> 
to reply with a complete (valid) HTML page.</dd>
<dt class="pubdef"><a id="print_html/1"><strong>print_html</strong>(<var>+List</var>)</a></dt>
<dd class="defbody">
Print the token list to the Prolog current output stream.</dd>
<dt class="pubdef"><a id="print_html/2"><strong>print_html</strong>(<var>+Stream, 
+List</var>)</a></dt>
<dd class="defbody">
Print the token list to the specified output stream</dd>
<dt class="pubdef"><a id="html_print_length/2"><strong>html_print_length</strong>(<var>+List, 
-Length</var>)</a></dt>
<dd class="defbody">
When calling <a id="idx:htmlprint12:64"></a><span class="pred-ext">html_print/[1,2]</span> 
on <var>List</var>, <var>Length</var> characters will be produced. 
Knowing the length is needed to provide the <code>Content-length</code> 
field of an HTTP reply-header.
</dd>
</dl>

<p><h4 id="sec:html-post"><a id="sec:3.21.2"><span class="sec-nr">3.21.2</span> <span class="sec-title">Repositioning 
HTML for CSS and javascript links</span></a></h4>

<p><a id="sec:html-post"></a>

<p>Modern HTML commonly uses CSS and Javascript. This requires <var>&lt;</var>link<var>&gt;</var> 
elements in the HTML <var>&lt;</var>head<var>&gt;</var> element or <var>&lt;</var>script<var>&gt;</var> 
elements in the <var>&lt;</var>body<var>&gt;</var>. Unfortunately this 
seriously harms re-using HTML DCG rules as components as each of these 
components may rely on their own style sheets or JavaScript code. We 
added a&lsquo;mailing&rsquo;system to reposition and collect fragments 
of HTML. This is implemented by <a class="pred" href="#html_post//2">html_post//2</a>, <a class="pred" href="#html_receive//1">html_receive//1</a> 
and <a class="pred" href="#html_receive//2">html_receive//2</a>.

<dl class="latex">
<dt class="pubdef"><span class="pred-tag">[det]</span><a id="html_post//2"><strong>html_post</strong>(<var>+Id, 
:HTML</var>)</a><code>//</code></dt>
<dd class="defbody">
Reposition <var>HTML</var> to the receiving <var>Id</var>. The <a class="pred" href="#html_post//2">html_post//2</a> 
call processes <var>HTML</var> using <a class="pred" href="#html//1">html//1</a>. 
Embedded <code>\</code>-commands are executed by <span class="pred-ext">mailman/1</span> 
from <a class="pred" href="#print_html/1">print_html/1</a> or <a class="pred" href="#html_print_length/2">html_print_length/2</a>. 
These commands are called in the calling context of the <a class="pred" href="#html_post//2">html_post//2</a> 
call.

<p>A typical usage scenario is to get required CSS links in the document 
head in a reusable fashion. First, we define <span class="pred-ext">css//1</span> 
as:

<pre class="code">
css(URL) --&gt;
        html_post(css,
                  link([ type('text/css'),
                         rel('stylesheet'),
                         href(URL)
                       ])).
</pre>

<p>Next we insert the <i>unique</i> CSS links, in the pagehead using the 
following call to <a class="pred" href="#reply_html_page/2">reply_html_page/2</a>:

<pre class="code">
        reply_html_page([ title(...),
                          \html_receive(css)
                        ],
                        ...)
</pre>

</dd>
<dt class="pubdef"><span class="pred-tag">[det]</span><a id="html_receive//1"><strong>html_receive</strong>(<var>+Id</var>)</a><code>//</code></dt>
<dd class="defbody">
Receive posted HTML tokens. Unique sequences of tokens posted with <a class="pred" href="#html_post//2">html_post//2</a> 
are inserted at the location where
<a class="pred" href="#html_receive//1">html_receive//1</a> appears.

<dl class="tags">
<dt class="mtag">See also</dt>
<dd>
- The local predicate <span class="pred-ext">sorted_html//1</span> 
handles the output of
<a class="pred" href="#html_receive//1">html_receive//1</a>. <br>
- <a class="pred" href="#html_receive//2">html_receive//2</a> allows for 
post-processing the posted material.
</dd>
</dl>

</dd>
<dt class="pubdef"><span class="pred-tag">[det]</span><a id="html_receive//2"><strong>html_receive</strong>(<var>+Id, 
:Handler</var>)</a><code>//</code></dt>
<dd class="defbody">
This extended version of <a class="pred" href="#html_receive//1">html_receive//1</a> 
causes <var>Handler</var> to be called to process all messages posted to 
the channal at the time output is generated. <var>Handler</var> is 
called as below, where
<var>PostedTerms</var> is a list of Module:Term created from calls to
<a class="pred" href="#html_post//2">html_post//2</a>. Module is the 
context module of html_post and Term is the unmodified term. Members in <var>PostedTerms</var> 
are in the order posted and may contain duplicates.

<pre class="code">
  phrase(Handler, PostedTerms, HtmlTerms, Rest)
</pre>

<p>Typically, <var>Handler</var> collects the posted terms, creating a 
term suitable for <a class="pred" href="#html//1">html//1</a> and 
finally calls <a class="pred" href="#html//1">html//1</a>.
</dd>
</dl>

<p>The library predefines the receiver channel <code>head</code> at the 
end of the
<code>head</code> element for all pages that write the html <code>head</code> 
through this library. The following code can be used anywhere inside an 
HTML generating rule to demand a javascript in the header:

<pre class="code">
js_script(URL) --&gt;
        html_post(head, script([ src(URL),
                                 type('text/javascript')
                               ], [])).
</pre>

<p>This mechanism is also exploited to add XML namespace (<code>xmlns</code>) 
declarations to the (outer) <code>html</code> element using <span class="pred-ext">xhml_ns//2</span>:

<dl class="latex">
<dt class="pubdef"><a id="xhtml_ns//2"><strong>xhtml_ns</strong>(<var>+Id, 
+Value</var>)</a><code>//</code></dt>
<dd class="defbody">
Demand an xmlns:id=<var>Value</var> in the outer html tag. This uses the
<span class="pred-ext">html_post/2</span> mechanism to post to the <code>xmlns</code> 
channel. Rdfa (<a class="url" href="http://www.w3.org/2006/07/SWD/RDFa/syntax/)">http://www.w3.org/2006/07/SWD/RDFa/syntax/)</a>, 
embedding RDF in (x)html provides a typical usage scenario where we want 
to publish the required namespaces in the header. We can define:

<pre class="code">
rdf_ns(Id) --&gt;
        { rdf_global_id(Id:'', Value) },
        xhtml_ns(Id, Value).
</pre>

<p>After which we can use <span class="pred-ext">rdf_ns//1</span> as a 
normal rule in <a class="pred" href="#html//1">html//1</a> to publish 
namespaces from <code>library(semweb/rdf_db)</code>. Note that this 
macro only has effect if the dialect is set to <code>xhtml</code>. In
<code>html</code> mode it is silently ignored.

<p>The required <code>xmlns</code> receiver is installed by <a class="pred" href="#html_begin//1">html_begin//1</a> 
using the <code>html</code> tag and thus is present in any document that 
opens the outer <code>html</code> environment through this library.
</dd>
</dl>

<p><h4 id="sec:html-write-rules"><a id="sec:3.21.3"><span class="sec-nr">3.21.3</span> <span class="sec-title">Adding 
rules for html//1</span></a></h4>

<a id="sec:html-write-rules"></a>

<p>In some cases it is practical to extend the translations imposed by 
html//1. We used this technique to define translation rules for the 
output of the SWI-Prolog <code>library(sgml)</code> package.

<p>The html//1 non-terminal first calls the multifile ruleset 
html_write:expand//1.

<dl class="latex">
<dt class="pubdef"><a id="html_write:expand//1"><strong>html_write:expand</strong>(<var>+Spec</var>)</a><code>//</code></dt>
<dd class="defbody">
Hook to add additional translation rules for html//1.</dd>
<dt class="pubdef"><a id="html_quoted//1"><strong>html_quoted</strong>(<var>+Atom</var>)</a><code>//</code></dt>
<dd class="defbody">
Emit the text in <var>Atom</var>, inserting entity-references for the 
SGML special characters <code>&lt;&amp;&gt;</code>.</dd>
<dt class="pubdef"><a id="html_quoted_attribute//1"><strong>html_quoted_attribute</strong>(<var>+Atom</var>)</a><code>//</code></dt>
<dd class="defbody">
Emit the text in <var>Atom</var> suitable for use as an SGML attribute, 
inserting entity-references for the SGML special characters <code>&lt;&amp;&gt;"</code>.
</dd>
</dl>

<p><h4 id="sec:htmllayout"><a id="sec:3.21.4"><span class="sec-nr">3.21.4</span> <span class="sec-title">Generating 
layout</span></a></h4>

<a id="sec:htmllayout"></a>

<p>Though not strictly necessary, the library attempts to generate 
reasonable layout in SGML output. It does this only by inserting 
newlines before and after tags. It does this on the basis of the 
multifile predicate <a id="idx:htmlwritelayout3:65"></a><a class="pred" href="#html_write:layout/3">html_write:layout/3</a>

<dl class="latex">
<dt class="pubdef"><a id="html_write:layout/3"><strong>html_write:layout</strong>(<var>+Tag, 
-Open, -Close</var>)</a></dt>
<dd class="defbody">
Specify the layout conventions for the element <var>Tag</var>, which is 
a lowercase atom. <var>Open</var> is a term <var>Pre</var>-<var>Post</var>. 
It defines that the element should have at least <var>Pre</var> newline 
characters before and <var>Post</var> after the tag. The <var>Close</var> 
specification is similar, but in addition allows for the atom <code><code>-</code></code>, 
requesting the output generator to omit the close-tag altogether or <code>empty</code>, 
telling the library that the element has declared empty content. In this 
case the close-tag is not emitted either, but in addition html//1 
interprets <var>Arg</var> in <code>Tag(Arg)</code> as a list of 
attributes rather than the content.

<p>A tag that does not appear in this table is emitted without 
additional layout. See also <a id="idx:printhtml12:66"></a><a class="pred" href="#print_html/1">print_html/[1,2]</a>. 
Please consult the library source for examples.
</dd>
</dl>

<p><h4 id="sec:html-write-examples"><a id="sec:3.21.5"><span class="sec-nr">3.21.5</span> <span class="sec-title">Examples 
for using the HTML write library</span></a></h4>

<a id="sec:html-write-examples"></a>

<p>In the following example we will generate a table of Prolog 
predicates we find from the SWI-Prolog help system based on a keyword. 
The primary database is defined by the predicate <a id="idx:predicate5:67"></a><span class="pred-ext">predicate/5</span> 
We will make hyperlinks for the predicates pointing to their 
documentation.

<pre class="code">
:- use_module(library(http/html_write)).
:- use_module(library(pldoc/man_index)).
:- use_module(library(uri)).

html_apropos(Kwd) :-
    findall(Pred, apropos_predicate(Kwd, Pred), Matches),
    phrase(apropos_page(Kwd, Matches), Tokens),
    print_html(Tokens).

%       emit page with title, header and table of matches

apropos_page(Kwd, Matches) --&gt;
    page([ title(['Predicates for ', Kwd])
         ],
         [ h2(align(center),
              ['Predicates for ', Kwd]),
           table([ align(center),
                   border(1),
                   width('80%')
                 ],
                 [ tr([ th('Predicate'),
                        th('Summary')
                      ])
                 | \apropos_rows(Matches)
                 ])
         ]).

%       emit the rows for the body of the table.

apropos_rows([]) --&gt;
    [].
apropos_rows([pred(Name, Arity, Summary)|T]) --&gt;
    html([ tr([ td(\predref(Name/Arity)),
                td(em(Summary))
              ])
         ]),
    apropos_rows(T).

%!  predref(Name/Arity)//
%
%   Emit Name/Arity as a hyperlink to
%
%           /cgi-bin/plman?name=Name&amp;arity=Arity

predref(Name/Arity) --&gt;
    { uri_edit([search([name=Name,arity=Arity])],
               '/cgi-bin/plman', Href)
    },
    html(a(href(Href), [Name, /, Arity])).

%       Find predicates from a keyword.

apropos_predicate(Pattern, pred(Name, Arity, Summary)) :-
    man_object_property(Name/Arity, summary(Summary)),
    (   sub_atom_icasechk(Name, _, Pattern)
    -&gt;  true
    ;   sub_atom_icasechk(Summary, _, Pattern)
    ).
</pre>

<p><h4 id="sec:html-write-remarks"><a id="sec:3.21.6"><span class="sec-nr">3.21.6</span> <span class="sec-title">Remarks 
on the <code>library(http/html_write)</code> library</span></a></h4>

<a id="sec:html-write-remarks"></a>

<p>This library is the result of various attempts to reach at a more 
satisfactory and Prolog-minded way to produce HTML text from a program. 
We have been using Prolog for the generation of web pages in a number of 
projects. Just using <a id="idx:format2:68"></a><span class="pred-ext">format/2</span> 
never was not a real option, generating error-prone HTML from clumsy 
syntax. We started with a layer on top of
<a id="idx:format2:69"></a><span class="pred-ext">format/2</span>, 
keeping track of the current nesting and thus always capable of properly 
closing the environment.

<p>DCG based translation however, naturally exploits Prolog's 
term-rewriting primitives. If generation fails for whatever reason it is 
easy to produce an alternative document (for example holding an error 
message).

<p>In a future version we will probably define a <a id="idx:goalexpansion2:70"></a><span class="pred-ext">goal_expansion/2</span> 
to do compile-time optimisation of the library. Quotation of known text 
and invocation of sub-rules using the <code>\</code><var>RuleSet</var> 
and
&lt;<var>Module</var>&gt;:&lt;<var>RuleSet</var>&gt; operators are 
costly operations in the analysis that can be done at compile-time.

<p><h3 id="sec:jswrite"><a id="sec:3.22"><span class="sec-nr">3.22</span> <span class="sec-title">library(http/js_write): 
Utilities for including JavaScript</span></a></h3>

<p><a id="sec:jswrite"></a>

<p>This library is a supplement to <code>library(http/html_write)</code> 
for producing JavaScript fragments. Its main role is to be able to call 
JavaScript functions with valid arguments constructed from Prolog data. 
For example, suppose you want to call a JavaScript functions to process 
a list of names represented as Prolog atoms. This can be done using the 
call below, while without this library you would have to be careful to 
properly escape special characters.

<pre class="code">
numbers_script(Names) --&gt;
    html(script(type('text/javascript'),
         [ \js_call('ProcessNumbers'(Names)
         ]),
</pre>

<p>The accepted arguments are described with <a class="pred" href="#js_expression//1">js_expression//1</a>.

<dl class="latex">
<dt class="pubdef"><span class="pred-tag">[det]</span><a id="js_script//1"><strong>js_script</strong>(<var>+Content</var>)</a><code>//</code></dt>
<dd class="defbody">
Generate a JavaScript <code>script</code> element with the given 
content.</dd>
<dt class="pubdef"><span class="pred-tag">[det]</span><a id="javascript/4"><strong>javascript</strong>(<var>+Content, 
+Vars, +VarDict, -DOM</var>)</a></dt>
<dd class="defbody">
Quasi quotation parser for JavaScript that allows for embedding Prolog 
variables to substitude <i>identifiers</i> in the JavaScript snippet. 
Parameterizing a JavaScript string is achieved using the JavaScript <code>+</code> 
operator, which results in concatenation at the client side.

<pre class="code">
    ...,
    js_script({|javascript(Id, Config)||
                $(document).ready(function() {
                   $("#"+Id).tagit(Config);
                 });
               |}),
    ...
</pre>

<p>The current implementation tokenizes the JavaScript input and yields 
syntax errors on unterminated comments, strings, etc. No further parsing 
is implemented, which makes it possible to produce syntactically 
incorrect and partial JavaScript. Future versions are likely to include 
a full parser, generating syntax errors.

<p>The parser produces a term <code>\List</code>, which is suitable for
<a class="pred" href="#js_script//1">js_script//1</a> and <a class="pred" href="#html//1">html//1</a>. 
Embedded variables are mapped to
<code>\js_expression(Var)</code>, while the remaining text is mapped to 
atoms.

<dl class="tags">
<dt class="tag">To be done</dt>
<dd>
Implement a full JavaScript parser. Users should <i>not</i> rely on the 
ability to generate partial JavaScript snippets.
</dd>
</dl>

</dd>
<dt class="pubdef"><span class="pred-tag">[det]</span><a id="js_call//1"><strong>js_call</strong>(<var>+Term</var>)</a><code>//</code></dt>
<dd class="defbody">
Emit a call to a Javascript function. The Prolog functor is the name of 
the function. The arguments are converted from Prolog to JavaScript 
using <a class="pred" href="#js_arg_list//1">js_arg_list//1</a>. Please 
not that Prolog functors can be quoted atom and thus the following is 
legal:

<pre class="code">
    ...
    html(script(type('text/javascript'),
         [ \js_call('x.y.z'(hello, 42))
         ]),
</pre>

</dd>
<dt class="pubdef"><span class="pred-tag">[det]</span><a id="js_new//2"><strong>js_new</strong>(<var>+Id, 
+Term</var>)</a><code>//</code></dt>
<dd class="defbody">
Emit a call to a Javascript object declaration. This is the same as:

<pre class="code">
['var ', Id, ' = new ', \js_call(Term)]
</pre>

</dd>
<dt class="pubdef"><span class="pred-tag">[det]</span><a id="js_arg_list//1"><strong>js_arg_list</strong>(<var>+Expressions:list</var>)</a><code>//</code></dt>
<dd class="defbody">
Write javascript (function) arguments. This writes "(", Arg, ..., ")". 
See <a class="pred" href="#js_expression//1">js_expression//1</a> for 
valid argument values.</dd>
<dt class="pubdef"><span class="pred-tag">[det]</span><a id="js_expression//1"><strong>js_expression</strong>(<var>+Expression</var>)</a><code>//</code></dt>
<dd class="defbody">
Emit a single JSON argument. <var>Expression</var> is one of:

<dl class="latex">
<dt><b>Variable</b></dt>
<dd>
Emitted as Javascript <code>null</code>
</dd>
<dt><b>List</b></dt>
<dd>
Produces a Javascript list, where each element is processed by this 
library.
</dd>
<dt><b><code>object(Attributes)</code></b></dt>
<dd>
Where Attributes is a Key-Value list where each pair can be written as 
Key-Value, Key=Value or Key(Value), accomodating all common constructs 
for this used in Prolog.
$ { K:V, ... } Same as <code>object(Attributes)</code>, providing a more 
JavaScript-like syntax. This may be useful if the object appears 
literally in the source-code, but is generally less friendlyto produce 
as a result from a computation.
</dd>
<dt><b>Dict</b></dt>
<dd>
Emit a dict as a JSON object using <a class="pred" href="#json_write_dict/3">json_write_dict/3</a>.
</dd>
<dt><b><code>json(Term)</code></b></dt>
<dd>
Emits a term using <a class="pred" href="#json_write/3">json_write/3</a>.
</dd>
<dt><b>@(Atom)</b></dt>
<dd>
Emits these constants without quotes. Normally used for the symbols <code>true</code>, <code>false</code> 
and <code>null</code>, but can also be use for emitting JavaScript 
symbols (i.e. function- or variable names).
</dd>
<dt><b>Number</b></dt>
<dd>
Emited literally
</dd>
<dt><b><code>symbol(Atom)</code></b></dt>
<dd>
Synonym for @(Atom). Deprecated.
</dd>
<dt><b>Atom or String</b></dt>
<dd>
Emitted as quoted JavaScript string.
</dd>
</dl>

</dd>
<dt class="pubdef"><span class="pred-tag">[semidet]</span><a id="js_arg//1"><strong>js_arg</strong>(<var>+Expression</var>)</a><code>//</code></dt>
<dd class="defbody">
Same as <a class="pred" href="#js_expression//1">js_expression//1</a>, 
but fails if <var>Expression</var> is invalid, where <a class="pred" href="#js_expression//1">js_expression//1</a> 
raises an error.

<dl class="tags">
<dt class="tag">deprecated</dt>
<dd>
New code should use <a class="pred" href="#js_expression//1">js_expression//1</a>.
</dd>
</dl>

</dd>
</dl>

<p><h3 id="sec:httppath"><a id="sec:3.23"><span class="sec-nr">3.23</span> <span class="sec-title">library(http/http_path): 
Abstract specification of HTTP server locations</span></a></h3>

<p><a id="sec:httppath"></a>

<p>This module provides an abstract specification of HTTP server 
locations that is inspired on <span class="pred-ext">absolute_file_name/3</span>. 
The specification is done by adding rules to the dynamic multifile 
predicate <a class="pred" href="#http:location/3">http:location/3</a>. 
The speficiation is very similar to <span class="pred-ext">user:file_search_path/2</span>, 
but takes an additional argument with options. Currently only one option 
is defined:

<dl class="latex">
<dt><strong>priority</strong>(<var>+Integer</var>)</dt>
<dd class="defbody">
If two rules match, take the one with highest priority. Using priorities 
is needed because we want to be able to overrule paths, but we do not 
want to become dependent on clause ordering.

<p>The default priority is 0. Note however that notably libraries may 
decide to provide a fall-back using a negative priority. We suggest -100 
for such cases.
</dd>
</dl>

<p>This library predefines a single location at priority -100:

<dl class="latex">
<dt><strong>root</strong></dt>
<dd class="defbody">
The root of the server. Default is /, but this may be overruled using 
the setting (see <span class="pred-ext">setting/2</span>) <code>http:prefix</code>
</dd>
</dl>

<p>To serve additional resource files such as CSS, JavaScript and icons, 
see <code>library(http/http_server_files)</code>.

<p>Here is an example that binds <code>/login</code> to <span class="pred-ext">login/1</span>. 
The user can reuse this application while moving all locations using a 
new rule for the admin location with the option <code>[priority(10)]</code>.

<pre class="code">
:- multifile http:location/3.
:- dynamic   http:location/3.

http:location(admin, /, []).

:- http_handler(admin(login), login, []).

login(Request) :-
        ...
</pre>

<dl class="latex">
<dt class="multidef"><span class="pred-tag">[nondet,multifile]</span><a id="http:location/3"><span class="module">http</span>:<strong>location</strong>(<var>+Alias, 
-Expansion, -Options</var>)</a></dt>
<dd class="defbody">
Multifile hook used to specify new HTTP locations. <var>Alias</var> is 
the name of the abstract path. <var>Expansion</var> is either a term 
Alias2(Relative), telling <a class="pred" href="#http_absolute_location/3">http_absolute_location/3</a> 
to translate
<var>Alias</var> by first translating Alias2 and then applying the 
relative path Relative or, <var>Expansion</var> is an absolute location, 
i.e., one that starts with a <code>/</code>. <var>Options</var> 
currently only supports the priority of the path. If <a class="pred" href="#http:location/3">http:location/3</a> 
returns multiple solutions the one with the highest priority is 
selected. The default priority is 0.

<p>This library provides a default for the abstract location
<code>root</code>. This defaults to the setting http:prefix or, when not 
available to the path <code>/</code>. It is adviced to define all 
locations (ultimately) relative to <code>root</code>. For example, use
<code>root('home.html')</code> rather than <code>'/home.html'</code>.</dd>
<dt class="pubdef"><span class="pred-tag">[det]</span><a id="http_absolute_uri/2"><strong>http_absolute_uri</strong>(<var>+Spec, 
-URI</var>)</a></dt>
<dd class="defbody">
<var>URI</var> is the absolute (i.e., starting with <code>http://</code>) <var>URI</var> 
for the abstract specification <var>Spec</var>. Use <a class="pred" href="#http_absolute_location/3">http_absolute_location/3</a> 
to create references to locations on the same server.</dd>
<dt class="pubdef"><span class="pred-tag">[det]</span><a id="http_absolute_location/3"><strong>http_absolute_location</strong>(<var>+Spec, 
-Path, +Options</var>)</a></dt>
<dd class="defbody">
<var>Path</var> is the HTTP location for the abstract specification <var>Spec</var>.
<var>Options</var>:

<dl class="latex">
<dt><strong>relative_to</strong>(<var>Base</var>)</dt>
<dd class="defbody">
<var>Path</var> is made relative to <var>Base</var>. Default is to 
generate absolute URLs.
</dd>
</dl>

<dl class="tags">
<dt class="tag">See also</dt>
<dd>
<a class="pred" href="#http_absolute_uri/2">http_absolute_uri/2</a> to 
create a reference that can be used on another server.
</dd>
</dl>

</dd>
<dt class="pubdef"><a id="http_clean_location_cache/0"><strong>http_clean_location_cache</strong></a></dt>
<dd class="defbody">
HTTP locations resolved through <a class="pred" href="#http_absolute_location/3">http_absolute_location/3</a> 
are cached. This predicate wipes the cache. The cache is automatically 
wiped by <span class="pred-ext">make/0</span> and if the setting 
http:prefix is changed.
</dd>
</dl>

<p><h3 id="sec:htmlhead"><a id="sec:3.24"><span class="sec-nr">3.24</span> <span class="sec-title">library(http/html_head): 
Automatic inclusion of CSS and scripts links</span></a></h3>

<p><a id="sec:htmlhead"></a>

<dl class="tags">
<dt class="mtag">To be done</dt>
<dd>
- Possibly we should add <span class="pred-ext">img//2</span> to include 
images from symbolic path notation. <br>
- It would be nice if the HTTP file server could use our location 
declarations.
</dd>
</dl>

<p>This library allows for abstract declaration of available CSS and 
Javascript resources and their dependencies using <a class="pred" href="#html_resource/2">html_resource/2</a>. 
Based on these declarations, html generating code can declare that it 
depends on specific CSS or Javascript functionality, after which this 
library ensures that the proper links appear in the HTML head. The 
implementation is based on mail system implemented by <span class="pred-ext">html_post/2</span> 
of library <code>html_write.pl</code>.

<p>Declarations come in two forms. First of all http locations are 
declared using the <code>http_path.pl</code> library. Second, <a class="pred" href="#html_resource/2">html_resource/2</a> 
specifies HTML resources to be used in the <code>head</code> and their 
dependencies. Resources are currently limited to Javascript files (.js) 
and style sheets (.css). It is trivial to add support for other material 
in the head. See
<span class="pred-ext">html_include//1</span>.

<p>For usage in HTML generation, there is the DCG rule <a class="pred" href="#html_requires//1">html_requires//1</a> 
that demands named resources in the HTML head.

<p><h4 id="sec:html-resource-ordering"><a id="sec:3.24.1"><span class="sec-nr">3.24.1</span> <span class="sec-title">About 
resource ordering</span></a></h4>

<p><a id="sec:html-resource-ordering"></a>

<p>All calls to <a class="pred" href="#html_requires//1">html_requires//1</a> 
for the page are collected and duplicates are removed. Next, the 
following steps are taken:

<p>
<ol class="latex">
<li>Add all dependencies to the set
<li>Replace multiple members by&lsquo;aggregate&rsquo;scripts or css 
files. see <span class="pred-ext">use_agregates/4</span>.
<li>Order all resources by demanding that their dependencies preceede 
the resource itself. Note that the ordering of resources in the 
dependency list is <b>ignored</b>. This implies that if the order 
matters the dependency list must be split and only the primary 
dependency must be added.
</ol>

<p><h4 id="sec:html-resource-debugging"><a id="sec:3.24.2"><span class="sec-nr">3.24.2</span> <span class="sec-title">Debugging 
dependencies</span></a></h4>

<p><a id="sec:html-resource-debugging"></a>

<p>Use <code>?-</code> <code>debug(html(script))</code>. to see the 
requested and final set of resources. All declared resources are in <span class="pred-ext">html_resource/3</span>. 
The <span class="pred-ext">edit/1</span> command recognises the names of 
HTML resources.

<p><h4 id="sec:html-resource-predicates"><a id="sec:3.24.3"><span class="sec-nr">3.24.3</span> <span class="sec-title">Predicates</span></a></h4>

<p><a id="sec:html-resource-predicates"></a>

<dl class="latex">
<dt class="pubdef"><span class="pred-tag">[det]</span><a id="html_resource/2"><strong>html_resource</strong>(<var>+About, 
+Properties</var>)</a></dt>
<dd class="defbody">
Register an HTML head resource. <var>About</var> is either an atom that 
specifies an HTTP location or a term Alias(Sub). This works similar to <span class="pred-ext">absolute_file_name/2</span>. 
See <span class="pred-ext">http:location_path/2</span> for details. 
Recognised properties are:

<dl class="latex">
<dt><strong>requires</strong>(<var>+Requirements</var>)</dt>
<dd class="defbody">
Other required script and css files. If this is a plain file name, it is 
interpreted relative to the declared resource. <var>Requirements</var> 
can be a list, which is equivalent to multiple requires properties.
</dd>
<dt><strong>virtual</strong>(<var>+Bool</var>)</dt>
<dd class="defbody">
If <code>true</code> (default <code>false</code>), do not include <var>About</var> 
itself, but only its dependencies. This allows for defining an alias for 
one or more resources.
</dd>
<dt><strong>ordered</strong>(<var>+Bool</var>)</dt>
<dd class="defbody">
Defines that the list of requirements is ordered, which means that each 
requirement in the list depends on its predecessor.
</dd>
<dt><strong>aggregate</strong>(<var>+List</var>)</dt>
<dd class="defbody">
States that <var>About</var> is an aggregate of the resources in
<var>List</var>. This means that if both <var>About</var> and one of the 
elements of <var>List</var> appears in the dependencies, <var>About</var> 
is kept and the smaller one is dropped. If there are a number of 
dependencies on the small members, these are replaced with dependency on 
the big (aggregate) one, for example, to specify that a big javascript 
is actually the composition of a number of smaller ones.
</dd>
<dt><strong>mime_type</strong>(<var>-Mime</var>)</dt>
<dd class="defbody">
May be specified for non-virtual resources to specify the mime-type of 
the resource. By default, the mime type is derived from the file name 
using
<span class="pred-ext">file_mime_type/2</span>.
</dd>
</dl>

<p>Registering the same <var>About</var> multiple times extends the 
properties defined for <var>About</var>. In particular, this allows for 
adding additional dependencies to a (virtual) resource.</dd>
<dt class="pubdef"><span class="pred-tag">[nondet]</span><a id="html_current_resource/1"><strong>html_current_resource</strong>(<var>?About</var>)</a></dt>
<dd class="defbody">
True when <var>About</var> is a currently known resource.</dd>
<dt class="pubdef"><span class="pred-tag">[det]</span><a id="html_requires//1"><strong>html_requires</strong>(<var>+ResourceOrList</var>)</a><code>//</code></dt>
<dd class="defbody">
Include <var>ResourceOrList</var> and all dependencies derived from it 
and add them to the HTML <code>head</code> using <span class="pred-ext">html_post/2</span>. 
The actual dependencies are computed during the HTML output phase by
<a class="pred" href="#html_insert_resource//1">html_insert_resource//1</a>.</dd>
<dt class="pubdef"><span class="pred-tag">[det]</span><a id="html_insert_resource//1"><strong>html_insert_resource</strong>(<var>+ResourceOrList</var>)</a><code>//</code></dt>
<dd class="defbody">
Actually include HTML head resources. Called through
<a class="pred" href="#html_post//2">html_post//2</a> from <a class="pred" href="#html_requires//1">html_requires//1</a> 
after rewrite by
<span class="pred-ext">html_head_expansion/2</span>. We are guaranteed 
we will only get one call that is passed a flat list of requested 
requirements. We have three jobs:

<p>
<ol class="latex">
<li>Figure out all indirect requirements
<li>See whether we can use any&lsquo;aggregate&rsquo;resources
<li>Put required resources before their requiree.
</ol>
</dd>
<dt class="pubdef"><span class="pred-tag">[semidet,multifile]</span><a id="mime_include//2"><strong>mime_include</strong>(<var>+Mime, 
+Path</var>)</a><code>//</code></dt>
<dd class="defbody">
Hook called to include a link to an HTML resource of type <var>Mime</var> 
into the HTML head. The <var>Mime</var> type is computed from <var>Path</var> 
using
<span class="pred-ext">file_mime_type/2</span>. If the hook fails, two 
built-in rules for
<code>text/css</code> and <code>text/javascript</code> are tried. For 
example, to include a =.pl= files as a Prolog script, use:

<pre class="code">
:- multifile
    html_head:mime_include//2.

html_head:mime_include(text/'x-prolog', Path) --&gt; !,
    html(script([ type('text/x-prolog'),
                  src(Path)
                ],  [])).
</pre>

<p></dd>
</dl>

<p><h3 id="sec:httppwp"><a id="sec:3.25"><span class="sec-nr">3.25</span> <span class="sec-title">library(http/http_pwp): 
Serve PWP pages through the HTTP server</span></a></h3>

<p><a id="sec:httppwp"></a>

<dl class="tags">
<dt class="mtag">To be done</dt>
<dd>
- Support elements in the HTML header that allow controlling the page, 
such as setting the CGI-header, authorization, etc. <br>
- Allow external styling. Pass through <a class="pred" href="#reply_html_page/2">reply_html_page/2</a>? 
Allow filtering the DOM before/after PWP?
</dd>
</dl>

<p>This module provides convience predicates to include PWP (Prolog 
Well-formed Pages) in a Prolog web-server. It provides the following 
predicates:

<dl class="latex">
<dt><var><code>pwp_handler</code></var> <strong><code>/</code></strong> <var>2</var></dt>
<dd class="defbody">
This is a complete web-server aimed at serving static pages, some of 
which include PWP. This API is intended to allow for programming the 
web-server from a hierarchy of pwp files, prolog files and static 
web-pages.
</dd>
<dt><var><code>reply_pwp_page</code></var> <strong><code>/</code></strong> <var>3</var></dt>
<dd class="defbody">
Return a single PWP page that is executed in the context of the calling 
module. This API is intended for individual pages that include so much 
text that generating from Prolog is undesirable.
</dd>
</dl>

<dl class="latex">
<dt class="pubdef"><a id="pwp_handler/2"><strong>pwp_handler</strong>(<var>+Options, 
+Request</var>)</a></dt>
<dd class="defbody">
Handle PWP files. This predicate is defined to create a simple HTTP 
server from a hierarchy of PWP, HTML and other files. The interface is 
kept compatible with the
<code>library(http/http_dispatch)</code>. In the typical usage scenario, 
one needs to define an http location and a file-search path that is used 
as the root of the server. E.g., the following declarations create a 
self-contained web-server for files in <code>/web/pwp/</code>.

<pre class="code">
user:file_search_path(pwp, '/web/pwp').

:- http_handler(root(.), pwp_handler([path_alias(pwp)]), [prefix]).
</pre>

<p><var>Options</var> include:

<dl class="latex">
<dt><strong>path_alias</strong>(<var>+Alias</var>)</dt>
<dd class="defbody">
Search for PWP files as <var>Alias</var>(Path). See <span class="pred-ext">absolute_file_name/3</span>.
</dd>
<dt><strong>index</strong>(<var>+Index</var>)</dt>
<dd class="defbody">
Name of the directory index (pwp) file. This option may appear multiple 
times. If no such option is provided,
<a class="pred" href="#pwp_handler/2">pwp_handler/2</a> looks for <code>index.pwp</code>.
</dd>
<dt><strong>view</strong>(<var>+Boolean</var>)</dt>
<dd class="defbody">
If <code>true</code> (default is <code>false</code>), allow for 
?view=source to serve PWP file as source.
</dd>
<dt><strong>index_hook</strong>(<var>:Hook</var>)</dt>
<dd class="defbody">
If a directory has no index-file, <a class="pred" href="#pwp_handler/2">pwp_handler/2</a> 
calls
<var>Hook</var>(PhysicalDir, <var>Options</var>, <var>Request</var>). If 
this semidet predicate succeeds, the request is considered handled.
</dd>
<dt><strong>hide_extensions</strong>(<var>+List</var>)</dt>
<dd class="defbody">
Hide files of the given extensions. The default is to hide .pl files.
</dd>
<dt><strong>dtd</strong>(<var>?DTD</var>)</dt>
<dd class="defbody">
<var>DTD</var> to parse the input file with. If unbound, the generated
<var>DTD</var> is returned
</dd>
</dl>

<dl class="tags">
<dt class="tag">Errors</dt>
<dd>
<code>permission_error(index, http_location, Location)</code> is raised 
if the handler resolves to a directory that has no index.
</dd>
<dt class="tag">See also</dt>
<dd>
<a class="pred" href="#reply_pwp_page/3">reply_pwp_page/3</a>
</dd>
</dl>

</dd>
<dt class="pubdef"><a id="reply_pwp_page/3"><strong>reply_pwp_page</strong>(<var>:File, 
+Options, +Request</var>)</a></dt>
<dd class="defbody">
Reply a PWP file. This interface is provided to server individual 
locations from PWP files. Using a PWP file rather than generating the 
page from Prolog may be desirable because the page contains a lot of 
text (which is cumbersome to generate from Prolog) or because the 
maintainer is not familiar with Prolog.

<p><var>Options</var> supported are:

<dl class="latex">
<dt><strong>mime_type</strong>(<var>+Type</var>)</dt>
<dd class="defbody">
Serve the file using the given mime-type. Default is text/html.
</dd>
<dt><strong>unsafe</strong>(<var>+Boolean</var>)</dt>
<dd class="defbody">
Passed to <a class="pred" href="#http_safe_file/2">http_safe_file/2</a> 
to check for unsafe paths.
</dd>
<dt><strong>pwp_module</strong>(<var>+Boolean</var>)</dt>
<dd class="defbody">
If <code>true</code>, (default <code>false</code>), process the PWP file 
in a module constructed from its canonical absolute path. Otherwise, the 
PWP file is processed in the calling module.
</dd>
</dl>

<p>Initial context:

<dl class="latex">
<dt><strong><var>SCRIPT_NAME</var></strong></dt>
<dd class="defbody">
Virtual path of the script.
</dd>
<dt><strong><var>SCRIPT_DIRECTORY</var></strong></dt>
<dd class="defbody">
Physical directory where the script lives
</dd>
<dt><strong><var>QUERY</var></strong></dt>
<dd class="defbody">
Var=Value list representing the query-parameters
</dd>
<dt><strong><var>REMOTE_USER</var></strong></dt>
<dd class="defbody">
If access has been authenticated, this is the authenticated user.
</dd>
<dt><strong><var>REQUEST_METHOD</var></strong></dt>
<dd class="defbody">
One of <code>get</code>, <code>post</code>, <code>put</code> or <code>head</code>
</dd>
<dt><strong><var>CONTENT_TYPE</var></strong></dt>
<dd class="defbody">
Content-type provided with HTTP POST and PUT requests
</dd>
<dt><strong><var>CONTENT_LENGTH</var></strong></dt>
<dd class="defbody">
Content-length provided with HTTP POST and PUT requests
</dd>
</dl>

<p>While processing the script, the file-search-path pwp includes the 
current location of the script. I.e., the following will find myprolog 
in the same directory as where the PWP file resides.

<pre class="code">
pwp:ask="ensure_loaded(pwp(myprolog))"
</pre>

<dl class="tags">
<dt class="tag">See also</dt>
<dd>
<a class="pred" href="#pwp_handler/2">pwp_handler/2</a>.
</dd>
<dt class="tag">To be done</dt>
<dd>
complete the initial context, as far as possible from CGI variables. See <a class="url" href="http://hoohoo.ncsa.illinois.edu/docs/cgi/env.html">http://hoohoo.ncsa.illinois.edu/docs/cgi/env.html</a>
</dd>
</dl>

</dd>
</dl>

<p><h3 id="sec:htmx"><a id="sec:3.26"><span class="sec-nr">3.26</span> <span class="sec-title">library(http/htmx): 
Support htmx.org</span></a></h3>

<p><a id="sec:htmx"></a>

<p>Quoted from htmx.org:
<blockquote>
<a class="url" href="https://htmx.org">htmx</a> gives you access to 
AJAX, CSS Transitions, WebSockets and Server Sent Events directly in 
HTML, using attributes, so you can build modern user interfaces with the 
simplicity and power of hypertext
</blockquote>

<p>The idea behind htmx is to allow adding attributes to any HTML 
element that cause an HTTP request. The HTTP response is typically a 
(short) HTML fragment that extends or replaces an element on the page. 
This allows us to program a most functionality interactive seen in 
modern web applications using the powerful SWI-Prolog HTML generation 
framework rather than having to write a JSON backend and accompagnying 
JavaScript frontend that runs in the browser.

<p>Below is a minimal, yet fully functional application

<pre class="code">
:- use_module(library(http/http_server)).
:- use_module(library(http/htmx)).
:- use_module(library(main)).

:- initialization(main, main).

main(_Argv) :-
    http_server([port(8080)]),
    thread_get_message(quit).

http:location(htmx, root(htmx), []).

:- http_handler(root(.), home, []).

home(_Request) :-
    reply_html_page(
        [ title('HTMX demo'),
          script(src('https://unpkg.com/htmx.org'), [])
        ],
        [ button([ 'hx-post'('/htmx/clicked'),
                   'hx-swap'('outerHTML')
                 ],
                 'Click me')
        ]).

:- http_handler(htmx(clicked), reply_htmx(\clicked), []).

clicked --&gt;
    html('Thanks for clicking me!').
</pre>

<p>HTMX requires no dedicated support from the server. This library 
provides <a class="pred" href="#reply_htmx/1">reply_htmx/1</a>,2 to 
reply with a single HTML element rather than an entire page. Future 
versions of this library may provide some additional utility predicates.

<dl class="latex">
<dt class="pubdef"><span class="pred-tag">[det]</span><a id="reply_htmx/1"><strong>reply_htmx</strong>(<var>+HTML</var>)</a></dt>
<dt class="pubdef"><span class="pred-tag">[det]</span><a id="reply_htmx/2"><strong>reply_htmx</strong>(<var>+HTML, 
+Request</var>)</a></dt>
<dd class="defbody">
Reply a plain <var>HTML</var> element as opposed to a complete <var>HTML</var> 
page as created using <a class="pred" href="#reply_html_page/2">reply_html_page/2</a>,3. 
While <a class="pred" href="#reply_htmx/1">reply_htmx/1</a> is to be 
used in a normal HTTP handler (route), <a class="pred" href="#reply_htmx/2">reply_htmx/2</a> 
may be registered directly in the <a class="pred" href="#http_handler/3">http_handler/3</a> 
declaration to deal with simple cases where we do not need the <var>Request</var> 
data.</dd>
<dt class="pubdef"><span class="pred-tag">[det]</span><a id="htmx_oob//2"><strong>htmx_oob</strong>(<var>++Target, 
:HTML</var>)</a><code>//</code></dt>
<dd class="defbody">
Emit an htmx out-of-band element. <var>HTML</var> is used to swap the 
content of the DOM element with id <var>Target</var>.
</dd>
</dl>

<p><h2 id="sec:http-ipv6"><a id="sec:4"><span class="sec-nr">4</span> <span class="sec-title">HTTP 
and IPv6</span></a></h2>

<a id="sec:http-ipv6"></a>

<p>As of version 9.1.5, SWI-Prolog supports IPv6. This has few 
implications for the HTTP package because most aspects are handled by <code>library(socket)</code> 
and <code>library(uri)</code>. This sections highlights a few aspects.

<p>The <em>client libraries</em> use <a id="idx:httpopen3:71"></a><a class="pred" href="#http_open/3">http_open/3</a>, 
which in turn uses
<a id="idx:tcpconnect3:72"></a><span class="pred-ext">tcp_connect/3</span>. 
This causes the client to use addresses returned by
<a id="idx:hostaddress3:73"></a><span class="pred-ext">host_address/3</span>, 
which is based on the C API <b>getaddrinfo()</b>, in the order provided 
by <b>getaddrinfo()</b>. The URL is parsed using <code>library(uri)</code>, 
which allows enclosing IPv6 addresses in <code>[]</code>. The query 
below accesses an IPv6 server on localhost at port 8080

<pre class="code">
?- http_open('http://[::1]:8080', Stream, []).
</pre>

<p>The predicate <a id="idx:httpserver2:74"></a><a class="pred" href="#http_server/2">http_server/2</a> 
can be used to create an IPv6 server using one of the queries below. The 
first binds to all interfaces. The second only binds to the IPv6 
equivalent of <code>localhost</code>. Note that the IPv6 address needs 
to be quoted to create the desired
<var>Host</var>:<var>Port</var> term.

<pre class="code">
?- http_server('::':8080, []).
?- http_server('::1':8080, []).
</pre>

<p><h2 id="sec:transfer"><a id="sec:5"><span class="sec-nr">5</span> <span class="sec-title">Transfer 
encodings</span></a></h2>

<a id="sec:transfer"></a>

<p><a id="idx:chunkedencoding:75"></a><a id="idx:deflateencoding:76"></a>The 
HTTP protocol provides for <em>transfer encodings</em>. These define 
filters applied to the data described by the <code>Content-type</code>. 
The two most popular transfer encodings are <code>chunked</code> and
<code>deflate</code>. The <code>chunked</code> encoding avoids the need 
for a <code>Content-length</code> header, sending the data in chunks, 
each of which is preceded by a length. The <code>deflate</code> encoding 
provides compression.

<p>Transfer-encodings are supported by filters defined as foreign 
libraries that realise an encoding/decoding stream on top of another 
stream. Currently there are two such libraries: <code>library(http/http_chunked.pl)</code> 
and <code>library(zlib.pl)</code>.

<p>There is an emerging hook interface dealing with transfer encodings. 
The
<code>library(http/http_chunked.pl)</code> provides a hook used by
<code>library(http/http_open.pl)</code> to support chunked encoding in <a id="idx:httpopen3:77"></a><a class="pred" href="#http_open/3">http_open/3</a>. 
Note that both <code>http_open.pl</code> <em>and</em> <code>http_chunked.pl</code> 
must be loaded for <a id="idx:httpopen3:78"></a><a class="pred" href="#http_open/3">http_open/3</a> 
to support chunked encoding.

<p><h3 id="sec:http-chunked"><a id="sec:5.1"><span class="sec-nr">5.1</span> <span class="sec-title">The <code>library(http/http_chunked)</code> 
library</span></a></h3>

<a id="sec:http-chunked"></a>

<dl class="latex">
<dt class="pubdef"><a id="http_chunked_open/3"><strong>http_chunked_open</strong>(<var>+RawStream, 
-DataStream, +Options</var>)</a></dt>
<dd class="defbody">
Create a stream to realise HTTP chunked encoding or decoding. The 
technique is similar to library(zlib), using a Prolog stream as a filter 
on another stream. See online documentation at
<a class="url" href="http://www.swi-prolog.org/">http://www.swi-prolog.org/</a> 
for details.
</dd>
</dl>

<p><h2 id="sec:websocket"><a id="sec:6"><span class="sec-nr">6</span> <span class="sec-title">library(http/websocket): 
WebSocket support</span></a></h2>

<p><a id="sec:websocket"></a>

<dl class="tags">
<dt class="tag">See also</dt>
<dd>
RFC 6455, <a class="url" href="http://tools.ietf.org/html/rfc6455">http://tools.ietf.org/html/rfc6455</a>
</dd>
<dt class="tag">To be done</dt>
<dd>
Deal with protocol extensions.
</dd>
</dl>

<p>WebSocket is a lightweight message oriented protocol on top of TCP/IP 
streams. It is typically used as an <i>upgrade</i> of an HTTP connection 
to provide bi-directional communication, but can also be used in 
isolation over arbitrary (Prolog) streams.

<p>The SWI-Prolog interface is based on <i>streams</i> and provides <a class="pred" href="#ws_open/3">ws_open/3</a> 
to create a <i>websocket stream</i> from any Prolog stream. Typically, 
both an input and output stream are wrapped and then combined into a 
single object using <span class="pred-ext">stream_pair/3</span>.

<p>The high-level interface provides <a class="pred" href="#http_upgrade_to_websocket/3">http_upgrade_to_websocket/3</a> 
to realise a websocket inside the HTTP server infrastructure and
<a class="pred" href="#http_open_websocket/3">http_open_websocket/3</a> 
as a layer over <a class="pred" href="#http_open/3">http_open/3</a> to 
realise a client connection. After establishing a connection, <a class="pred" href="#ws_send/2">ws_send/2</a> 
and <a class="pred" href="#ws_receive/2">ws_receive/2</a> can be used to 
send and receive messages. The predicate <a class="pred" href="#ws_close/3">ws_close/3</a> 
is provided to perform the closing handshake and dispose of the stream 
objects.

<dl class="latex">
<dt class="pubdef"><span class="pred-tag">[det]</span><a id="http_open_websocket/3"><strong>http_open_websocket</strong>(<var>+URL, 
-WebSocket, +Options</var>)</a></dt>
<dd class="defbody">
Establish a client websocket connection. This predicate calls
<a class="pred" href="#http_open/3">http_open/3</a> with additional 
headers to negotiate a websocket connection. In addition to the options 
processed by <a class="pred" href="#http_open/3">http_open/3</a>, the 
following options are recognised:

<dl class="latex">
<dt><strong>subprotocols</strong>(<var>+List</var>)</dt>
<dd class="defbody">
<var>List</var> of subprotocols that are acceptable. The selected 
protocol is available as ws_property(<var>WebSocket</var>,
<code>subprotocol(Protocol)</code>.
</dd>
</dl>

<p>Note that clients often provide an <var>Origin</var> header and some 
servers require this field. See RFC 6455 for details. By default this 
predicate does not set <var>Origin</var>. It may be set using the
<code>request_header</code> option of <a class="pred" href="#http_open/3">http_open/3</a>, 
e.g. by passing this in the
<var>Options</var> list:

<pre class="code">
request_header('Origin' = 'https://www.swi-prolog.org')
</pre>

<p>The following example exchanges a message with the 
html5rocks.websocket.org echo service:

<pre class="code">
?- URL = 'ws://html5rocks.websocket.org/echo',
   http_open_websocket(URL, WS, []),
   ws_send(WS, text('Hello World!')),
   ws_receive(WS, Reply),
   ws_close(WS, 1000, "Goodbye").
URL = 'ws://html5rocks.websocket.org/echo',
WS = &lt;stream&gt;(0xe4a440,0xe4a610),
Reply = websocket{data:"Hello World!", opcode:text}.
</pre>

<table class="arglist">
<tr><td><var>WebSocket</var> </td><td>is a stream pair (see <span class="pred-ext">stream_pair/3</span>) </td></tr>
</table>
</dd>
<dt class="pubdef"><a id="http_upgrade_to_websocket/3"><strong>http_upgrade_to_websocket</strong>(<var>:Goal, 
+Options, +Request</var>)</a></dt>
<dd class="defbody">
Create a websocket connection running <code>call(Goal, WebSocket)</code>, 
where WebSocket is a socket-pair. <var>Options</var>:

<dl class="latex">
<dt><strong>guarded</strong>(<var>+Boolean</var>)</dt>
<dd class="defbody">
If <code>true</code> (default), guard the execution of <var>Goal</var> 
and close the websocket on both normal and abnormal termination of <var>Goal</var>. 
If <code>false</code>, <var>Goal</var> itself is responsible for the 
created websocket if <var>Goal</var> succeeds. The websocket is closed 
if <var>Goal</var> fails or raises an exception. This can be used to 
create a single thread that manages multiple websockets using I/O 
multiplexing. See <code>library(http/hub)</code>.
</dd>
<dt><strong>subprotocols</strong>(<var>+List</var>)</dt>
<dd class="defbody">
<var>List</var> of acceptable subprotocols.
</dd>
<dt><strong>timeout</strong>(<var>+TimeOut</var>)</dt>
<dd class="defbody">
Timeout to apply to the input stream. Default is <code>infinite</code>.
</dd>
</dl>

<p>Note that the <var>Request</var> argument is the last for cooperation 
with
<a class="pred" href="#http_handler/3">http_handler/3</a>. A simple <i>echo</i> 
server that can be accessed at =/ws/= can be implemented as:

<pre class="code">
:- use_module(library(http/websocket)).
:- use_module(library(http/thread_httpd)).
:- use_module(library(http/http_dispatch)).

:- http_handler(root(ws),
                http_upgrade_to_websocket(echo, []),
                [spawn([])]).

echo(WebSocket) :-
    ws_receive(WebSocket, Message),
    (   Message.opcode == close
    -&gt;  true
    ;   ws_send(WebSocket, Message),
        echo(WebSocket)
    ).
</pre>

<dl class="tags">
<dt class="tag">throws</dt>
<dd>
<code>switching_protocols(Goal, Options)</code>. The recovery from this 
exception causes the HTTP infrastructure to call
<code>call(Goal, WebSocket)</code>.
</dd>
<dt class="tag">See also</dt>
<dd>
<a class="pred" href="#http_switch_protocol/2">http_switch_protocol/2</a>.
</dd>
</dl>

</dd>
<dt class="pubdef"><span class="pred-tag">[det]</span><a id="ws_send/2"><strong>ws_send</strong>(<var>+WebSocket, 
+Message</var>)</a></dt>
<dd class="defbody">
Send a message over a websocket. The following terms are allowed for <var>Message</var>:

<dl class="latex">
<dt><strong>text</strong>(<var>+Text</var>)</dt>
<dd class="defbody">
Send a text message. <var>Text</var> is serialized using <span class="pred-ext">write/1</span>.
</dd>
<dt><strong>binary</strong>(<var>+Content</var>)</dt>
<dd class="defbody">
As <code>text(+Text)</code>, but all character codes produced by <var>Content</var> 
must be in the range [0..255]. Typically, <var>Content</var> will be an 
atom or string holding binary data.
</dd>
<dt><strong>prolog</strong>(<var>+Term</var>)</dt>
<dd class="defbody">
Send a Prolog term as a text message. Text is serialized using <span class="pred-ext">write_canonical/1</span>.
</dd>
<dt><strong>json</strong>(<var>+JSON</var>)</dt>
<dd class="defbody">
Send the Prolog representation of a <var>JSON</var> term using
<a class="pred" href="#json_write_dict/2">json_write_dict/2</a>.
</dd>
<dt><strong>string</strong>(<var>+Text</var>)</dt>
<dd class="defbody">
Same as <code>text(+Text)</code>, provided for consistency.
</dd>
<dt><strong>close</strong>(<var>+Code, +Text</var>)</dt>
<dd class="defbody">
Send a close message. <var>Code</var> is 1000 for normal close. See 
websocket documentation for other values.
</dd>
<dt><strong><var>Dict</var></strong></dt>
<dd class="defbody">
A dict that minimally contains an <code>opcode</code> key. Other keys 
used are:

<dl class="latex">
<dt><var><code>format</code></var><strong><code>:</code></strong><var><var>Format</var></var></dt>
<dd class="defbody">
Serialization format used for <var>Message</var>.data. <var>Format</var> 
is one of <code>string</code>, <code>prolog</code> or <code>json</code>. 
See <a class="pred" href="#ws_receive/3">ws_receive/3</a>.
</dd>
<dt><var><code>data</code></var><strong><code>:</code></strong><var><var>Term</var></var></dt>
<dd class="defbody">
If this key is present, it is serialized according to <var>Message</var>.format. 
Otherwise it is serialized using
<span class="pred-ext">write/1</span>, which implies that string and 
atoms are just sent verbatim.
</dd>
</dl>

</dd>
</dl>

<p>Note that <span class="pred-ext">ws_start_message/3</span> does not 
unlock the stream. This is done by <span class="pred-ext">ws_send/1</span>. 
This implies that multiple threads can use
<a class="pred" href="#ws_send/2">ws_send/2</a> and the messages are 
properly serialized.

<dl class="tags">
<dt class="tag">To be done</dt>
<dd>
Provide serialization details using options.
</dd>
</dl>

</dd>
<dt class="pubdef"><span class="pred-tag">[det]</span><a id="ws_receive/2"><strong>ws_receive</strong>(<var>+WebSocket, 
-Message:dict</var>)</a></dt>
<dt class="pubdef"><span class="pred-tag">[det]</span><a id="ws_receive/3"><strong>ws_receive</strong>(<var>+WebSocket, 
-Message:dict, +Options</var>)</a></dt>
<dd class="defbody">
Receive the next message from <var>WebSocket</var>. <var>Message</var> 
is a dict containing the following keys:

<dl class="latex">
<dt><var><code>opcode</code></var><strong><code>:</code></strong><var><var>OpCode</var></var></dt>
<dd class="defbody">
<var>OpCode</var> of the message. This is an atom for known opcodes and 
an integer for unknown ones. If the peer closed the stream, <var>OpCode</var> 
is bound to <code>close</code> and data to the atom
<code>end_of_file</code>.
</dd>
<dt><var><code>data</code></var><strong><code>:</code></strong><var><var>String</var></var></dt>
<dd class="defbody">
The data, represented as a string. This field is always present. <var>String</var> 
is the empty string if there is no data in the message.
</dd>
<dt><var><code>rsv</code></var><strong><code>:</code></strong><var><var>RSV</var></var></dt>
<dd class="defbody">
Present if the <var>WebSocket</var> <var>RSV</var> header is not 0. <var>RSV</var> 
is an integer in the range [1..7].
</dd>
</dl>

<p>If <code>ping</code> message is received and <var>WebSocket</var> is 
a stream pair,
<span class="pred-ext">ws_receive/1</span> replies with a <code>pong</code> 
and waits for the next message.

<p>The predicate <a class="pred" href="#ws_receive/3">ws_receive/3</a> 
processes the following options:

<dl class="latex">
<dt><strong>format</strong>(<var>+Format</var>)</dt>
<dd class="defbody">
Defines how <i>text</i> messages are parsed. <var>Format</var> is one of

<dl class="latex">
<dt><strong>string</strong></dt>
<dd class="defbody">
Data is returned as a Prolog string (default)
</dd>
<dt><strong>json</strong></dt>
<dd class="defbody">
Data is parsed using <a class="pred" href="#json_read_dict/3">json_read_dict/3</a>, 
which also receives
<var>Options</var>.
</dd>
<dt><strong>prolog</strong></dt>
<dd class="defbody">
Data is parsed using <span class="pred-ext">read_term/3</span>, which 
also receives
<var>Options</var>.
</dd>
</dl>

</dd>
</dl>

<dl class="tags">
<dt class="tag">To be done</dt>
<dd>
Add a hook to allow for more data formats?
</dd>
</dl>

</dd>
<dt class="pubdef"><span class="pred-tag">[det]</span><a id="ws_close/3"><strong>ws_close</strong>(<var>+WebSocket:stream_pair, 
+Code, +Data</var>)</a></dt>
<dd class="defbody">
Close a <var>WebSocket</var> connection by sending a <code>close</code> 
message if this was not already sent and wait for the close reply.
<table class="arglist">
<tr><td><var>Code</var> </td><td>is the numerical code indicating the 
close status. This is 16-bit integer. The codes are defined in section <i>7.4.1. 
Defined Status Codes</i> of RFC6455. Notably, 1000 indicates a normal 
closure. </td></tr>
<tr><td><var>Data</var> </td><td>is currently interpreted as text. </td></tr>
</table>

<dl class="tags">
<dt class="tag">Errors</dt>
<dd>
<code>websocket_error(unexpected_message, Reply)</code> if the other 
side did not send a close message in reply.
</dd>
</dl>

</dd>
<dt class="pubdef"><span class="pred-tag">[det]</span><a id="ws_open/3"><strong>ws_open</strong>(<var>+Stream, 
-WSStream, +Options</var>)</a></dt>
<dd class="defbody">
Turn a raw TCP/IP (or any other binary stream) into a websocket stream. <var>Stream</var> 
can be an input stream, output stream or a stream pair. <var>Options</var> 
includes

<dl class="latex">
<dt><strong>mode</strong>(<var>+Mode</var>)</dt>
<dd class="defbody">
One of <code>server</code> or <code>client</code>. If <code>client</code>, 
messages are sent as <i>masked</i>.
</dd>
<dt><strong>buffer_size</strong>(<var>+Count</var>)</dt>
<dd class="defbody">
Send partial messages for each <var>Count</var> bytes or when flushing 
the output. The default is to buffer the entire message before it is 
sent.
</dd>
<dt><strong>close_parent</strong>(<var>+Boolean</var>)</dt>
<dd class="defbody">
If <code>true</code> (default), closing <var>WSStream</var> also closes <var>Stream</var>.
</dd>
<dt><strong>subprotocol</strong>(<var>+Protocol</var>)</dt>
<dd class="defbody">
Set the subprotocol property of WsStream. This value can be retrieved 
using <a class="pred" href="#ws_property/2">ws_property/2</a>. <var>Protocol</var> 
is an atom. See also the <code>subprotocols</code> option of <a class="pred" href="#http_open_websocket/3">http_open_websocket/3</a> 
and
<a class="pred" href="#http_upgrade_to_websocket/3">http_upgrade_to_websocket/3</a>.
</dd>
</dl>

<p>A typical sequence to turn a pair of streams into a WebSocket is 
here:

<pre class="code">
    ...,
    Options = [mode(server), subprotocol(chat)],
    ws_open(Input, WsInput, Options),
    ws_open(Output, WsOutput, Options),
    stream_pair(WebSocket, WsInput, WsOutput).
</pre>

</dd>
<dt class="pubdef"><span class="pred-tag">[nondet]</span><a id="ws_property/2"><strong>ws_property</strong>(<var>+WebSocket, 
?Property</var>)</a></dt>
<dd class="defbody">
True if <var>Property</var> is a property <var>WebSocket</var>. Defined 
properties are:

<dl class="latex">
<dt><strong>subprotocol</strong>(<var>Protocol</var>)</dt>
<dd class="defbody">
<var>Protocol</var> is the negotiated subprotocol. This is typically set 
as a property of the websocket by <a class="pred" href="#ws_open/3">ws_open/3</a>.
</dd>
</dl>

</dd>
<dt class="pubdef"><a id="ws_mask/1"><strong>ws_mask</strong>(<var>-Mask</var>)</a></dt>
<dd class="defbody">
Produce a good random number of the mask of a client message.
</dd>
</dl>

<p><h2 id="sec:hub"><a id="sec:7"><span class="sec-nr">7</span> <span class="sec-title">library(http/hub): 
Manage a hub for websockets</span></a></h2>

<p><a id="sec:hub"></a>

<dl class="tags">
<dt class="tag">To be done</dt>
<dd>
The current design does not use threads to perform tasks for multiple 
hubs. This implies that the design scales rather poorly for hosting many 
hubs with few users.
</dd>
</dl>

<p>This library manages a hub that consists of clients that are 
connected using a websocket. Messages arriving at any of the websockets 
are sent to the <i>event</i> queue of the hub. In addition, the hub 
provides a
<i>broadcast</i> interface. A typical usage scenario for a hub is a <i>chat 
server</i> A scenario for realizing an chat server is:

<p>
<ol class="latex">
<li>Create a new hub using <a class="pred" href="#hub_create/3">hub_create/3</a>.
<li>Create one or more threads that listen to Hub.queues.event from the 
created hub. These threads can update the shared view of the world. A 
message is a dict as returned by <a class="pred" href="#ws_receive/2">ws_receive/2</a> 
or a hub control message. Currently, the following control messages are 
defined:

<dl class="latex">
<dt><strong>hub</strong>{<var><code>error</code>:<var>Error</var>, <code>left</code>:<var>ClientId</var>, <code>reason</code>:<var>Reason</var></var>}</dt>
<dd class="defbody">
A client left us because of an I/O error. <var>Reason</var> is <code>read</code> 
or <code>write</code> and <var>Error</var> is the Prolog I/O exception.</dd>
<dt><strong>hub</strong>{<var><code>joined</code>:<var>ClientId</var></var>}</dt>
<dd class="defbody">
A new client has joined the chatroom.
</dd>
</dl>

<p>The <code>thread(s)</code> can talk to clients using two predicates:

<p>
<ul class="latex">
<li><a class="pred" href="#hub_send/2">hub_send/2</a> sends a message to 
a specific client
<li><a class="pred" href="#hub_broadcast/2">hub_broadcast/2</a> sends a 
message to all clients of the hub.
</ul>
</ol>

<p>A hub consists of (currenty) four message queues and a simple dynamic 
fact. Threads that are needed for the communication tasks are created on 
demand and die if no more work needs to be done.

<dl class="latex">
<dt class="pubdef"><span class="pred-tag">[det]</span><a id="hub_create/3"><strong>hub_create</strong>(<var>+Name, 
-Hub, +Options</var>)</a></dt>
<dd class="defbody">
Create a new hub. <var>Hub</var> is a dict containing the following 
public information:

<dl class="latex">
<dt><var><var>Hub</var></var> <strong><code>.</code></strong> <var><code>name</code></var></dt>
<dd class="defbody">
The name of the hub (the <var>Name</var> argument)
</dd>
<dt><var><code>queues</code></var> <strong><code>.</code></strong> <var><code>event</code></var></dt>
<dd class="defbody">
Message queue to which the hub <code>thread(s)</code> can listen.
</dd>
</dl>

<p>After creating a hub, the application normally creates a thread that 
listens to <var>Hub</var>.queues.event and exposes some mechanisms to 
establish websockets and add them to the hub using <a class="pred" href="#hub_add/3">hub_add/3</a>.

<dl class="tags">
<dt class="tag">See also</dt>
<dd>
<a class="pred" href="#http_upgrade_to_websocket/3">http_upgrade_to_websocket/3</a> 
establishes a websocket from the SWI-Prolog webserver.
</dd>
</dl>

</dd>
<dt class="pubdef"><span class="pred-tag">[nondet]</span><a id="current_hub/2"><strong>current_hub</strong>(<var>?Name, 
?Hub</var>)</a></dt>
<dd class="defbody">
True when there exists a hub <var>Hub</var> with <var>Name</var>.</dd>
<dt class="pubdef"><span class="pred-tag">[det]</span><a id="hub_add/3"><strong>hub_add</strong>(<var>+Hub, 
+WebSocket, ?Id</var>)</a></dt>
<dd class="defbody">
Add a <var>WebSocket</var> to the hub. <var>Id</var> is used to identify 
this user. It may be provided (as a ground term) or is generated as a 
UUID.</dd>
<dt class="pubdef"><span class="pred-tag">[nondet]</span><a id="hub_member/2"><strong>hub_member</strong>(<var>?HubName, 
?Id</var>)</a></dt>
<dd class="defbody">
True when <var>Id</var> is a member of the hub <var>HubName</var>.</dd>
<dt class="pubdef"><span class="pred-tag">[semidet]</span><a id="hub_send/2"><strong>hub_send</strong>(<var>+ClientId, 
+Message</var>)</a></dt>
<dd class="defbody">
Send message to the indicated <var>ClientId</var>. Fails silently if <var>ClientId</var> 
does not exist.
<table class="arglist">
<tr><td><var>Message</var> </td><td>is either a single message (as 
accepted by
<a class="pred" href="#ws_send/2">ws_send/2</a>) or a list of such 
messages. </td></tr>
</table>
</dd>
<dt class="pubdef"><span class="pred-tag">[det]</span><a id="hub_broadcast/2"><strong>hub_broadcast</strong>(<var>+Hub, 
+Message</var>)</a></dt>
<dt class="pubdef"><span class="pred-tag">[det]</span><a id="hub_broadcast/3"><strong>hub_broadcast</strong>(<var>+Hub, 
+Message, :Condition</var>)</a></dt>
<dd class="defbody">
Send <var>Message</var> to all websockets associated with <var>Hub</var> 
for which
<code>call(Condition, Id)</code> succeeds. Note that this process is
<i>asynchronous</i>: this predicate returns immediately after putting 
all requests in a broadcast queue. If a message cannot be delivered due 
to a network error, the hub is informed through
<span class="pred-ext">io_error/3</span>.
</dd>
</dl>

<p><h2 id="sec:jsonsupport"><a id="sec:8"><span class="sec-nr">8</span> <span class="sec-title">Supporting 
JSON</span></a></h2>

<p><a id="sec:jsonsupport"></a>

<p>From <a class="url" href="http://json.org">http://json.org</a>, " 
JSON (JavaScript Object Notation) is a lightweight data-interchange 
format. It is easy for humans to read and write. It is easy for machines 
to parse and generate. It is based on a subset of the JavaScript 
Programming Language, Standard ECMA-262 3rd Edition - December 1999. 
JSON is a text format that is completely language independent but uses 
conventions that are familiar to programmers of the C-family of 
languages, including C, C++, C#, Java, JavaScript, Perl, Python, and 
many others. These properties make JSON an ideal data-interchange 
language."

<p>Although JSON is nowadays used a lot outside the context of web 
applications, SWI-Prolog's support for JSON started life as part of the 
HTTP package. SWI-Prolog supports two Prolog representations for JSON 
terms. The first and oldest map JSON objects to a term
<code>json(PropertyList)</code> and use the <code>@</code> functor to 
disambiguate e.g. <code>null</code> from the string <code>"null"</code>, 
leading to <code>@(null)</code>. As of SWI-Prolog version 7, JSON 
objects may be represented using <i>dict</i> objects and JSON strings 
using Prolog strings. Predicates following this convention are suffixed 
with <code>_dict</code>, e.g. <a class="pred" href="#json_read_dict/2">json_read_dict/2</a>. 
For example, given the JSON document

<pre class="code">
{ "name": "Bob", "children": ["Mary", "John"], "age":42, "married": true }
</pre>

<p>we get either (using <a class="pred" href="#json_read/2">json_read/2</a>):

<pre class="code">
json([name='Bob', children=['Mary', 'John'], age=42, married= @(true)]).
</pre>

<p>or (using <a class="pred" href="#json_read_dict/2">json_read_dict/2</a>):

<pre class="code">
_{age:42, children:["Mary", "John"], married:true, name:"Bob"}
</pre>

<p>The SWI-Prolog JSON interface consists of three libraries:

<p>
<ul class="latex">
<li><code>library(http/json)</code> provides support for the core JSON 
object serialization and parsing.
<li><code>library(http/json_convert)</code> converts between the primary 
representation of JSON terms in Prolog and more application oriented 
Prolog terms. E.g. <code>point(X,Y)</code> vs. <code>object([x=X,y=Y])</code>.
<li><code>library(http/http_json)</code> hooks the conversion libraries 
into the HTTP client and server libraries.

<p><h3 id="sec:json"><a id="sec:8.1"><span class="sec-nr">8.1</span> <span class="sec-title">library(http/json): 
Reading and writing JSON serialization</span></a></h3>

<p><a id="sec:json"></a>

<dl class="tags">
<dt class="tag">author</dt>
<dd>
Jan Wielemaker</dd>
<dt class="mtag">See also</dt>
<dd>
- <code>http_json.pl</code> links JSON to the HTTP client and server 
modules. <br>
- <code>json_convert.pl</code> converts JSON Prolog terms to more 
comfortable terms.
</dd>
</dl>

<p>This module supports reading and writing JSON objects. This library 
supports two Prolog representations (the <i>new</i> representation is 
only supported in SWI-Prolog version 7 and later):

<p>
<ul class="latex">
<li>The <b>classical</b> representation is provided by <a class="pred" href="#json_read/3">json_read/3</a> 
and
<a class="pred" href="#json_write/3">json_write/3</a>. This represents a 
JSON object as <code>json(NameValueList)</code>, a JSON string as an 
atom and the JSON constants <code>null</code>, <code>true</code> and
<code>false</code> as @(null), @(true) and @false.
<li>The <b>new</b> representation is provided by <a class="pred" href="#json_read_dict/3">json_read_dict/3</a> 
and
<a class="pred" href="#json_write_dict/3">json_write_dict/3</a>. This 
represents a JSON object as a dict, a JSON string as a Prolog string and 
the JSON constants using the Prolog atoms <code>null</code>, <code>true</code> 
and <code>false</code>.
</ul>

<dl class="latex">
<dt class="pubdef"><span class="pred-tag">[det]</span><a id="atom_json_term/3"><strong>atom_json_term</strong>(<var>?Atom, 
?JSONTerm, +Options</var>)</a></dt>
<dd class="defbody">
Convert between textual representation and a JSON term. In
<i>write</i> mode (<var>JSONTerm</var> to <var>Atom</var>), the option

<dl class="latex">
<dt><strong>as</strong>(<var>Type</var>)</dt>
<dd class="defbody">
defines the output type, which is one of <code>atom</code> (default),
<code>string</code>, <code>codes</code> or <code>chars</code>.
</dd>
</dl>

</dd>
<dt class="pubdef"><span class="pred-tag">[det]</span><a id="json_read/2"><strong>json_read</strong>(<var>+Stream, 
-Term</var>)</a></dt>
<dt class="pubdef"><span class="pred-tag">[det]</span><a id="json_read/3"><strong>json_read</strong>(<var>+Stream, 
-Term, +Options</var>)</a></dt>
<dd class="defbody">
Read next JSON value from <var>Stream</var> into a Prolog term. The 
canonical representation for <var>Term</var> is:

<p>
<ul class="latex">
<li>A JSON object is mapped to a term <code>json(NameValueList)</code>, 
where NameValueList is a list of Name=Value. Name is an atom created 
from the JSON string.
<li>A JSON array is mapped to a Prolog list of JSON values.
<li>A JSON string is mapped to a Prolog atom
<li>A JSON number is mapped to a Prolog number
<li>The JSON constants <code>true</code> and <code>false</code> are 
mapped -like JPL- to @(true) and @(false).
<li>The JSON constant <code>null</code> is mapped to the Prolog term 
@(null)
</ul>

<p>Here is a complete example in JSON and its corresponding Prolog term.

<pre class="code">
{ "name":"Demo term",
  "created": {
    "day":null,
    "month":"December",
    "year":2007
  },
  "confirmed":true,
  "members":[1,2,3]
}
</pre>

<pre class="code">
json([ name='Demo term',
       created=json([day= @null, month='December', year=2007]),
       confirmed= @true,
       members=[1, 2, 3]
     ])
</pre>

<p>The following options are processed:

<dl class="latex">
<dt><strong>null</strong>(<var>+NullTerm</var>)</dt>
<dd class="defbody">
<var>Term</var> used to represent JSON <code>null</code>. Default 
@(null)
</dd>
<dt><strong>true</strong>(<var>+TrueTerm</var>)</dt>
<dd class="defbody">
<var>Term</var> used to represent JSON <code>true</code>. Default 
@(true)
</dd>
<dt><strong>false</strong>(<var>+FalseTerm</var>)</dt>
<dd class="defbody">
<var>Term</var> used to represent JSON <code>false</code>. Default 
@(false)
</dd>
<dt><strong>end_of_file</strong>(<var>+ErrorOrTerm</var>)</dt>
<dd class="defbody">
If end of file is reached after skipping white space but before any 
input is processed take the following action (default <code>error</code>):

<p>
<ul class="latex">
<li>If <var>ErrorOrTerm</var> <code>==</code> <code>error</code>, throw 
an unexpected end of file syntax error
<li>Otherwise return <var>ErrorOrTerm</var>.
</ul>

<p>Returning an status term is required to process
<a class="url" href="https://en.wikipedia.org/wiki/JSON_streaming\#Concatenated_JSON">Concatenated 
JSON</a>. Suggested values are <code>@(eof)</code> or <code>end_of_file</code>.
</dd>
<dt><strong>value_string_as</strong>(<var>+Type</var>)</dt>
<dd class="defbody">
Prolog type used for strings used as value. Default is <code>atom</code>. 
The alternative is <code>string</code>, producing a packed string 
object. Please note that <code>codes</code> or <code>chars</code> would 
produce ambiguous output and are therefore not supported.
</dd>
</dl>

<dl class="tags">
<dt class="tag">See also</dt>
<dd>
<a class="pred" href="#json_read_dict/3">json_read_dict/3</a> to read a 
JSON term using the version 7 extended data types.
</dd>
</dl>

</dd>
<dt class="pubdef"><span class="pred-tag">[det]</span><a id="json_write/2"><strong>json_write</strong>(<var>+Stream, 
+Term</var>)</a></dt>
<dt class="pubdef"><span class="pred-tag">[det]</span><a id="json_write/3"><strong>json_write</strong>(<var>+Stream, 
+Term, +Options</var>)</a></dt>
<dd class="defbody">
Write a JSON term to <var>Stream</var>. The JSON object is of the same 
format as produced by <a class="pred" href="#json_read/2">json_read/2</a>, 
though we allow for some more flexibility with regard to pairs in 
objects. All of Name=Value, Name-Value and Name(Value) produce the same 
output.

<p>Values can be of the form #(<var>Term</var>), which causes <var>Term</var> 
to be
<i>stringified</i> if it is not an atom or string. Stringification is 
based on <span class="pred-ext">term_string/2</span>.

<p>Rational numbers are emitted as floating point numbers. The hook
<a class="pred" href="#json_write_hook/4">json_write_hook/4</a> can be 
used to realize domain specific alternatives.

<p>The version 7 <i>dict</i> type is supported as well. Optionally, if 
the dict has a <i>tag</i>, a property "type":"tag" can be added to the 
object. This behaviour can be controlled using the <code>tag</code> 
option (see below). For example:

<pre class="code">
?- json_write(current_output, point{x:1,y:2}).
{
  "x":1,
  "y":2
}
</pre>

<pre class="code">
?- json_write(current_output, point{x:1,y:2}, [tag(type)]).
{
  "type":"point",
  "x":1,
  "y":2
}
</pre>

<p>In addition to the options recognised by <a class="pred" href="#json_read/3">json_read/3</a>, 
we process the following options are recognised:

<dl class="latex">
<dt><strong>width</strong>(<var>+Width</var>)</dt>
<dd class="defbody">
<var>Width</var> in which we try to format the result. Too long lines 
switch from <i>horizontal</i> to <i>vertical</i> layout for better 
readability. If performance is critical and human readability is not an 
issue use <var>Width</var> = 0, which causes a single-line output.
</dd>
<dt><strong>step</strong>(<var>+Step</var>)</dt>
<dd class="defbody">
Indentation increnment for next level. Default is 2.
</dd>
<dt><strong>tab</strong>(<var>+TabDistance</var>)</dt>
<dd class="defbody">
Distance between tab-stops. If equal to Step, layout is generated with 
one tab per level.
</dd>
<dt><strong>serialize_unknown</strong>(<var>+Boolean</var>)</dt>
<dd class="defbody">
If <code>true</code> (default <code>false</code>), serialize unknown 
terms and print them as a JSON string. The default raises a type error. 
Note that this option only makes sense if you can guarantee that the 
passed value is not an otherwise valid Prolog reporesentation of a 
Prolog term.
</dd>
</dl>

<p>If a string is emitted, the sequence <code>&lt;/</code> is emitted as
<code>&lt;\/</code>. This is valid JSON syntax which ensures that JSON 
objects can be safely embedded into an HTML <code>&lt;script&gt;</code> 
element.</dd>
<dt class="multidef"><span class="pred-tag">[semidet,multifile]</span><a id="json_write_hook/4"><strong>json_write_hook</strong>(<var>+Term, 
+Stream, +State, +Options</var>)</a></dt>
<dd class="defbody">
Hook that can be used to emit a JSON representation for <var>Term</var> 
to
<var>Stream</var>. If the predicate succeeds it <b>must</b> have written 
a
<b>valid</b> JSON data element and if it fails it may not have produced 
any output. This facility may be used to map arbitrary Prolog terms to 
JSON. It was added to manage the precision with which floating point 
numbers are emitted.

<p>Note that this hook is shared by all users of this library. It is 
generally adviced to map a unique compound term to avoid interference 
with normal output.
<table class="arglist">
<tr><td><var>State</var> </td><td>and <var>Options</var> are opaque 
handles to the current output state and settings. Future versions may 
provide documented access to these terms. Currently it is adviced to 
ignore these arguments. </td></tr>
</table>
</dd>
<dt class="multidef"><span class="pred-tag">[semidet,multifile]</span><a id="json_dict_pairs/2"><strong>json_dict_pairs</strong>(<var>+Dict, 
-Pairs</var>)</a></dt>
<dd class="defbody">
This hook may be used to order the keys of an object. If it fails,
<span class="pred-ext">dict_pairs/3</span> is used which produces an 
ordered list of keys.</dd>
<dt class="pubdef"><span class="pred-tag">[semidet]</span><a id="is_json_term/1"><strong>is_json_term</strong>(<var>@Term</var>)</a></dt>
<dt class="pubdef"><span class="pred-tag">[semidet]</span><a id="is_json_term/2"><strong>is_json_term</strong>(<var>@Term, 
+Options</var>)</a></dt>
<dd class="defbody">
True if <var>Term</var> is a json term. <var>Options</var> are the same 
as for
<a class="pred" href="#json_read/2">json_read/2</a>, defining the Prolog 
representation for the JSON
<code>true</code>, <code>false</code> and <code>null</code> constants.</dd>
<dt class="pubdef"><span class="pred-tag">[det]</span><a id="json_read_dict/2"><strong>json_read_dict</strong>(<var>+Stream, 
-Dict</var>)</a></dt>
<dt class="pubdef"><span class="pred-tag">[det]</span><a id="json_read_dict/3"><strong>json_read_dict</strong>(<var>+Stream, 
-Dict, +Options</var>)</a></dt>
<dd class="defbody">
Read a JSON object, returning objects as a dicts. The representation 
depends on the options, where the default is:

<p>
<ul class="latex">
<li>String values are mapped to Prolog strings
<li>JSON <code>true</code>, <code>false</code> and <code>null</code> are 
represented using these Prolog atoms.
<li>JSON objects are mapped to dicts.
<li>Optionally, a <code>type</code> field in an object assigns a tag for 
the dict.
</ul>

<p>The predicate <a class="pred" href="#json_read_dict/3">json_read_dict/3</a> 
processes the same options as
<a class="pred" href="#json_read/3">json_read/3</a>, but with different 
defaults. In addition, it processes the <code>tag</code> option. See <a class="pred" href="#json_read/3">json_read/3</a> 
for details about the shared options.

<dl class="latex">
<dt><strong>tag</strong>(<var>+Name</var>)</dt>
<dd class="defbody">
When converting to/from a dict, map the indicated JSON attribute to the 
dict <i>tag</i>. No mapping is performed if <var>Name</var> is the empty 
atom (&rdquo; , default). See <a class="pred" href="#json_read_dict/2">json_read_dict/2</a> 
and
<a class="pred" href="#json_write_dict/2">json_write_dict/2</a>.
</dd>
<dt><strong>default_tag</strong>(<var>+Tag</var>)</dt>
<dd class="defbody">
Provide the default tag if the above <code>tag</code> option does not 
apply.
</dd>
<dt><strong>null</strong>(<var>+NullTerm</var>)</dt>
<dd class="defbody">
Default the atom <code>null</code>.
</dd>
<dt><strong>true</strong>(<var>+TrueTerm</var>)</dt>
<dd class="defbody">
Default the atom <code>true</code>.
</dd>
<dt><strong>false</strong>(<var>+FalseTerm</var>)</dt>
<dd class="defbody">
Default the atom <code>false</code>
</dd>
<dt><strong>end_of_file</strong>(<var>+ErrorOrTerm</var>)</dt>
<dd class="defbody">
Action on reading end-of-file. See <a class="pred" href="#json_read/3">json_read/3</a> 
for details.
</dd>
<dt><strong>value_string_as</strong>(<var>+Type</var>)</dt>
<dd class="defbody">
Prolog type used for strings used as value. Default is <code>string</code>. 
The alternative is <code>atom</code>, producing a packed string object.
</dd>
</dl>

</dd>
<dt class="pubdef"><span class="pred-tag">[det]</span><a id="json_write_dict/2"><strong>json_write_dict</strong>(<var>+Stream, 
+Dict</var>)</a></dt>
<dt class="pubdef"><span class="pred-tag">[det]</span><a id="json_write_dict/3"><strong>json_write_dict</strong>(<var>+Stream, 
+Dict, +Options</var>)</a></dt>
<dd class="defbody">
Write a JSON term, represented using dicts. This is the same as
<a class="pred" href="#json_write/3">json_write/3</a>, but assuming the 
default representation of JSON objects as dicts.</dd>
<dt class="pubdef"><span class="pred-tag">[det]</span><a id="atom_json_dict/3"><strong>atom_json_dict</strong>(<var>+Atom, 
-JSONDict, +Options</var>)</a></dt>
<dt class="pubdef"><span class="pred-tag">[det]</span><a id="atom_json_dict/3"><strong>atom_json_dict</strong>(<var>-Text, 
+JSONDict, +Options</var>)</a></dt>
<dd class="defbody">
Convert between textual representation and a JSON term represented as a 
dict. <var>Options</var> are as for <a class="pred" href="#json_read/3">json_read/3</a>. 
In <i>write</i> mode, the addtional option

<dl class="latex">
<dt><strong>as</strong>(<var>Type</var>)</dt>
<dd class="defbody">
defines the output type, which is one of <code>atom</code>,
<code>string</code> or <code>codes</code>.
</dd>
</dl>

</dd>
</dl>

<p><h3 id="sec:jsonconvert"><a id="sec:8.2"><span class="sec-nr">8.2</span> <span class="sec-title">library(http/json_convert): 
Convert between JSON terms and Prolog application terms</span></a></h3>

<p><a id="sec:jsonconvert"></a>

<dl class="tags">
<dt class="mtag">To be done</dt>
<dd>
- Ignore extra fields. Using a partial list of <i>extra</i>? <br>
- Consider a sensible default for handling JSON <code>null</code>. 
Conversion to Prolog could translate @null into a variable if the 
desired type is not <code>any</code>. Conversion to JSON could map 
variables to <code>null</code>, though this may be unsafe. If the Prolog 
term is known to be non-ground and JSON @null is a sensible mapping, we 
can also use this simple snipit to deal with that fact.

<pre class="code">
        term_variables(Term, Vars),
        maplist(=(@null), Vars).
</pre>

<p></dd>
</dl>

<p>The idea behind this module is to provide a flexible high-level 
mapping between Prolog terms as you would like to see them in your 
application and the standard representation of a JSON object as a Prolog 
term. For example, an X-Y point may be represented in JSON as <code>{"x":25, "y":50}</code>. 
Represented in Prolog this becomes <code>json([x=25,y=50])</code>, but 
this is a pretty non-natural representation from the Prolog point of 
view.

<p>This module allows for defining records (just like <code>library(record)</code>) 
that provide transparent two-way transformation between the two 
representations.

<pre class="code">
:- json_object
        point(x:integer, y:integer).
</pre>

<p>This declaration causes <a class="pred" href="#prolog_to_json/2">prolog_to_json/2</a> 
to translate the native Prolog representation into a JSON Term:

<pre class="code">
?- prolog_to_json(point(25,50), X).

X = json([x=25, y=50])
</pre>

<p>A <a class="pred" href="#json_object/1">json_object/1</a> declaration 
can define multiple objects separated by a comma (,), similar to the <span class="pred-ext">dynamic/1</span> 
directive. Optionally, a declaration can be qualified using a module. 
The conversion predicates
<a class="pred" href="#prolog_to_json/2">prolog_to_json/2</a> and <a class="pred" href="#json_to_prolog/2">json_to_prolog/2</a> 
first try a conversion associated with the calling module. If not 
successful, they try conversions associated with the module <code>user</code>.

<p>JSON objects have no <i>type</i>. This can be solved by adding an 
extra field to the JSON object, e.g. <code>{"type":"point", "x":25, "y":50}</code>. 
As Prolog records are typed by their functor we need some notation to 
handle this gracefully. This is achieved by adding +Fields to the 
declaration. I.e.

<pre class="code">
:- json_object
        point(x:integer, y:integer) + [type=point].
</pre>

<p>Using this declaration, the conversion becomes:

<pre class="code">
?- prolog_to_json(point(25,50), X).

X = json([x=25, y=50, type=point])
</pre>

<p>The predicate <a class="pred" href="#json_to_prolog/2">json_to_prolog/2</a> 
is often used after <a class="pred" href="#http_read_json/2">http_read_json/2</a> 
and
<a class="pred" href="#prolog_to_json/2">prolog_to_json/2</a> before <a class="pred" href="#reply_json/1">reply_json/1</a>. 
For now we consider them separate predicates because the transformation 
may be too general, too slow or not needed for dedicated applications. 
Using a separate step also simplifies debugging this rather complicated 
process.

<dl class="latex">
<dt class="multidef"><span class="pred-tag">[multifile]</span><a id="current_json_object/3"><strong>current_json_object</strong>(<var>Term, 
Module, Fields</var>)</a></dt>
<dd class="defbody">
Multifile predicate computed from the <a class="pred" href="#json_object/1">json_object/1</a> 
declarations. <var>Term</var> is the most general Prolog term 
representing the object. <var>Module</var> is the module in which the 
object is defined and <var>Fields</var> is a list of <code>f(Name, Type, Default, Var)</code>, 
ordered by Name. Var is the corresponding variable in <var>Term</var>.</dd>
<dt class="pubdef"><a id="json_object/1"><strong>json_object</strong>(<var>+Declaration</var>)</a></dt>
<dd class="defbody">
Declare a JSON object. The declaration takes the same format as using in <span class="pred-ext">record/1</span> 
from <code>library(record)</code>. E.g.

<pre class="code">
?- json_object
      point(x:int, y:int, z:int=0).
</pre>

<p>The type arguments are either types as know to <code>library(error)</code> 
or functor names of other JSON objects. The constant <code>any</code> 
indicates an untyped argument. If this is a JSON term, it becomes 
subject to <a class="pred" href="#json_to_prolog/2">json_to_prolog/2</a>. 
I.e., using the type
<code>list(any)</code> causes the conversion to be executed on each 
element of the list.

<p>If a field has a default, the default is used if the field is not 
specified in the JSON object. Extending the record type definition, 
types can be of the form (Type1<code>|</code>Type2). The type
<code>null</code> means that the field may <i>not</i> be present.

<p>Conversion of JSON to Prolog applies if all non-defaulted arguments 
can be found in the JSON object. If multiple rules match, the term with 
the highest arity gets preference.</dd>
<dt class="pubdef"><span class="pred-tag">[semidet]</span><a id="prolog_bool_to_json/2"><strong>prolog_bool_to_json</strong>(<var>+Prolog, 
-JSON</var>)</a></dt>
<dd class="defbody">
<var>JSON</var> is the <var>JSON</var> boolean for <var>Prolog</var>. It 
is a flexible the <var>Prolog</var> notation for thruth-value, accepting 
one of <code>true</code>, <code>on</code> or <code>1</code> for @true 
and one of <code>false</code>, <code>fail</code>, <code>off</code> or <code>0</code> 
for @false.

<dl class="tags">
<dt class="tag">Errors</dt>
<dd>
instantiation_error if <var>Prolog</var> is unbound.
</dd>
</dl>

</dd>
<dt class="pubdef"><span class="pred-tag">[det]</span><a id="prolog_to_json/2"><strong>prolog_to_json</strong>(<var>:Term, 
-JSONObject</var>)</a></dt>
<dd class="defbody">
Translate a Prolog application <var>Term</var> into a JSON object term. 
This transformation is based on <code>:-</code> <a class="pred" href="#json_object/1">json_object/1</a> 
declarations. If a <a class="pred" href="#json_object/1">json_object/1</a> 
declaration declares a field of type
<code>boolean</code>, commonly used thruth-values in Prolog are 
converted to JSON booleans. Boolean translation accepts one of <code>true</code>,
<code>on</code>, <code>1</code>, @true, <code>false</code>, <code>fail</code>, <code>off</code> 
or <code>0</code>, @false.

<dl class="tags">
<dt class="mtag">Errors</dt>
<dd>
- <code>type_error(json_term, X)</code> <br>
- instantiation_error
</dd>
</dl>

</dd>
<dt class="pubdef"><span class="pred-tag">[det]</span><a id="json_to_prolog/2"><strong>json_to_prolog</strong>(<var>+JSON, 
-Term</var>)</a></dt>
<dd class="defbody">
Translate a <var>JSON</var> term into an application term. This 
transformation is based on <code>:-</code> <a class="pred" href="#json_object/1">json_object/1</a> 
declarations. An efficient transformation is non-trivial, but we rely on 
the assumption that, although the order of fields in <var>JSON</var> 
terms is irrelevant and can therefore vary a lot, practical applications 
will normally generate the <var>JSON</var> objects in a consistent 
order.

<p>If a field in a json_object is declared of type <code>boolean</code>, 
@true and @false are translated to <code>true</code> or <code>false</code>, 
the most commonly used Prolog representation for truth-values.
</dd>
</dl>

<p><h3 id="sec:httpjson"><a id="sec:8.3"><span class="sec-nr">8.3</span> <span class="sec-title">library(http/http_json): 
HTTP JSON Plugin module</span></a></h3>

<p><a id="sec:httpjson"></a>

<dl class="tags">
<dt class="mtag">See also</dt>
<dd>
- JSON Requests are discussed in <a class="url" href="http://json.org/JSONRequest.html">http://json.org/JSONRequest.html</a> <br>
- <code>json.pl</code> describes how JSON objects are represented in 
Prolog terms. <br>
- <code>json_convert.pl</code> converts between more natural Prolog 
terms and json terms.
</dd>
</dl>

<p>Most code doesn't need to use this directly; instead use
<code>library(http/http_server)</code>, which combines this library with 
the typical HTTP libraries that most servers need.

<p>This module adds hooks to several parts of the HTTP libraries, making 
them JSON-aware. Notably:

<p>
<ul class="latex">
<li>Make <a class="pred" href="#http_read_data/3">http_read_data/3</a> 
convert <code>application/json</code> and
<code>application/jsonrequest</code> content to a JSON term.
<li>Cause <a class="pred" href="#http_open/3">http_open/3</a> to accept <code>post(json(Term))</code> 
to issue a POST request with JSON content.
<li>Provide HTTP server and client utility predicates for reading and 
replying JSON:

<p>
<ul class="compact">
<li><a class="pred" href="#http_read_json/2">http_read_json/2</a>
<li><a class="pred" href="#http_read_json/3">http_read_json/3</a>
<li><a class="pred" href="#http_read_json_dict/2">http_read_json_dict/2</a>
<li><a class="pred" href="#http_read_json_dict/3">http_read_json_dict/3</a>
<li><a class="pred" href="#reply_json/1">reply_json/1</a>
<li><a class="pred" href="#reply_json/2">reply_json/2</a>
<li><a class="pred" href="#reply_json_dict/1">reply_json_dict/1</a>
<li><a class="pred" href="#reply_json_dict/2">reply_json_dict/2</a>
</ul>

<p>
<li>Reply to exceptions in the server using an JSON document rather then 
HTML if the <code>Accept</code> header prefers application/json over 
text/html.
</ul>

<p>Typically JSON is used by Prolog HTTP servers. This module supports 
two JSON representations: the classical representation and the new 
representation supported by the SWI-Prolog version 7 extended data 
types. Below is a skeleton for handling a JSON request, answering in 
JSON using the classical interface.

<pre class="code">
handle(Request) :-
      http_read_json(Request, JSONIn),
      json_to_prolog(JSONIn, PrologIn),
      &lt;compute&gt;(PrologIn, PrologOut),         % application body
      prolog_to_json(PrologOut, JSONOut),
      reply_json(JSONOut).
</pre>

<p>When using dicts, the conversion step is generally not needed and the 
code becomes:

<pre class="code">
handle(Request) :-
      http_read_json_dict(Request, DictIn),
      &lt;compute&gt;(DictIn, DictOut),
      reply_json(DictOut).
</pre>

<p>This module also integrates JSON support into the http client 
provided by <code>http_client.pl</code>. Posting a JSON query and 
processing the JSON reply (or any other reply understood by <a class="pred" href="#http_read_data/3">http_read_data/3</a>) 
is as simple as below, where Term is a JSON term as described in <code>json.pl</code> 
and reply is of the same format if the server replies with JSON.

<pre class="code">
      ...,
      http_post(URL, json(Term), Reply, [])
</pre>

<dl class="latex">
<dt class="multidef"><span class="pred-tag">[multifile]</span><a id="http_client:http_convert_data/4"><span class="module">http_client</span>:<strong>http_convert_data</strong>(<var>+In, 
+Fields, -Data, +Options</var>)</a></dt>
<dd class="defbody">
Hook implementation that supports reading JSON documents. It processes 
the following option:

<dl class="latex">
<dt><strong>json_object</strong>(<var>+As</var>)</dt>
<dd class="defbody">
Where <var>As</var> is one of <code>term</code> or <code>dict</code>. If 
the value is <code>dict</code>,
<a class="pred" href="#json_read_dict/3">json_read_dict/3</a> is used.
</dd>
</dl>

</dd>
<dt class="pubdef"><span class="pred-tag">[semidet]</span><a id="is_json_content_type/1"><strong>is_json_content_type</strong>(<var>+ContentType</var>)</a></dt>
<dd class="defbody">
True if <var>ContentType</var> is a header value (either parsed or as 
atom/string) that denotes a JSON value.</dd>
<dt class="multidef"><span class="pred-tag">[semidet,multifile]</span><a id="json_type/1"><strong>json_type</strong>(<var>?MediaType</var>)</a></dt>
<dd class="defbody">
True if <var>MediaType</var> is a JSON media type. <span class="pred-ext">http_json:json_type/1</span> 
is a multifile predicate and may be extended to facilitate 
non-conforming clients.
<table class="arglist">
<tr><td><var>MediaType</var> </td><td>is a term <var>Type</var>/<var>SubType</var>, 
where both <var>Type</var> and
<var>SubType</var> are atoms. </td></tr>
</table>
</dd>
<dt class="multidef"><span class="pred-tag">[semidet,multifile]</span><a id="http:post_data_hook/3"><span class="module">http</span>:<strong>post_data_hook</strong>(<var>+Data, 
+Out:stream, +HdrExtra</var>)</a></dt>
<dd class="defbody">
Hook implementation that allows <a class="pred" href="#http_post_data/3">http_post_data/3</a> 
posting JSON objects using one of the forms below.

<pre class="code">
http_post(URL, json(Term), Reply, Options)
http_post(URL, json(Term, Options), Reply, Options)
</pre>

<p>If Options are passed, these are handed to <a class="pred" href="#json_write/3">json_write/3</a>. 
In addition, this option is processed:

<dl class="latex">
<dt><strong>json_object</strong>(<var>As</var>)</dt>
<dd class="defbody">
If <var>As</var> is <code>dict</code>, <a class="pred" href="#json_write_dict/3">json_write_dict/3</a> 
is used to write the output. This is default if <code>json(Dict)</code> 
is passed.
</dd>
</dl>

<dl class="tags">
<dt class="tag">To be done</dt>
<dd>
avoid creation of intermediate data using chunked output.
</dd>
</dl>

</dd>
<dt class="pubdef"><span class="pred-tag">[det]</span><a id="http_read_json/2"><strong>http_read_json</strong>(<var>+Request, 
-JSON</var>)</a></dt>
<dt class="pubdef"><span class="pred-tag">[det]</span><a id="http_read_json/3"><strong>http_read_json</strong>(<var>+Request, 
-JSON, +Options</var>)</a></dt>
<dd class="defbody">
Extract <var>JSON</var> data posted to this HTTP request. <var>Options</var> 
are passed to <a class="pred" href="#json_read/3">json_read/3</a>. In 
addition, this option is processed:

<dl class="latex">
<dt><strong>json_object</strong>(<var>+As</var>)</dt>
<dd class="defbody">
One of <code>term</code> (default) to generate a classical Prolog term 
or <code>dict</code> to exploit the SWI-Prolog version 7 data type 
extensions. See <a class="pred" href="#json_read_dict/3">json_read_dict/3</a>.
</dd>
</dl>

<dl class="tags">
<dt class="mtag">Errors</dt>
<dd>
- <code>domain_error(mimetype, Found)</code> if the mimetype is not 
known (see <a class="pred" href="#json_type/1">json_type/1</a>). <br>
- <code>domain_error(method, Method)</code> if the request method is not 
a <code>POST</code>, <code>PUT</code> or <code>PATCH</code>.
</dd>
</dl>

</dd>
<dt class="pubdef"><span class="pred-tag">[det]</span><a id="http_read_json_dict/2"><strong>http_read_json_dict</strong>(<var>+Request, 
-Dict</var>)</a></dt>
<dt class="pubdef"><span class="pred-tag">[det]</span><a id="http_read_json_dict/3"><strong>http_read_json_dict</strong>(<var>+Request, 
-Dict, +Options</var>)</a></dt>
<dd class="defbody">
Similar to <a class="pred" href="#http_read_json/2">http_read_json/2</a>,3, 
but by default uses the version 7 extended datatypes.</dd>
<dt class="pubdef"><span class="pred-tag">[det]</span><a id="reply_json/1"><strong>reply_json</strong>(<var>+JSONTerm</var>)</a></dt>
<dt class="pubdef"><span class="pred-tag">[det]</span><a id="reply_json/2"><strong>reply_json</strong>(<var>+JSONTerm, 
+Options</var>)</a></dt>
<dd class="defbody">
Formulate a JSON HTTP reply. See <a class="pred" href="#json_write/2">json_write/2</a> 
for details. The processed options are listed below. Remaining options 
are forwarded to <a class="pred" href="#json_write/3">json_write/3</a>.

<dl class="latex">
<dt><strong>content_type</strong>(<var>+Type</var>)</dt>
<dd class="defbody">
The default <code>Content-type</code> is <code>application/json; charset=UTF8</code>. <code>charset=UTF8</code> 
should not be required because JSON is defined to be UTF-8 encoded, but 
some clients insist on it.
</dd>
<dt><strong>status</strong>(<var>+Code</var>)</dt>
<dd class="defbody">
The default status is 200. REST API functions may use other values from 
the 2XX range, such as 201 (created).
</dd>
<dt><strong>json_object</strong>(<var>+As</var>)</dt>
<dd class="defbody">
One of <code>term</code> (classical json representation) or <code>dict</code> 
to use the new dict representation. If omitted and Term is a dict, <code>dict</code> 
is assumed. SWI-Prolog Version 7.
</dd>
</dl>

</dd>
<dt class="pubdef"><span class="pred-tag">[det]</span><a id="reply_json_dict/1"><strong>reply_json_dict</strong>(<var>+JSONTerm</var>)</a></dt>
<dt class="pubdef"><span class="pred-tag">[det]</span><a id="reply_json_dict/2"><strong>reply_json_dict</strong>(<var>+JSONTerm, 
+Options</var>)</a></dt>
<dd class="defbody">
As <a class="pred" href="#reply_json/1">reply_json/1</a> and <a class="pred" href="#reply_json/2">reply_json/2</a>, 
but assumes the new dict based data representation. Note that this is 
the default if the outer object is a dict. This predicate is needed to 
serialize a list of objects correctly and provides consistency with
<a class="pred" href="#http_read_json_dict/2">http_read_json_dict/2</a> 
and friends.
</dd>
</dl>

</ul>

<p><h2 id="sec:http-mime"><a id="sec:9"><span class="sec-nr">9</span> <span class="sec-title">MIME 
support</span></a></h2>

<a id="sec:http-mime"></a>

<p><h3 id="sec:mimepack"><a id="sec:9.1"><span class="sec-nr">9.1</span> <span class="sec-title">library(http/mimepack): 
Create a MIME message</span></a></h3>

<p><a id="sec:mimepack"></a>

<p>Simple and partial implementation of MIME encoding. MIME is covered 
by RFC 2045. This library is used by e.g., <a class="pred" href="#http_post_data/3">http_post_data/3</a> 
when using the
<code>form_data(+ListOfData)</code> input specification.

<p>MIME decoding is now arranged through <code>library(mime)</code> from 
the clib package, based on the external librfc2045 library. Most likely 
the functionality of this package will be moved to the same library 
someday. Packing however is a lot simpler then parsing.

<dl class="latex">
<dt class="pubdef"><span class="pred-tag">[det]</span><a id="mime_pack/3"><strong>mime_pack</strong>(<var>+Inputs, 
+Out:stream, ?Boundary</var>)</a></dt>
<dd class="defbody">
Pack a number of inputs into a MIME package using a specified or 
generated boundary. The generated boundary consists of the current time 
in milliseconds since the epoch and 10 random hexadecimal numbers. <var>Inputs</var> 
is a list of <i>documents</i> that is added to the mime message. Each 
element is one of:

<dl class="latex">
<dt><var><var>Name</var></var> <strong><code>=</code></strong> <var><var>Value</var></var></dt>
<dd class="defbody">
<var>Name</var> the document. This emits a header of the form below. The
<code>filename</code> is present if <var>Value</var> is of the form <code>file(File)</code>.
<var>Value</var> may be any of remaining value specifications.

<pre class="code">
Content-Disposition: form-data; name="Name"[; filename="&lt;File&gt;"
</pre>

</dd>
<dt><strong>html</strong>(<var>Tokens</var>)</dt>
<dd class="defbody">
<var>Tokens</var> is a list of HTML tokens as produced by <a class="pred" href="#html//1">html//1</a>. 
The token list is emitted using <a class="pred" href="#print_html/1">print_html/1</a>.
</dd>
<dt><strong>file</strong>(<var>File</var>)</dt>
<dd class="defbody">
Emit the contents of <var>File</var>. The <code>Content-type</code> is 
derived from the <var>File</var> using <span class="pred-ext">file_mime_type/2</span>. 
If the content-type is <code>text/_</code>, the file data is copied in 
text mode, which implies that it is read in the default encoding of the 
system and written using the encoding of the <var>Out</var> stream. 
Otherwise the file data is copied binary.
</dd>
<dt><strong>stream</strong>(<var>In, Len</var>)</dt>
<dd class="defbody">
Content is the next <var>Len</var> units from <var>In</var>. Data is 
copied using
<span class="pred-ext">copy_stream_data/3</span>. Units is bytes for 
binary streams and characters codes for text streams.
</dd>
<dt><strong>stream</strong>(<var>In</var>)</dt>
<dd class="defbody">
Content of the stream <var>In</var>, copied using <span class="pred-ext">copy_stream_data/2</span>. 
This is often used with memory files (see <span class="pred-ext">new_memory_file/1</span>).
</dd>
<dt><strong>mime</strong>(<var>Attributes, Value,[]</var>)</dt>
<dd class="defbody">
Create a MIME header from <var>Attributes</var> and add <var>Value</var>, 
which can be any of remaining values of this list. <var>Attributes</var> 
may contain <code>type(ContentType)</code> and/or <code>character_set(CharSet)</code>. 
This can be used to give a content-type to values that otherwise do not 
have a content-type. For example:

<pre class="code">
mime([type(text/html)], '&lt;b&gt;Hello World&lt;/b&gt;', [])
</pre>

</dd>
<dt><strong>mime</strong>(<var>[], , Parts</var>)</dt>
<dd class="defbody">
Creates a nested multipart MIME message. <var>Parts</var> is passed as <var>Inputs</var> 
to a recursive call to <span class="pred-ext">mime_pack/2</span>.
</dd>
<dt><strong><var>Atomic</var></strong></dt>
<dd class="defbody">
<var>Atomic</var> values are passed to <span class="pred-ext">write/1</span>. 
This embeds simple atoms and numbers.
</dd>
</dl>

<table class="arglist">
<tr><td><var>Out</var> </td><td>is a stream opened for writing. 
Typically, it should be opened in text mode using UTF-8 encoding. </td></tr>
</table>

<dl class="tags">
<dt class="tag">bug</dt>
<dd>
Does not validate that the boundary does not appear in any of the input 
documents.
</dd>
</dl>

</dd>
</dl>

<p><h2 id="sec:http-security"><a id="sec:10"><span class="sec-nr">10</span> <span class="sec-title">Security</span></a></h2>

<a id="sec:http-security"></a>

<p>Writing servers is an inherently dangerous job that should be carried 
out with some considerations. You have basically started a program on a 
public terminal and invited strangers to use it. When using the 
interactive server or inetd based server the server runs under your 
privileges. Using CGI scripted it runs with the privileges of your 
web-server. Though it should not be possible to fatally compromise a 
Unix machine using user privileges, getting unconstrained access to the 
system is highly undesirable.

<p>Symbolic languages have an additional handicap in their inherent 
possibilities to modify the running program and dynamically create goals 
(this also applies to the popular Perl and PHP scripting languages). 
Here are some guidelines.

<p>
<ul class="latex">
<li><i>Check your input</i><br>
Hardly anything can go wrong if you check the validity of 
query-arguments before formulating an answer.

<p>
<li><i>Check filenames</i><br>
If part of the query consists of filenames or directories, check them. 
This also applies to files you only read. Passing names as
<code>/etc/passwd</code>, but also <code>../../../../../etc/passwd</code> 
are tried by hackers to learn about the system they want to attack. So, 
expand provided names using <a id="idx:absolutefilename23:79"></a><span class="pred-ext">absolute_file_name/[2,3]</span> 
and verify they are inside a folder reserved for the server. Avoid 
symbolic links from this subtree to the outside world. The example below 
checks validity of filenames. The first call ensures proper canonisation 
of the paths to avoid an mismatch due to symbolic links or other 
filesystem ambiguities.

<pre class="code">
check_file(File) :-
        absolute_file_name('/path/to/reserved/area', Reserved),
        absolute_file_name(File, Tried),
        sub_atom(Tried, 0, _, _, Reserved).
</pre>

<p>
<li><i>Check scripts</i><br>
Should input in any way activate external scripts using <a id="idx:shell1:80"></a><span class="pred-ext">shell/1</span> 
or
<code>open(pipe(Command), ...)</code>, verify the argument once more. 
Use
<a id="idx:processcreate3:81"></a><span class="pred-ext">process_create/3</span> 
in preference over <a id="idx:shell1:82"></a><span class="pred-ext">shell/1</span> 
as this function avoids stringification of arguments (Unix) or ensures 
proper quoting of arguments (Windows).

<p>
<li><i>Check meta-calling</i><br>
<em>The</em> attractive situation for you and your attacker is below:

<pre class="code">
reply(Query) :-
        member(search(Args), Query),
        member(action=Action, Query),
        member(arg=Arg, Query),
        call(Action, Arg).              % NEVER EVER DO THIS!
</pre>

<p>All your attacker has to do is specify <var>Action</var> as <code>shell</code> 
and <var>Arg</var> as <code>/bin/sh</code> and he has an uncontrolled 
shell!
</ul>

<p><h2 id="sec:http-tips-and-tricks"><a id="sec:11"><span class="sec-nr">11</span> <span class="sec-title">Tips 
and tricks</span></a></h2>

<a id="sec:http-tips-and-tricks"></a>

<p>
<ul class="latex">
<li><i>URL Locations</i><br>
With an application in mind, it is tempting to make all URL locations 
short and directly connected to the root (<code><code>/</code></code>). 
This is
<em>not</em> a good idea. It is advised to have all locations in a 
server below a directory with an informative name. Consider to make the 
root location something that can be changed using a global setting.

<p>
<ul class="latex">
<li>Page generating code can easily be reused. Using locations directly 
below the root however increases the likelihood of conflicts.
<li>Multiple servers can be placed behind the same public server as 
explained in <a class="sec" href="#sec:3.14.6">section 3.14.6</a>. Using 
a common and fairly unique root, redirection is much easier and less 
likely to lead to conflicts.
</ul>

<p>
<li><i>Debugging</i><br>
Debugging multi-threaded applications is possible using the graphical 
debugger. This implies requires that the xpce extension package must be 
installed. Spy-points may be placed using <a id="idx:tspy1:83"></a><span class="pred-ext">tspy/1</span>.

<p>
<li><i>URL/URI manipulation</i><br>
Sometimes an <a id="idx:httphandler3:84"></a><a class="pred" href="#http_handler/3">http_handler/3</a> 
needs to inspect or normalize the URL. There are various utility 
predicates in <code>library(uri)</code>, such as <a id="idx:uricomponents2:85"></a><span class="pred-ext">uri_components/2</span>,
<a id="idx:uridata4:86"></a><span class="pred-ext">uri_data/4</span>, <a id="idx:uriedit3:87"></a><span class="pred-ext">uri_edit/3</span>, <a id="idx:urinomalized2:88"></a><span class="pred-ext">uri_nomalized/2</span>, 
etc.
</ul>

<p><h2 id="sec:http-status"><a id="sec:12"><span class="sec-nr">12</span> <span class="sec-title">Status</span></a></h2>

<a id="sec:http-status"></a>

<p>The SWI-Prolog HTTP library is in active use in a large number of 
projects. It is considered one of the SWI-Prolog core libraries that is 
actively maintained and regularly extended with new features. This is 
particularly true for the multi-threaded server. The inetd based server 
may be applicable for infrequent requests where the startup time is less 
relevant. The XPCE based server is considered obsolete.

<p>This library is by no means complete and you are free to extend it.

<h1><a id="document-index">Index</a></h1>

<dl>
<dt class="index-sep">?</dt>
<dt>absolute_file_name/[2,3]</dt>
<dd>
<a class="idx" href="#idx:absolutefilename23:79">10</a></dd>
<dt><a class="idx" href="#atom_json_dict/3">atom_json_dict/3</a></dt>
<dt><a class="idx" href="#atom_json_term/3">atom_json_term/3</a></dt>
<dt>chunked,encoding</dt>
<dd>
<a class="idx" href="#idx:chunkedencoding:75">5</a></dd>
<dt>cleanup/2</dt>
<dd>
<a class="idx" href="#idx:cleanup2:3">2</a></dd>
<dt><a class="idx" href="#cors_enable/0">cors_enable/0</a></dt>
<dt><a class="idx" href="#cors_enable/2">cors_enable/2</a></dt>
<dt><a class="idx" href="#current_hub/2">current_hub/2</a></dt>
<dt><a class="idx" href="#current_json_object/3">current_json_object/3</a></dt>
<dt>deflate,encoding</dt>
<dd>
<a class="idx" href="#idx:deflateencoding:76">5</a></dd>
<dt><a class="idx" href="#directory_index//2">directory_index//2</a></dt>
<dt>format/2</dt>
<dd>
<a class="idx" href="#idx:format2:48">3.21</a> <a class="idx" href="#idx:format2:68">3.21.6</a> <a class="idx" href="#idx:format2:69">3.21.6</a></dd>
<dt>format/3</dt>
<dd>
<a class="idx" href="#idx:format3:51">3.21</a> <a class="idx" href="#idx:format3:52">3.21</a> <a class="idx" href="#idx:format3:53">3.21</a></dd>
<dt>format_time/3</dt>
<dd>
<a class="idx" href="#idx:formattime3:34">3.14.2</a></dd>
<dt>goal_expansion/2</dt>
<dd>
<a class="idx" href="#idx:goalexpansion2:70">3.21.6</a></dd>
<dt><a class="idx" href="#health/2">health/2</a></dt>
<dt><a class="idx" href="#hide/1">hide/1</a></dt>
<dt><a class="idx" href="#hook/1">hook/1</a></dt>
<dt><a class="idx" href="#hooked/0">hooked/0</a></dt>
<dt>host_address/3</dt>
<dd>
<a class="idx" href="#idx:hostaddress3:73">4</a></dd>
<dt><a class="idx" href="#html//1">html//1</a></dt>
<dt><a class="idx" href="#html_begin//1">html_begin//1</a></dt>
<dt>html_begin/1</dt>
<dd>
<a class="idx" href="#idx:htmlbegin1:60">3.21</a></dd>
<dt><a class="idx" href="#html_current_resource/1">html_current_resource/1</a></dt>
<dt><a class="idx" href="#html_end//1">html_end//1</a></dt>
<dt><a class="idx" href="#html_insert_resource//1">html_insert_resource//1</a></dt>
<dt><a class="idx" href="#html_post//2">html_post//2</a></dt>
<dt>html_print/[1,2]</dt>
<dd>
<a class="idx" href="#idx:htmlprint12:64">3.21.1</a></dd>
<dt><a class="idx" href="#html_print_length/2">html_print_length/2</a></dt>
<dt><a class="idx" href="#html_quoted//1">html_quoted//1</a></dt>
<dt><a class="idx" href="#html_quoted_attribute//1">html_quoted_attribute//1</a></dt>
<dt><a class="idx" href="#html_receive//1">html_receive//1</a></dt>
<dt><a class="idx" href="#html_receive//2">html_receive//2</a></dt>
<dt><a class="idx" href="#html_requires//1">html_requires//1</a></dt>
<dt><a class="idx" href="#html_resource/2">html_resource/2</a></dt>
<dt><a class="idx" href="#html_write:expand//1">html_write:expand//1</a></dt>
<dt><a class="idx" href="#html_write:layout/3">html_write:layout/3</a></dt>
<dd>
<a class="idx" href="#idx:htmlwritelayout3:65">3.21.4</a></dd>
<dt><a class="idx" href="#htmx_oob//2">htmx_oob//2</a></dt>
<dt><a class="idx" href="#http:///1">http:///1</a></dt>
<dt><a class="idx" href="#http:authenticate/3">http:authenticate/3</a></dt>
<dt><a class="idx" href="#http:authenticate_client/2">http:authenticate_client/2</a></dt>
<dt>http:convert_parameter/3</dt>
<dd>
<a class="idx" href="#idx:httpconvertparameter3:22">3.12</a></dd>
<dt><a class="idx" href="#http:disable_encoding_filter/1">http:disable_encoding_filter/1</a></dt>
<dt><a class="idx" href="#http:location/3">http:location/3</a></dt>
<dt><a class="idx" href="#http:mime_type_encoding/2">http:mime_type_encoding/2</a></dt>
<dd>
<a class="idx" href="#idx:httpmimetypeencoding2:11">3.1</a></dd>
<dt><a class="idx" href="#http:mime_type_icon/2">http:mime_type_icon/2</a></dt>
<dt><a class="idx" href="#http:open_options/2">http:open_options/2</a></dt>
<dt><a class="idx" href="#http:post_data_hook/3">http:post_data_hook/3</a></dt>
<dt><a class="idx" href="#http:request_expansion/2">http:request_expansion/2</a></dt>
<dd>
<a class="idx" href="#idx:httprequestexpansion2:46">3.15</a></dd>
<dt><a class="idx" href="#http:schedule_workers/1">http:schedule_workers/1</a></dt>
<dt><a class="idx" href="#http:serialize_reply/2">http:serialize_reply/2</a></dt>
<dt><a class="idx" href="#http:status_page/3">http:status_page/3</a></dt>
<dt><a class="idx" href="#http:status_page_hook/3">http:status_page_hook/3</a></dt>
<dd>
<a class="idx" href="#idx:httpstatuspagehook3:20">3.10</a></dd>
<dt><a class="idx" href="#http:update_cookies/3">http:update_cookies/3</a></dt>
<dt><a class="idx" href="#http:write_cookies/3">http:write_cookies/3</a></dt>
<dt><a class="idx" href="#http_404/2">http_404/2</a></dt>
<dt><a class="idx" href="#http_absolute_location/3">http_absolute_location/3</a></dt>
<dt><a class="idx" href="#http_absolute_uri/2">http_absolute_uri/2</a></dt>
<dt><a class="idx" href="#http_add_worker/2">http_add_worker/2</a></dt>
<dt><a class="idx" href="#http_authenticate/3">http_authenticate/3</a></dt>
<dt><a class="idx" href="#http_authorization_data/2">http_authorization_data/2</a></dt>
<dt><a class="idx" href="#http_chunked_open/3">http_chunked_open/3</a></dt>
<dt><a class="idx" href="#http_clean_location_cache/0">http_clean_location_cache/0</a></dt>
<dt><a class="idx" href="#http_client:http_convert_data/4">http_client:http_convert_data/4</a></dt>
<dt><a class="idx" href="#http_close_keep_alive/1">http_close_keep_alive/1</a></dt>
<dt><a class="idx" href="#http_close_session/1">http_close_session/1</a></dt>
<dt><a class="idx" href="#http_convert_data/4">http_convert_data/4</a></dt>
<dt><a class="idx" href="#http_current_handler/2">http_current_handler/2</a></dt>
<dt><a class="idx" href="#http_current_handler/3">http_current_handler/3</a></dt>
<dt><a class="idx" href="#http_current_host/4">http_current_host/4</a></dt>
<dt><a class="idx" href="#http_current_request/1">http_current_request/1</a></dt>
<dd>
<a class="idx" href="#idx:httpcurrentrequest1:47">3.15</a></dd>
<dt><a class="idx" href="#http_current_session/2">http_current_session/2</a></dt>
<dt><a class="idx" href="#http_current_user/3">http_current_user/3</a></dt>
<dt><a class="idx" href="#http_current_worker/2">http_current_worker/2</a></dt>
<dt><a class="idx" href="#http_delete/3">http_delete/3</a></dt>
<dt><a class="idx" href="#http_delete_handler/1">http_delete_handler/1</a></dt>
<dt><a class="idx" href="#http_digest_challenge//2">http_digest_challenge//2</a></dt>
<dt><a class="idx" href="#http_digest_password_hash/4">http_digest_password_hash/4</a></dt>
<dt><a class="idx" href="#http_digest_response/5">http_digest_response/5</a></dt>
<dt><a class="idx" href="#http_disconnect/1">http_disconnect/1</a></dt>
<dt><a class="idx" href="#http_dispatch/1">http_dispatch/1</a></dt>
<dd>
<a class="idx" href="#idx:httpdispatch1:33">3.14.2</a></dd>
<dt><a class="idx" href="#http_get/3">http_get/3</a></dt>
<dd>
<a class="idx" href="#idx:httpget3:6">2</a></dd>
<dt><a class="idx" href="#http_handler/3">http_handler/3</a></dt>
<dd>
<a class="idx" href="#idx:httphandler3:1">1</a> <a class="idx" href="#idx:httphandler3:9">3.1</a> <a class="idx" href="#idx:httphandler3:39">3.14.2</a> <a class="idx" href="#idx:httphandler3:57">3.21</a> <a class="idx" href="#idx:httphandler3:84">11</a></dd>
<dt><a class="idx" href="#http_in_session/1">http_in_session/1</a></dt>
<dt><a class="idx" href="#http_join_headers/3">http_join_headers/3</a></dt>
<dt><a class="idx" href="#http_link_to_id/3">http_link_to_id/3</a></dt>
<dt><a class="idx" href="#http_location_by_id/2">http_location_by_id/2</a></dt>
<dd>
<a class="idx" href="#idx:httplocationbyid2:55">3.21</a></dd>
<dt><a class="idx" href="#http_log/2">http_log/2</a></dt>
<dt><a class="idx" href="#http_log_close/1">http_log_close/1</a></dt>
<dt><a class="idx" href="#http_log_stream/1">http_log_stream/1</a></dt>
<dt><a class="idx" href="#http_logrotate/1">http_logrotate/1</a></dt>
<dt><a class="idx" href="#http_open/3">http_open/3</a></dt>
<dd>
<a class="idx" href="#idx:httpopen3:2">2</a> <a class="idx" href="#idx:httpopen3:5">2</a> <a class="idx" href="#idx:httpopen3:71">4</a> <a class="idx" href="#idx:httpopen3:77">5</a> <a class="idx" href="#idx:httpopen3:78">5</a></dd>
<dt><a class="idx" href="#http_open_session/2">http_open_session/2</a></dt>
<dt><a class="idx" href="#http_open_websocket/3">http_open_websocket/3</a></dt>
<dt><a class="idx" href="#http_parameters/2">http_parameters/2</a></dt>
<dd>
<a class="idx" href="#idx:httpparameters2:23">3.12</a></dd>
<dt><a class="idx" href="#http_parameters/3">http_parameters/3</a></dt>
<dd>
<a class="idx" href="#idx:httpparameters3:24">3.12</a></dd>
<dt><a class="idx" href="#http_parse_digest_challenge/2">http_parse_digest_challenge/2</a></dt>
<dt><a class="idx" href="#http_parse_header/2">http_parse_header/2</a></dt>
<dt><a class="idx" href="#http_parse_header_value/3">http_parse_header_value/3</a></dt>
<dt><a class="idx" href="#http_patch/4">http_patch/4</a></dt>
<dt><a class="idx" href="#http_post/4">http_post/4</a></dt>
<dd>
<a class="idx" href="#idx:httppost4:7">2</a></dd>
<dt><a class="idx" href="#http_post_data/3">http_post_data/3</a></dt>
<dt><a class="idx" href="#http_public_host/4">http_public_host/4</a></dt>
<dt><a class="idx" href="#http_public_host_url/2">http_public_host_url/2</a></dt>
<dt><a class="idx" href="#http_public_url/2">http_public_url/2</a></dt>
<dt><a class="idx" href="#http_put/4">http_put/4</a></dt>
<dt><a class="idx" href="#http_read_data/3">http_read_data/3</a></dt>
<dd>
<a class="idx" href="#idx:httpreaddata3:27">3.13.1</a></dd>
<dt><a class="idx" href="#http_read_header/2">http_read_header/2</a></dt>
<dt><a class="idx" href="#http_read_json/2">http_read_json/2</a></dt>
<dt><a class="idx" href="#http_read_json/3">http_read_json/3</a></dt>
<dt><a class="idx" href="#http_read_json_dict/2">http_read_json_dict/2</a></dt>
<dt><a class="idx" href="#http_read_json_dict/3">http_read_json_dict/3</a></dt>
<dt><a class="idx" href="#http_read_passwd_file/2">http_read_passwd_file/2</a></dt>
<dt><a class="idx" href="#http_read_reply_header/2">http_read_reply_header/2</a></dt>
<dt><a class="idx" href="#http_read_request/2">http_read_request/2</a></dt>
<dd>
<a class="idx" href="#idx:httpreadrequest2:25">3.13</a> <a class="idx" href="#idx:httpreadrequest2:26">3.13</a></dd>
<dt><a class="idx" href="#http_redirect/3">http_redirect/3</a></dt>
<dd>
<a class="idx" href="#idx:httpredirect3:10">3.1</a></dd>
<dt><a class="idx" href="#http_relative_path/2">http_relative_path/2</a></dt>
<dt><a class="idx" href="#http_reload_with_parameters/3">http_reload_with_parameters/3</a></dt>
<dt><a class="idx" href="#http_reply/2">http_reply/2</a></dt>
<dt><a class="idx" href="#http_reply/3">http_reply/3</a></dt>
<dd>
<a class="idx" href="#idx:httpreply3:15">3.1.1</a> <a class="idx" href="#idx:httpreply3:16">3.1.1</a> <a class="idx" href="#idx:httpreply3:17">3.1.1</a></dd>
<dt><a class="idx" href="#http_reply/4">http_reply/4</a></dt>
<dt><a class="idx" href="#http_reply/5">http_reply/5</a></dt>
<dt><a class="idx" href="#http_reply/6">http_reply/6</a></dt>
<dt><a class="idx" href="#http_reply_dirindex/3">http_reply_dirindex/3</a></dt>
<dt><a class="idx" href="#http_reply_file/3">http_reply_file/3</a></dt>
<dt><a class="idx" href="#http_reply_from_files/3">http_reply_from_files/3</a></dt>
<dt><a class="idx" href="#http_reply_header/3">http_reply_header/3</a></dt>
<dt><a class="idx" href="#http_request_expansion/2">http_request_expansion/2</a></dt>
<dt><a class="idx" href="#http_safe_file/2">http_safe_file/2</a></dt>
<dt><a class="idx" href="#http_schedule_logrotate/2">http_schedule_logrotate/2</a></dt>
<dt><a class="idx" href="#http_server/1">http_server/1</a></dt>
<dd>
<a class="idx" href="#idx:httpserver1:40">3.14.3</a></dd>
<dt><a class="idx" href="#http_server/2">http_server/2</a></dt>
<dd>
<a class="idx" href="#idx:httpserver2:74">4</a></dd>
<dt><a class="idx" href="#http_server_property/2">http_server_property/2</a></dt>
<dt><a class="idx" href="#http_session_assert/1">http_session_assert/1</a></dt>
<dt><a class="idx" href="#http_session_assert/2">http_session_assert/2</a></dt>
<dt><a class="idx" href="#http_session_asserta/1">http_session_asserta/1</a></dt>
<dt><a class="idx" href="#http_session_asserta/2">http_session_asserta/2</a></dt>
<dt><a class="idx" href="#http_session_cookie/1">http_session_cookie/1</a></dt>
<dt><a class="idx" href="#http_session_data/1">http_session_data/1</a></dt>
<dt><a class="idx" href="#http_session_data/2">http_session_data/2</a></dt>
<dt><a class="idx" href="#http_session_id/1">http_session_id/1</a></dt>
<dt><a class="idx" href="#http_session_option/1">http_session_option/1</a></dt>
<dt><a class="idx" href="#http_session_retract/1">http_session_retract/1</a></dt>
<dt><a class="idx" href="#http_session_retract/2">http_session_retract/2</a></dt>
<dt><a class="idx" href="#http_session_retractall/1">http_session_retractall/1</a></dt>
<dt><a class="idx" href="#http_session_retractall/2">http_session_retractall/2</a></dt>
<dt><a class="idx" href="#http_set_authorization/2">http_set_authorization/2</a></dt>
<dt><a class="idx" href="#http_set_session/1">http_set_session/1</a></dt>
<dt><a class="idx" href="#http_set_session/2">http_set_session/2</a></dt>
<dt><a class="idx" href="#http_set_session_options/1">http_set_session_options/1</a></dt>
<dt><a class="idx" href="#http_spawn/2">http_spawn/2</a></dt>
<dd>
<a class="idx" href="#idx:httpspawn2:8">3</a> <a class="idx" href="#idx:httpspawn2:35">3.14.2</a></dd>
<dt><a class="idx" href="#http_status_reply/4">http_status_reply/4</a></dt>
<dt><a class="idx" href="#http_status_reply/5">http_status_reply/5</a></dt>
<dt><a class="idx" href="#http_status_reply/6">http_status_reply/6</a></dt>
<dt><a class="idx" href="#http_stop_server/2">http_stop_server/2</a></dt>
<dt><a class="idx" href="#http_switch_protocol/2">http_switch_protocol/2</a></dt>
<dt><a class="idx" href="#http_timestamp/2">http_timestamp/2</a></dt>
<dt><a class="idx" href="#http_update_connection/4">http_update_connection/4</a></dt>
<dt><a class="idx" href="#http_update_encoding/3">http_update_encoding/3</a></dt>
<dt><a class="idx" href="#http_update_transfer/4">http_update_transfer/4</a></dt>
<dt><a class="idx" href="#http_upgrade_to_websocket/3">http_upgrade_to_websocket/3</a></dt>
<dt><a class="idx" href="#http_workers/2">http_workers/2</a></dt>
<dd>
<a class="idx" href="#idx:httpworkers2:31">3.14.2</a></dd>
<dt><a class="idx" href="#http_wrapper/5">http_wrapper/5</a></dt>
<dd>
<a class="idx" href="#idx:httpwrapper5:21">3.12</a> <a class="idx" href="#idx:httpwrapper5:41">3.14.3</a> <a class="idx" href="#idx:httpwrapper5:42">3.15</a> <a class="idx" href="#idx:httpwrapper5:43">3.15</a> <a class="idx" href="#idx:httpwrapper5:45">3.15</a></dd>
<dt><a class="idx" href="#http_write_passwd_file/2">http_write_passwd_file/2</a></dt>
<dt><a class="idx" href="#hub_add/3">hub_add/3</a></dt>
<dt><a class="idx" href="#hub_broadcast/2">hub_broadcast/2</a></dt>
<dt><a class="idx" href="#hub_broadcast/3">hub_broadcast/3</a></dt>
<dt><a class="idx" href="#hub_create/3">hub_create/3</a></dt>
<dt><a class="idx" href="#hub_member/2">hub_member/2</a></dt>
<dt><a class="idx" href="#hub_send/2">hub_send/2</a></dt>
<dt><a class="idx" href="#iostream:open_hook/6">iostream:open_hook/6</a></dt>
<dt><a class="idx" href="#is_json_content_type/1">is_json_content_type/1</a></dt>
<dt><a class="idx" href="#is_json_term/1">is_json_term/1</a></dt>
<dt><a class="idx" href="#is_json_term/2">is_json_term/2</a></dt>
<dt><a class="idx" href="#javascript/4">javascript/4</a></dt>
<dt><a class="idx" href="#js_arg//1">js_arg//1</a></dt>
<dt><a class="idx" href="#js_arg_list//1">js_arg_list//1</a></dt>
<dt><a class="idx" href="#js_call//1">js_call//1</a></dt>
<dt><a class="idx" href="#js_expression//1">js_expression//1</a></dt>
<dt><a class="idx" href="#js_new//2">js_new//2</a></dt>
<dt><a class="idx" href="#js_script//1">js_script//1</a></dt>
<dt><a class="idx" href="#json_dict_pairs/2">json_dict_pairs/2</a></dt>
<dt><a class="idx" href="#json_object/1">json_object/1</a></dt>
<dt><a class="idx" href="#json_read/2">json_read/2</a></dt>
<dt><a class="idx" href="#json_read/3">json_read/3</a></dt>
<dt><a class="idx" href="#json_read_dict/2">json_read_dict/2</a></dt>
<dt><a class="idx" href="#json_read_dict/3">json_read_dict/3</a></dt>
<dt><a class="idx" href="#json_to_prolog/2">json_to_prolog/2</a></dt>
<dt><a class="idx" href="#json_type/1">json_type/1</a></dt>
<dt><a class="idx" href="#json_write/2">json_write/2</a></dt>
<dt><a class="idx" href="#json_write/3">json_write/3</a></dt>
<dt><a class="idx" href="#json_write_dict/2">json_write_dict/2</a></dt>
<dt><a class="idx" href="#json_write_dict/3">json_write_dict/3</a></dt>
<dt><a class="idx" href="#json_write_hook/4">json_write_hook/4</a></dt>
<dt><a class="idx" href="#keep_alive/4">keep_alive/4</a></dt>
<dt><a class="idx" href="#map_method/2">map_method/2</a></dt>
<dt><a class="idx" href="#mime_include//2">mime_include//2</a></dt>
<dt><a class="idx" href="#mime_pack/3">mime_pack/3</a></dt>
<dt>mime_type_encoding/2</dt>
<dd>
<a class="idx" href="#idx:mimetypeencoding2:13">3.1</a></dd>
<dt><a class="idx" href="#nolog/1">nolog/1</a></dt>
<dt><a class="idx" href="#nolog_post_content_type/1">nolog_post_content_type/1</a></dt>
<dt><a class="idx" href="#openid_associate/3">openid_associate/3</a></dt>
<dt><a class="idx" href="#openid_associate/4">openid_associate/4</a></dt>
<dt><a class="idx" href="#openid_authenticate/4">openid_authenticate/4</a></dt>
<dt><a class="idx" href="#openid_current_host/3">openid_current_host/3</a></dt>
<dt><a class="idx" href="#openid_current_url/2">openid_current_url/2</a></dt>
<dt><a class="idx" href="#openid_grant/1">openid_grant/1</a></dt>
<dt><a class="idx" href="#openid_hook/1">openid_hook/1</a></dt>
<dt><a class="idx" href="#openid_logged_in/1">openid_logged_in/1</a></dt>
<dt><a class="idx" href="#openid_login/1">openid_login/1</a></dt>
<dt><a class="idx" href="#openid_login_form//2">openid_login_form//2</a></dt>
<dt><a class="idx" href="#openid_logout/1">openid_logout/1</a></dt>
<dt><a class="idx" href="#openid_server/2">openid_server/2</a></dt>
<dt><a class="idx" href="#openid_server/3">openid_server/3</a></dt>
<dt><a class="idx" href="#openid_user/3">openid_user/3</a></dt>
<dt><a class="idx" href="#openid_verify/2">openid_verify/2</a></dt>
<dt><a class="idx" href="#page//1">page//1</a></dt>
<dt><a class="idx" href="#page//2">page//2</a></dt>
<dt>page/[1,2]</dt>
<dd>
<a class="idx" href="#idx:page12:59">3.21</a></dd>
<dt><a class="idx" href="#password_field/1">password_field/1</a></dt>
<dt><a class="idx" href="#post_data_encoded/2">post_data_encoded/2</a></dt>
<dt>pp/1</dt>
<dd>
<a class="idx" href="#idx:pp1:28">3.13.1</a></dd>
<dt>predicate/5</dt>
<dd>
<a class="idx" href="#idx:predicate5:67">3.21.5</a></dd>
<dt><a class="idx" href="#print_html/1">print_html/1</a></dt>
<dt><a class="idx" href="#print_html/2">print_html/2</a></dt>
<dt>print_html/[1,2]</dt>
<dd>
<a class="idx" href="#idx:printhtml12:49">3.21</a> <a class="idx" href="#idx:printhtml12:50">3.21</a> <a class="idx" href="#idx:printhtml12:66">3.21.4</a></dd>
<dt>process_create/3</dt>
<dd>
<a class="idx" href="#idx:processcreate3:81">10</a></dd>
<dt><a class="idx" href="#prolog_bool_to_json/2">prolog_bool_to_json/2</a></dt>
<dt><a class="idx" href="#prolog_to_json/2">prolog_to_json/2</a></dt>
<dt><a class="idx" href="#pwp_handler/2">pwp_handler/2</a></dt>
<dt><a class="idx" href="#reply_html_page/2">reply_html_page/2</a></dt>
<dt><a class="idx" href="#reply_html_page/3">reply_html_page/3</a></dt>
<dd>
<a class="idx" href="#idx:replyhtmlpage3:61">3.21.1</a> <a class="idx" href="#idx:replyhtmlpage3:62">3.21.1</a> <a class="idx" href="#idx:replyhtmlpage3:63">3.21.1</a></dd>
<dt><a class="idx" href="#reply_html_partial/1">reply_html_partial/1</a></dt>
<dt><a class="idx" href="#reply_htmx/1">reply_htmx/1</a></dt>
<dt><a class="idx" href="#reply_htmx/2">reply_htmx/2</a></dt>
<dt><a class="idx" href="#reply_json/1">reply_json/1</a></dt>
<dt><a class="idx" href="#reply_json/2">reply_json/2</a></dt>
<dt><a class="idx" href="#reply_json_dict/1">reply_json_dict/1</a></dt>
<dt><a class="idx" href="#reply_json_dict/2">reply_json_dict/2</a></dt>
<dt><a class="idx" href="#reply_pwp_page/3">reply_pwp_page/3</a></dt>
<dt><a class="idx" href="#server_health/1">server_health/1</a></dt>
<dt><a class="idx" href="#session_setting/2">session_setting/2</a></dt>
<dt>set_lang/1</dt>
<dd>
<a class="idx" href="#idx:setlang1:56">3.21</a> <a class="idx" href="#idx:setlang1:58">3.21</a></dd>
<dt>set_stream/2</dt>
<dd>
<a class="idx" href="#idx:setstream2:12">3.1</a></dd>
<dt>setup_call_cleanup/3</dt>
<dd>
<a class="idx" href="#idx:setupcallcleanup3:4">2</a></dd>
<dt>shell/1</dt>
<dd>
<a class="idx" href="#idx:shell1:80">10</a> <a class="idx" href="#idx:shell1:82">10</a></dd>
<dt>sleep/1</dt>
<dd>
<a class="idx" href="#idx:sleep1:18">3.9.1</a></dd>
<dt>ssl_context/3</dt>
<dd>
<a class="idx" href="#idx:sslcontext3:32">3.14.2</a></dd>
<dt><a class="idx" href="#ssl_verify/5">ssl_verify/5</a></dt>
<dt>tcp_accept/3</dt>
<dd>
<a class="idx" href="#idx:tcpaccept3:44">3.15</a></dd>
<dt>tcp_bind/2</dt>
<dd>
<a class="idx" href="#idx:tcpbind2:30">3.14.2</a></dd>
<dt>tcp_connect/3</dt>
<dd>
<a class="idx" href="#idx:tcpconnect3:72">4</a></dd>
<dt>thread_create/3</dt>
<dd>
<a class="idx" href="#idx:threadcreate3:38">3.14.2</a></dd>
<dt>thread_create_in_pool/4</dt>
<dd>
<a class="idx" href="#idx:threadcreateinpool4:37">3.14.2</a></dd>
<dt>thread_pool_create/3</dt>
<dd>
<a class="idx" href="#idx:threadpoolcreate3:36">3.14.2</a></dd>
<dt>thread_wait/2</dt>
<dd>
<a class="idx" href="#idx:threadwait2:19">3.9.1</a></dd>
<dt>throw/1</dt>
<dd>
<a class="idx" href="#idx:throw1:14">3.1.1</a></dd>
<dt>tspy/1</dt>
<dd>
<a class="idx" href="#idx:tspy1:29">3.14</a> <a class="idx" href="#idx:tspy1:83">11</a></dd>
<dt>uri_components/2</dt>
<dd>
<a class="idx" href="#idx:uricomponents2:85">11</a></dd>
<dt>uri_data/4</dt>
<dd>
<a class="idx" href="#idx:uridata4:86">11</a></dd>
<dt>uri_edit/3</dt>
<dd>
<a class="idx" href="#idx:uriedit3:87">11</a></dd>
<dt>uri_encoded/3</dt>
<dd>
<a class="idx" href="#idx:uriencoded3:54">3.21</a></dd>
<dt>uri_nomalized/2</dt>
<dd>
<a class="idx" href="#idx:urinomalized2:88">11</a></dd>
<dt><a class="idx" href="#ws_close/3">ws_close/3</a></dt>
<dt><a class="idx" href="#ws_mask/1">ws_mask/1</a></dt>
<dt><a class="idx" href="#ws_open/3">ws_open/3</a></dt>
<dt><a class="idx" href="#ws_property/2">ws_property/2</a></dt>
<dt><a class="idx" href="#ws_receive/2">ws_receive/2</a></dt>
<dt><a class="idx" href="#ws_receive/3">ws_receive/3</a></dt>
<dt><a class="idx" href="#ws_send/2">ws_send/2</a></dt>
<dt><a class="idx" href="#xhtml_ns//2">xhtml_ns//2</a></dt>
<dd>
</dd>
</dl>

</body></html>